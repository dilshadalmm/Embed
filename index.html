<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConceptBlitz - Admin Panel</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        /* Custom styles for admin panel */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .sidebar {
            transition: all 0.3s;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .sidebar.active {
                transform: translateX(0);
            }
        }
        
        .table-container {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
        
        .form-input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .option-item {
            transition: all 0.2s;
        }
        
        .option-item:hover {
            transform: translateY(-2px);
        }
        
        .success-message {
            animation: slideDown 0.3s ease;
        }
        
        .error-message {
            animation: shake 0.5s ease;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* Dark mode scrollbar */
        .dark ::-webkit-scrollbar-track {
            background: #334155;
        }
        
        .dark ::-webkit-scrollbar-thumb {
            background: #475569;
        }
        
        .dark ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        
        /* Animation for modal */
        .modal-enter {
            animation: modalEnter 0.3s ease;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        /* Badge styles */
        .badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .badge-warning {
            background-color: #fef3c7;
            color: #92400e;
        }
        
        .badge-danger {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .badge-info {
            background-color: #dbeafe;
            color: #1e40af;
        }
        
        /* Modal alert */
        #modal-alert {
            animation: slideDown 0.3s ease;
        }
        
        /* Success button animation */
        .btn-success {
            background: linear-gradient(to right, #10b981, #059669) !important;
            animation: pulseSuccess 2s ease;
        }
        
        @keyframes pulseSuccess {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900">
    
    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-800 dark:to-gray-900 p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="inline-block p-4 bg-blue-100 dark:bg-blue-900 rounded-2xl mb-4">
                    <i class="fas fa-shield-alt text-4xl text-blue-600 dark:text-blue-400"></i>
                </div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">ConceptBlitz Admin</h1>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Secure access to question management</p>
            </div>
            
            <form id="login-form" class="space-y-6">
                <div>
                    <label for="email" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-envelope mr-2"></i>Email Address
                    </label>
                    <input 
                        type="email" 
                        id="email" 
                        required
                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition duration-200"
                        placeholder="admin@conceptblitz.com"
                    >
                </div>
                
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                        <i class="fas fa-lock mr-2"></i>Password
                    </label>
                    <input 
                        type="password" 
                        id="password" 
                        required
                        class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white transition duration-200"
                        placeholder="••••••••"
                    >
                </div>
                
                <div id="login-error" class="hidden p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                        <p id="error-message" class="text-red-700 dark:text-red-300 text-sm"></p>
                    </div>
                </div>
                
                <button 
                    type="submit" 
                    id="login-button"
                    class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 flex items-center justify-center shadow-lg"
                >
                    <span id="login-button-text">Sign In</span>
                    <div id="login-button-spinner" class="loading-spinner ml-3 hidden"></div>
                </button>
                
                <div class="text-center pt-4 border-t border-gray-200 dark:border-gray-700">
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                        <i class="fas fa-info-circle mr-2"></i>
                        Only authorized administrators can access this panel
                    </p>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Admin Dashboard (Hidden until login) -->
    <div id="admin-dashboard" class="hidden min-h-screen">
        <!-- Sidebar -->
        <div class="sidebar fixed inset-y-0 left-0 z-50 w-64 bg-white dark:bg-gray-800 shadow-xl">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center mr-3">
                        <i class="fas fa-shield-alt text-white"></i>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-900 dark:text-white">ConceptBlitz</h2>
                        <p class="text-xs text-gray-500 dark:text-gray-400">Admin Panel</p>
                    </div>
                </div>
            </div>
            
            <!-- Navigation -->
            <nav class="p-4 space-y-2">
                <a href="#" id="nav-dashboard" class="nav-item active flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 bg-blue-50 dark:bg-gray-700 rounded-lg">
                    <i class="fas fa-tachometer-alt mr-3"></i>
                    Dashboard
                </a>
                <a href="#" id="nav-questions" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <i class="fas fa-question-circle mr-3"></i>
                    Manage Questions
                </a>
                <a href="#" id="nav-upload" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <i class="fas fa-cloud-upload-alt mr-3"></i>
                    Upload Questions
                </a>
                <a href="#" id="nav-stats" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <i class="fas fa-chart-bar mr-3"></i>
                    Statistics
                </a>
                <a href="#" id="nav-users" class="nav-item flex items-center px-4 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 rounded-lg transition duration-200">
                    <i class="fas fa-users mr-3"></i>
                    User Management
                </a>
            </nav>
            
            <!-- User Info -->
            <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-gray-200 dark:border-gray-700">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center text-white font-bold mr-3">
                        <span id="user-initial">A</span>
                    </div>
                    <div class="flex-1">
                        <p id="user-name" class="font-medium text-gray-900 dark:text-white text-sm">Admin User</p>
                        <p id="user-email" class="text-xs text-gray-500 dark:text-gray-400">admin@conceptblitz.com</p>
                    </div>
                    <button id="logout-button" class="p-2 text-gray-500 hover:text-red-500 dark:text-gray-400 dark:hover:text-red-400 transition duration-200">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="ml-0 md:ml-64 transition-all duration-300">
            <!-- Top Header -->
            <header class="sticky top-0 z-40 bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 px-6 py-4 shadow-sm">
                <div class="flex items-center justify-between">
                    <!-- Mobile Menu Button -->
                    <button id="mobile-menu-button" class="md:hidden p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                        <i class="fas fa-bars text-xl"></i>
                    </button>
                    
                    <!-- Page Title -->
                    <div>
                        <h1 id="page-title" class="text-2xl font-bold text-gray-900 dark:text-white">Dashboard</h1>
                        <p id="page-subtitle" class="text-sm text-gray-600 dark:text-gray-400">Welcome to the admin panel</p>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex items-center space-x-4">
                        <!-- Dark Mode Toggle -->
                        <button id="dark-mode-toggle" class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">
                            <i class="fas fa-moon"></i>
                        </button>
                        
                        <!-- Notifications -->
                        <button class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 relative">
                            <i class="fas fa-bell"></i>
                            <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
                        </button>
                        
                        <!-- Quick Upload -->
                        <button id="quick-upload-button" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium transition duration-200">
                            <i class="fas fa-plus mr-2"></i>New Question
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <main class="p-6">
                <!-- Success/Error Messages -->
                <div id="success-alert" class="hidden success-message mb-6 p-4 bg-green-50 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-500 mr-3"></i>
                            <p id="success-message" class="text-green-700 dark:text-green-300"></p>
                        </div>
                        <button class="text-green-500 hover:text-green-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="error-alert" class="hidden error-message mb-6 p-4 bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-800 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-exclamation-circle text-red-500 mr-3"></i>
                            <p id="error-alert-message" class="text-red-700 dark:text-red-300"></p>
                        </div>
                        <button class="text-red-500 hover:text-red-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Page Content -->
                <div id="page-content">
                    <!-- Dashboard content will be loaded here -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- Question Upload/Edit Modal -->
    <div id="upload-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <!-- Modal Header -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 id="modal-title" class="text-2xl font-bold text-gray-900 dark:text-white">Upload New Question</h3>
                        <p id="modal-subtitle" class="text-gray-600 dark:text-gray-400 mt-1">Add a new question to the database</p>
                    </div>
                    <button id="close-modal" class="p-2 text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            
            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 200px)">
                <!-- Modal Alert -->
                <div id="modal-alert" class="hidden mb-6 p-4 rounded-lg"></div>
                
                <form id="question-form" class="space-y-6">
                    <!-- Hidden field for edit mode -->
                    <input type="hidden" id="edit-question-id">
                    <input type="hidden" id="edit-course-id">
                    <input type="hidden" id="edit-subject-id">
                    <input type="hidden" id="edit-chapter-id">
                    
                    <!-- Course Selection -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-graduation-cap mr-2"></i>Course
                            </label>
                            <select id="course-select" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option value="">Select Course</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-book mr-2"></i>Subject
                            </label>
                            <select id="subject-select" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" disabled>
                                <option value="">Select Subject</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-layer-group mr-2"></i>Chapter
                            </label>
                            <select id="chapter-select" class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white" disabled>
                                <option value="">Select Chapter</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Question Details -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Question Details</h4>
                        
                        <!-- Order Number -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-sort-numeric-down mr-2"></i>Question Order
                            </label>
                            <div class="flex items-center">
                                <button type="button" id="decrement-order" class="p-3 border border-r-0 border-gray-300 dark:border-gray-600 rounded-l-lg bg-gray-50 dark:bg-gray-700">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input 
                                    type="number" 
                                    id="question-order" 
                                    min="1" 
                                    value="1"
                                    class="w-24 px-4 py-3 border border-gray-300 dark:border-gray-600 text-center text-gray-900 dark:text-white bg-white dark:bg-gray-700"
                                >
                                <button type="button" id="increment-order" class="p-3 border border-l-0 border-gray-300 dark:border-gray-600 rounded-r-lg bg-gray-50 dark:bg-gray-700">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <span class="ml-4 text-sm text-gray-500 dark:text-gray-400">Order in which question appears</span>
                            </div>
                        </div>
                        
                        <!-- Question Text -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-question mr-2"></i>Question Text *
                            </label>
                            <textarea 
                                id="question-text" 
                                rows="4"
                                required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                placeholder="Enter the question text..."
                            ></textarea>
                            <div class="mt-2 flex justify-between text-sm">
                                <span class="text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-info-circle mr-1"></i>Use $$...$$ for LaTeX math
                                </span>
                                <span id="question-char-count" class="text-gray-500 dark:text-gray-400">0 characters</span>
                            </div>
                        </div>
                        
                        <!-- Question Image -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-image mr-2"></i>Question Image URL (Optional)
                            </label>
                            <div class="flex items-center space-x-4">
                                <input 
                                    type="url" 
                                    id="question-image-url"
                                    class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                    placeholder="https://example.com/question-image.jpg"
                                >
                                <button type="button" id="preview-question-image" class="px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                                    <i class="fas fa-eye mr-2"></i>Preview
                                </button>
                            </div>
                            <div id="question-image-preview" class="hidden mt-4">
                                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Image Preview</span>
                                        <button type="button" id="remove-question-image" class="text-red-500 hover:text-red-600">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <img id="question-preview-img" src="" alt="Question image preview" class="max-h-48 rounded-lg mx-auto">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Options Section -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Answer Options *</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">Select the correct answer by clicking the radio button</p>
                        
                        <div class="space-y-4">
                            <div class="option-item p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800">
                                <div class="flex items-center mb-3">
                                    <input type="radio" name="correct-option" value="0" id="option-a" class="h-5 w-5 text-blue-600 focus:ring-blue-500" checked>
                                    <label for="option-a" class="ml-3 font-medium text-gray-900 dark:text-white">Option A</label>
                                </div>
                                <textarea 
                                    id="option-text-a" 
                                    rows="2"
                                    required
                                    class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                    placeholder="Enter option A text..."
                                ></textarea>
                            </div>
                            
                            <div class="option-item p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800">
                                <div class="flex items-center mb-3">
                                    <input type="radio" name="correct-option" value="1" id="option-b" class="h-5 w-5 text-blue-600 focus:ring-blue-500">
                                    <label for="option-b" class="ml-3 font-medium text-gray-900 dark:text-white">Option B</label>
                                </div>
                                <textarea 
                                    id="option-text-b" 
                                    rows="2"
                                    required
                                    class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                    placeholder="Enter option B text..."
                                ></textarea>
                            </div>
                            
                            <div class="option-item p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800">
                                <div class="flex items-center mb-3">
                                    <input type="radio" name="correct-option" value="2" id="option-c" class="h-5 w-5 text-blue-600 focus:ring-blue-500">
                                    <label for="option-c" class="ml-3 font-medium text-gray-900 dark:text-white">Option C</label>
                                </div>
                                <textarea 
                                    id="option-text-c" 
                                    rows="2"
                                    required
                                    class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                    placeholder="Enter option C text..."
                                ></textarea>
                            </div>
                            
                            <div class="option-item p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800">
                                <div class="flex items-center mb-3">
                                    <input type="radio" name="correct-option" value="3" id="option-d" class="h-5 w-5 text-blue-600 focus:ring-blue-500">
                                    <label for="option-d" class="ml-3 font-medium text-gray-900 dark:text-white">Option D</label>
                                </div>
                                <textarea 
                                    id="option-text-d" 
                                    rows="2"
                                    required
                                    class="w-full px-4 py-3 border border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-gray-50 dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                    placeholder="Enter option D text..."
                                ></textarea>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Explanation Section -->
                    <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6">
                        <h4 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Explanation *</h4>
                        
                        <!-- Explanation Text -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-lightbulb mr-2"></i>Explanation Text
                            </label>
                            <textarea 
                                id="explanation-text" 
                                rows="4"
                                required
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white resize-none"
                                placeholder="Enter detailed explanation..."
                            ></textarea>
                            <div class="mt-2 flex justify-between text-sm">
                                <span class="text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-info-circle mr-1"></i>Explain why the answer is correct
                                </span>
                                <span id="explanation-char-count" class="text-gray-500 dark:text-gray-400">0 characters</span>
                            </div>
                        </div>
                        
                        <!-- Explanation Image -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-image mr-2"></i>Explanation Image URL (Optional)
                            </label>
                            <div class="flex items-center space-x-4">
                                <input 
                                    type="url" 
                                    id="explanation-image-url"
                                    class="flex-1 px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                    placeholder="https://example.com/explanation-image.jpg"
                                >
                                <button type="button" id="preview-explanation-image" class="px-4 py-3 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600">
                                    <i class="fas fa-eye mr-2"></i>Preview
                                </button>
                            </div>
                            <div id="explanation-image-preview" class="hidden mt-4">
                                <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-sm font-medium text-gray-700 dark:text-gray-300">Image Preview</span>
                                        <button type="button" id="remove-explanation-image" class="text-red-500 hover:text-red-600">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <img id="explanation-preview-img" src="" alt="Explanation image preview" class="max-h-48 rounded-lg mx-auto">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Explanation Video -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-video mr-2"></i>Explanation Video URL (Optional)
                            </label>
                            <input 
                                type="url" 
                                id="explanation-video-url"
                                class="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="https://youtube.com/embed/... or direct video URL"
                            >
                            <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
                                <i class="fas fa-info-circle mr-1"></i>YouTube embed URL or direct video link
                            </p>
                        </div>
                    </div>
                </form>
            </div>
            
            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="text-sm text-gray-600 dark:text-gray-400">
                            <i class="fas fa-asterisk text-red-500 mr-1"></i>Required fields marked with *
                        </p>
                    </div>
                    <div class="flex space-x-3">
                        <button id="cancel-upload" type="button" class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-200">
                            Cancel
                        </button>
                        <button id="save-draft" type="button" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition duration-200">
                            Save as Draft
                        </button>
                        <button id="submit-question" type="button" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium transition duration-200 flex items-center">
                            <i class="fas fa-cloud-upload-alt mr-2"></i>
                            <span id="submit-button-text">Upload Question</span>
                            <div id="submit-button-spinner" class="loading-spinner ml-2 hidden"></div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBJ_G5o4otg7riemfJDMOcPoHoIVH7emsc",
            authDomain: "geobazarr.firebaseapp.com",
            databaseURL: "https://geobazarr-default-rtdb.firebaseio.com",
            projectId: "geobazarr",
            storageBucket: "geobazarr.firebasestorage.app",
            messagingSenderId: "679949247383",
            appId: "1:679949247383:web:036d4f32038422ebb89ad2"
        };

        // Initialize Firebase
        let db, auth;
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();
            console.log("Firebase initialized successfully");
        } catch (error) {
            console.error("Firebase initialization error:", error);
            showError("Firebase initialization failed. Please refresh the page.");
        }

        // Admin credentials
        const ADMIN_EMAIL = 'admin@conceptblitz.com';

        // Global state
        let currentUser = null;
        let currentPage = 'dashboard';
        let courses = [];
        let subjects = [];
        let chapters = [];
        let questions = [];
        let statistics = {
            totalQuestions: 0,
            totalCourses: 0,
            totalSubjects: 0,
            todayUploads: 0
        };

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const adminDashboard = document.getElementById('admin-dashboard');
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const loginButtonText = document.getElementById('login-button-text');
        const loginButtonSpinner = document.getElementById('login-button-spinner');
        const loginError = document.getElementById('login-error');
        const errorMessage = document.getElementById('error-message');
        const logoutButton = document.getElementById('logout-button');
        const userInitial = document.getElementById('user-initial');
        const userName = document.getElementById('user-name');
        const userEmail = document.getElementById('user-email');
        const pageContent = document.getElementById('page-content');
        const pageTitle = document.getElementById('page-title');
        const pageSubtitle = document.getElementById('page-subtitle');
        const successAlert = document.getElementById('success-alert');
        const successMessage = document.getElementById('success-message');
        const errorAlert = document.getElementById('error-alert');
        const errorAlertMessage = document.getElementById('error-alert-message');
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const quickUploadButton = document.getElementById('quick-upload-button');
        const uploadModal = document.getElementById('upload-modal');
        const closeModal = document.getElementById('close-modal');
        const cancelUpload = document.getElementById('cancel-upload');

        // Navigation elements
        const navItems = document.querySelectorAll('.nav-item');

        // Check if user is admin
        function isAdminUser(user) {
            return user && user.email === ADMIN_EMAIL;
        }

        // Show error message
        function showError(message) {
            errorMessage.textContent = message;
            loginError.classList.remove('hidden');
        }

        // Show alert message
        function showAlert(type, message) {
            if (type === 'success') {
                successMessage.textContent = message;
                successAlert.classList.remove('hidden');
                
                // Close success alert after 5 seconds
                setTimeout(() => {
                    successAlert.classList.add('hidden');
                }, 5000);
                
                // Close button functionality
                const closeBtn = successAlert.querySelector('button');
                if (closeBtn) {
                    closeBtn.onclick = () => successAlert.classList.add('hidden');
                }
            } else {
                errorAlertMessage.textContent = message;
                errorAlert.classList.remove('hidden');
                
                // Close error alert after 5 seconds
                setTimeout(() => {
                    errorAlert.classList.add('hidden');
                }, 5000);
                
                // Close button functionality
                const closeBtn = errorAlert.querySelector('button');
                if (closeBtn) {
                    closeBtn.onclick = () => errorAlert.classList.add('hidden');
                }
            }
        }

        // Show modal alert
        function showModalAlert(type, message) {
            const modalAlert = document.getElementById('modal-alert');
            if (!modalAlert) return;
            
            modalAlert.className = `mb-6 p-4 rounded-lg ${type === 'success' ? 'bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-300' : 'bg-red-100 dark:bg-red-900/30 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-300'}`;
            modalAlert.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-3"></i>
                    <span>${message}</span>
                </div>
            `;
            modalAlert.classList.remove('hidden');
            
            // Hide after 5 seconds
            setTimeout(() => {
                modalAlert.classList.add('hidden');
            }, 5000);
        }

        // Format date
        function formatDate(date) {
            if (!date) return 'N/A';
            
            try {
                const dateObj = date.toDate ? date.toDate() : new Date(date);
                return dateObj.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return 'Invalid Date';
            }
        }

        // Initialize admin panel
        function initializeAdminPanel() {
            setupEventListeners();
            checkAuthState();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Login form submission
            loginForm.addEventListener('submit', handleLogin);
            
            // Logout button
            logoutButton.addEventListener('click', handleLogout);
            
            // Navigation items
            navItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = item.id.replace('nav-', '');
                    navigateTo(page);
                });
            });
            
            // Mobile menu toggle
            mobileMenuButton.addEventListener('click', () => {
                document.querySelector('.sidebar').classList.toggle('active');
            });
            
            // Dark mode toggle
            darkModeToggle.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
                updateDarkModeIcon();
            });
            
            // Quick upload button
            quickUploadButton.addEventListener('click', showUploadModal);
            
            // Modal controls
            closeModal.addEventListener('click', hideUploadModal);
            cancelUpload.addEventListener('click', hideUploadModal);
            
            // Upload modal form elements
            setupUploadModalEvents();
            
            // Close modals on ESC key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideUploadModal();
                }
            });
        }

        // Setup upload modal events
        function setupUploadModalEvents() {
            // Course selection
            const courseSelect = document.getElementById('course-select');
            if (courseSelect) {
                courseSelect.addEventListener('change', async (e) => {
                    const courseId = e.target.value;
                    await loadSubjectsForCourse(courseId);
                });
            }
            
            // Subject selection
            const subjectSelect = document.getElementById('subject-select');
            if (subjectSelect) {
                subjectSelect.addEventListener('change', async (e) => {
                    const courseId = document.getElementById('course-select').value;
                    const subjectId = e.target.value;
                    await loadChaptersForSubject(courseId, subjectId);
                });
            }
            
            // Order buttons
            const decrementBtn = document.getElementById('decrement-order');
            const incrementBtn = document.getElementById('increment-order');
            if (decrementBtn && incrementBtn) {
                decrementBtn.addEventListener('click', () => {
                    const orderInput = document.getElementById('question-order');
                    if (orderInput) {
                        orderInput.value = Math.max(1, parseInt(orderInput.value) - 1);
                    }
                });
                
                incrementBtn.addEventListener('click', () => {
                    const orderInput = document.getElementById('question-order');
                    if (orderInput) {
                        orderInput.value = parseInt(orderInput.value) + 1;
                    }
                });
            }
            
            // Character counters
            const questionText = document.getElementById('question-text');
            const explanationText = document.getElementById('explanation-text');
            
            if (questionText) {
                questionText.addEventListener('input', (e) => {
                    const charCount = document.getElementById('question-char-count');
                    if (charCount) {
                        charCount.textContent = `${e.target.value.length} characters`;
                    }
                });
            }
            
            if (explanationText) {
                explanationText.addEventListener('input', (e) => {
                    const charCount = document.getElementById('explanation-char-count');
                    if (charCount) {
                        charCount.textContent = `${e.target.value.length} characters`;
                    }
                });
            }
            
            // Image previews
            const previewQuestionBtn = document.getElementById('preview-question-image');
            const previewExplanationBtn = document.getElementById('preview-explanation-image');
            
            if (previewQuestionBtn) {
                previewQuestionBtn.addEventListener('click', () => {
                    const urlInput = document.getElementById('question-image-url');
                    if (urlInput && urlInput.value.trim()) {
                        const url = urlInput.value.trim();
                        const previewImg = document.getElementById('question-preview-img');
                        const previewDiv = document.getElementById('question-image-preview');
                        if (previewImg) previewImg.src = url;
                        if (previewDiv) previewDiv.classList.remove('hidden');
                    }
                });
            }
            
            const removeQuestionImage = document.getElementById('remove-question-image');
            if (removeQuestionImage) {
                removeQuestionImage.addEventListener('click', () => {
                    const urlInput = document.getElementById('question-image-url');
                    if (urlInput) urlInput.value = '';
                    document.getElementById('question-image-preview').classList.add('hidden');
                });
            }
            
            if (previewExplanationBtn) {
                previewExplanationBtn.addEventListener('click', () => {
                    const urlInput = document.getElementById('explanation-image-url');
                    if (urlInput && urlInput.value.trim()) {
                        const url = urlInput.value.trim();
                        const previewImg = document.getElementById('explanation-preview-img');
                        const previewDiv = document.getElementById('explanation-image-preview');
                        if (previewImg) previewImg.src = url;
                        if (previewDiv) previewDiv.classList.remove('hidden');
                    }
                });
            }
            
            const removeExplanationImage = document.getElementById('remove-explanation-image');
            if (removeExplanationImage) {
                removeExplanationImage.addEventListener('click', () => {
                    const urlInput = document.getElementById('explanation-image-url');
                    if (urlInput) urlInput.value = '';
                    document.getElementById('explanation-image-preview').classList.add('hidden');
                });
            }
            
            // Save draft button
            const saveDraftBtn = document.getElementById('save-draft');
            if (saveDraftBtn) {
                saveDraftBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveQuestion(true);
                });
            }
            
            // Submit question button
            const submitQuestionBtn = document.getElementById('submit-question');
            if (submitQuestionBtn) {
                submitQuestionBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    saveQuestion(false);
                });
            }
            
            // Form submit prevention
            const questionForm = document.getElementById('question-form');
            if (questionForm) {
                questionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                });
            }
        }

        // Check authentication state
        function checkAuthState() {
            auth.onAuthStateChanged(async (user) => {
                if (user && isAdminUser(user)) {
                    currentUser = user;
                    await handleSuccessfulLogin(user);
                } else {
                    // If user is not admin, sign them out
                    if (user) {
                        await auth.signOut();
                    }
                    showLoginScreen();
                }
            });
        }

        // Handle login
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showError("Please enter both email and password");
                return;
            }
            
            if (email !== ADMIN_EMAIL) {
                showError("Access denied. Admin credentials required.");
                return;
            }
            
            loginButtonText.classList.add('hidden');
            loginButtonSpinner.classList.remove('hidden');
            loginButton.disabled = true;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                if (isAdminUser(userCredential.user)) {
                    await handleSuccessfulLogin(userCredential.user);
                } else {
                    await auth.signOut();
                    showError("Access denied. Admin credentials required.");
                }
            } catch (error) {
                console.error("Login error:", error);
                showError(getAuthErrorMessage(error));
            } finally {
                loginButtonText.classList.remove('hidden');
                loginButtonSpinner.classList.add('hidden');
                loginButton.disabled = false;
            }
        }

        // Handle successful login
        async function handleSuccessfulLogin(user) {
            currentUser = user;
            
            // Update user info
            const displayName = user.displayName || 'Admin';
            userInitial.textContent = displayName.charAt(0).toUpperCase();
            userName.textContent = displayName;
            userEmail.textContent = user.email;
            
            // Show admin dashboard
            showAdminDashboard();
            
            // Load initial data
            await loadInitialData();
            
            // Navigate to dashboard
            navigateTo('dashboard');
            
            // Update dark mode icon
            updateDarkModeIcon();
        }

        // Handle logout
        async function handleLogout() {
            try {
                await auth.signOut();
                showLoginScreen();
                showAlert('success', 'Logged out successfully');
            } catch (error) {
                console.error("Logout error:", error);
                showAlert('error', 'Failed to log out');
            }
        }

        // Show login screen
        function showLoginScreen() {
            loginScreen.classList.remove('hidden');
            adminDashboard.classList.add('hidden');
            currentUser = null;
            
            // Clear form
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            loginError.classList.add('hidden');
        }

        // Show admin dashboard
        function showAdminDashboard() {
            loginScreen.classList.add('hidden');
            adminDashboard.classList.remove('hidden');
        }

        // Navigate to page
        async function navigateTo(page) {
            currentPage = page;
            
            // Update navigation
            navItems.forEach(item => {
                if (item.id === `nav-${page}`) {
                    item.classList.add('active', 'bg-blue-50', 'dark:bg-gray-700');
                } else {
                    item.classList.remove('active', 'bg-blue-50', 'dark:bg-gray-700');
                }
            });
            
            // Update page title
            const titles = {
                dashboard: 'Dashboard',
                questions: 'Manage Questions',
                upload: 'Upload Questions',
                stats: 'Statistics',
                users: 'User Management'
            };
            
            const subtitles = {
                dashboard: 'Overview and quick actions',
                questions: 'View, edit, and delete questions',
                upload: 'Add new questions to the database',
                stats: 'Analytics and insights',
                users: 'Manage user permissions'
            };
            
            pageTitle.textContent = titles[page] || 'Dashboard';
            pageSubtitle.textContent = subtitles[page] || '';
            
            // Load page content
            await loadPageContent(page);
            
            // Close mobile menu on navigation
            if (window.innerWidth < 768) {
                document.querySelector('.sidebar').classList.remove('active');
            }
        }

        // Load page content
        async function loadPageContent(page) {
            switch (page) {
                case 'dashboard':
                    await loadDashboard();
                    break;
                case 'questions':
                    await loadQuestionsPage();
                    break;
                case 'upload':
                    await loadUploadPage();
                    break;
                case 'stats':
                    await loadStatsPage();
                    break;
                case 'users':
                    await loadUsersPage();
                    break;
                default:
                    await loadDashboard();
            }
        }

        // Load initial data
        async function loadInitialData() {
            await Promise.all([
                loadCourses(),
                loadStatistics()
            ]);
        }

        // Load courses
        async function loadCourses() {
            if (!db) return;
            
            try {
                const snapshot = await db.collection('courses').get();
                courses = [];
                snapshot.forEach(doc => {
                    courses.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                // Update course dropdown in modal
                const courseSelect = document.getElementById('course-select');
                if (courseSelect) {
                    courseSelect.innerHTML = '<option value="">Select Course</option>' +
                        courses.map(course => 
                            `<option value="${course.id}">${course.title || course.id}</option>`
                        ).join('');
                }
            } catch (error) {
                console.error("Error loading courses:", error);
                showAlert('error', 'Failed to load courses');
            }
        }

        // Load subjects for course
        async function loadSubjectsForCourse(courseId) {
            if (!db || !courseId) return;
            
            try {
                const snapshot = await db.collection('courses').doc(courseId)
                    .collection('subjects').get();
                
                subjects = [];
                const subjectSelect = document.getElementById('subject-select');
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        subjects.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    subjectSelect.innerHTML = '<option value="">Select Subject</option>' +
                        subjects.map(subject => 
                            `<option value="${subject.id}">${subject.title || subject.id}</option>`
                        ).join('');
                    subjectSelect.disabled = false;
                } else {
                    subjectSelect.innerHTML = '<option value="">No subjects available</option>';
                    subjectSelect.disabled = false;
                }
                
                // Reset chapter select
                const chapterSelect = document.getElementById('chapter-select');
                if (chapterSelect) {
                    chapterSelect.innerHTML = '<option value="">Select a subject first</option>';
                    chapterSelect.disabled = true;
                }
            } catch (error) {
                console.error("Error loading subjects:", error);
                showAlert('error', 'Failed to load subjects');
            }
        }

        // Load chapters for subject
        async function loadChaptersForSubject(courseId, subjectId) {
            if (!db || !courseId || !subjectId) return;
            
            try {
                const snapshot = await db.collection('courses').doc(courseId)
                    .collection('subjects').doc(subjectId)
                    .collection('chapters')
                    .orderBy('order')
                    .get();
                
                chapters = [];
                const chapterSelect = document.getElementById('chapter-select');
                
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        chapters.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    chapterSelect.innerHTML = '<option value="">Select Chapter</option>' +
                        chapters.map(chapter => 
                            `<option value="${chapter.id}">${chapter.title || chapter.id}</option>`
                        ).join('');
                    chapterSelect.disabled = false;
                } else {
                    chapterSelect.innerHTML = '<option value="">No chapters available</option>';
                    chapterSelect.disabled = false;
                }
            } catch (error) {
                console.error("Error loading chapters:", error);
                showAlert('error', 'Failed to load chapters');
            }
        }

        // Load statistics
        async function loadStatistics() {
            if (!db) return;
            
            try {
                // For now, we'll use placeholder values
                // In a real app, you would query the database to get actual counts
                statistics.totalCourses = courses.length;
                statistics.totalQuestions = 0;
                statistics.todayUploads = 0;
                
            } catch (error) {
                console.error("Error loading statistics:", error);
            }
        }

        // Load dashboard
        async function loadDashboard() {
            const html = `
                <div class="space-y-6">
                    <!-- Stats Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">Total Questions</p>
                                    <p class="text-3xl font-bold mt-2">${statistics.totalQuestions}</p>
                                </div>
                                <div class="text-3xl opacity-80">
                                    <i class="fas fa-question-circle"></i>
                                </div>
                            </div>
                            <div class="mt-4 text-sm">
                                <i class="fas fa-arrow-up mr-1"></i>
                                <span>12% increase from last month</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">Total Courses</p>
                                    <p class="text-3xl font-bold mt-2">${statistics.totalCourses}</p>
                                </div>
                                <div class="text-3xl opacity-80">
                                    <i class="fas fa-graduation-cap"></i>
                                </div>
                            </div>
                            <div class="mt-4 text-sm">
                                <i class="fas fa-arrow-up mr-1"></i>
                                <span>3 new courses this month</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">Today's Uploads</p>
                                    <p class="text-3xl font-bold mt-2">${statistics.todayUploads}</p>
                                </div>
                                <div class="text-3xl opacity-80">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                            </div>
                            <div class="mt-4 text-sm">
                                <i class="fas fa-arrow-up mr-1"></i>
                                <span>Keep up the good work!</span>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-6 text-white shadow-lg">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-sm opacity-90">Active Users</p>
                                    <p class="text-3xl font-bold mt-2">1,248</p>
                                </div>
                                <div class="text-3xl opacity-80">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="mt-4 text-sm">
                                <i class="fas fa-arrow-up mr-1"></i>
                                <span>15% increase from yesterday</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-bolt mr-2 text-yellow-500"></i>
                                Quick Actions
                            </h3>
                            <div class="space-y-3">
                                <button onclick="showUploadModal()" class="w-full text-left p-4 bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/30 hover:from-blue-100 hover:to-blue-200 dark:hover:from-blue-800/50 dark:hover:to-blue-700/50 rounded-xl transition duration-200">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-plus text-blue-600 dark:text-blue-400"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900 dark:text-white">Upload Question</p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">Add a new question</p>
                                        </div>
                                    </div>
                                </button>
                                
                                <button onclick="navigateTo('questions')" class="w-full text-left p-4 bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/30 hover:from-green-100 hover:to-green-200 dark:hover:from-green-800/50 dark:hover:to-green-700/50 rounded-xl transition duration-200">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-list text-green-600 dark:text-green-400"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900 dark:text-white">Manage Questions</p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">View and edit existing</p>
                                        </div>
                                    </div>
                                </button>
                                
                                <button onclick="navigateTo('stats')" class="w-full text-left p-4 bg-gradient-to-r from-purple-50 to-purple-100 dark:from-purple-900/30 dark:to-purple-800/30 hover:from-purple-100 hover:to-purple-200 dark:hover:from-purple-800/50 dark:hover:to-purple-700/50 rounded-xl transition duration-200">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center mr-3">
                                            <i class="fas fa-chart-line text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <div>
                                            <p class="font-medium text-gray-900 dark:text-white">View Analytics</p>
                                            <p class="text-sm text-gray-600 dark:text-gray-400">See usage statistics</p>
                                        </div>
                                    </div>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Recent Activity -->
                        <div class="md:col-span-2 bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                                <i class="fas fa-history mr-2 text-blue-500"></i>
                                Recent Activity
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mr-4">
                                        <i class="fas fa-cloud-upload-alt text-green-600 dark:text-green-400"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900 dark:text-white">New question uploaded</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Physics - Chapter 3</p>
                                    </div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">2 hours ago</div>
                                </div>
                                
                                <div class="flex items-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center mr-4">
                                        <i class="fas fa-edit text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900 dark:text-white">Question updated</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Mathematics - Chapter 5</p>
                                    </div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">Yesterday</div>
                                </div>
                                
                                <div class="flex items-center p-4 bg-gray-50 dark:bg-gray-700/50 rounded-xl">
                                    <div class="w-10 h-10 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center mr-4">
                                        <i class="fas fa-trash text-red-600 dark:text-red-400"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="font-medium text-gray-900 dark:text-white">Question deleted</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Chemistry - Chapter 2</p>
                                    </div>
                                    <div class="text-sm text-gray-500 dark:text-gray-400">2 days ago</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- System Status -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
                            <i class="fas fa-server mr-2 text-indigo-500"></i>
                            System Status
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 border border-green-200 dark:border-green-800 rounded-xl">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <span class="font-medium text-gray-900 dark:text-white">Database</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">Connected and running</p>
                            </div>
                            
                            <div class="p-4 border border-green-200 dark:border-green-800 rounded-xl">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <span class="font-medium text-gray-900 dark:text-white">Storage</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">2.4 GB / 5 GB used</p>
                            </div>
                            
                            <div class="p-4 border border-green-200 dark:border-green-800 rounded-xl">
                                <div class="flex items-center">
                                    <div class="w-3 h-3 bg-green-500 rounded-full mr-3"></div>
                                    <span class="font-medium text-gray-900 dark:text-white">Uptime</span>
                                </div>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">99.8% (30 days)</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            pageContent.innerHTML = html;
        }

        // Load questions page
        async function loadQuestionsPage() {
            await loadQuestions();
            
            const html = `
                <div class="space-y-6">
                    <!-- Header -->
                    <div class="flex flex-col md:flex-row md:items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Question Management</h2>
                            <p class="text-gray-600 dark:text-gray-400">View, edit, and delete questions</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex space-x-3">
                            <div class="relative">
                                <input type="text" placeholder="Search questions..." 
                                       class="pl-10 pr-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                       id="search-questions">
                                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                            </div>
                            <button onclick="showUploadModal()" class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium">
                                <i class="fas fa-plus mr-2"></i>Add New
                            </button>
                        </div>
                    </div>
                    
                    <!-- Questions Table -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl shadow overflow-hidden">
                        <div class="table-container">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0">
                                    <tr>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Question
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Course/Chapter
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Order
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Created
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Status
                                        </th>
                                        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700" id="questions-table-body">
                                    <!-- Questions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Empty State -->
                        <div id="empty-state" class="hidden p-12 text-center">
                            <div class="max-w-sm mx-auto">
                                <div class="w-24 h-24 mx-auto bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-6">
                                    <i class="fas fa-question text-3xl text-gray-400"></i>
                                </div>
                                <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">No questions found</h3>
                                <p class="text-gray-600 dark:text-gray-400 mb-6">Get started by uploading your first question</p>
                                <button onclick="showUploadModal()" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium">
                                    <i class="fas fa-plus mr-2"></i>Upload Question
                                </button>
                            </div>
                        </div>
                        
                        <!-- Loading State -->
                        <div id="loading-state" class="p-12 text-center">
                            <div class="max-w-sm mx-auto">
                                <div class="loading-spinner mx-auto mb-4"></div>
                                <p class="text-gray-600 dark:text-gray-400">Loading questions...</p>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div id="pagination" class="hidden px-6 py-4 bg-gray-50 dark:bg-gray-700 border-t border-gray-200 dark:border-gray-700">
                            <div class="flex items-center justify-between">
                                <div class="text-sm text-gray-700 dark:text-gray-400">
                                    Showing <span id="page-start">1</span> to <span id="page-end">10</span> of <span id="total-items">0</span> questions
                                </div>
                                <div class="flex space-x-2">
                                    <button id="prev-page" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        Previous
                                    </button>
                                    <button id="next-page" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                        Next
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            pageContent.innerHTML = html;
            
            // Render questions table
            renderQuestionsTable();
        }

        // Load questions
        async function loadQuestions() {
            if (!db) return;
            
            try {
                questions = [];
                
                // Get all courses
                const coursesSnapshot = await db.collection('courses').get();
                
                for (const courseDoc of coursesSnapshot.docs) {
                    // Get subjects for this course
                    const subjectsSnapshot = await db.collection('courses').doc(courseDoc.id)
                        .collection('subjects').get();
                    
                    for (const subjectDoc of subjectsSnapshot.docs) {
                        // Get chapters for this subject
                        const chaptersSnapshot = await db.collection('courses').doc(courseDoc.id)
                            .collection('subjects').doc(subjectDoc.id)
                            .collection('chapters').get();
                        
                        for (const chapterDoc of chaptersSnapshot.docs) {
                            // Get questions for this chapter
                            const questionsSnapshot = await db.collection('courses').doc(courseDoc.id)
                                .collection('subjects').doc(subjectDoc.id)
                                .collection('chapters').doc(chapterDoc.id)
                                .collection('questions')
                                .orderBy('order')
                                .get();
                            
                            questionsSnapshot.forEach(questionDoc => {
                                questions.push({
                                    id: questionDoc.id,
                                    ...questionDoc.data(),
                                    courseId: courseDoc.id,
                                    courseTitle: courseDoc.data().title,
                                    subjectId: subjectDoc.id,
                                    subjectTitle: subjectDoc.data().title,
                                    chapterId: chapterDoc.id,
                                    chapterTitle: chapterDoc.data().title
                                });
                            });
                        }
                    }
                }
                
                statistics.totalQuestions = questions.length;
                
            } catch (error) {
                console.error("Error loading questions:", error);
                showAlert('error', 'Failed to load questions');
            }
        }

        // Render questions table
        function renderQuestionsTable() {
            const tableBody = document.getElementById('questions-table-body');
            const emptyState = document.getElementById('empty-state');
            const loadingState = document.getElementById('loading-state');
            const pagination = document.getElementById('pagination');
            
            if (loadingState) loadingState.classList.add('hidden');
            
            if (questions.length === 0) {
                tableBody.innerHTML = '';
                if (emptyState) emptyState.classList.remove('hidden');
                if (pagination) pagination.classList.add('hidden');
                return;
            }
            
            if (emptyState) emptyState.classList.add('hidden');
            if (pagination) pagination.classList.remove('hidden');
            
            let html = '';
            
            questions.forEach((question, index) => {
                const shortQuestion = question.question && question.question.length > 100 
                    ? question.question.substring(0, 100) + '...' 
                    : question.question || 'No question text';
                
                const correctAnswer = question.options && question.options[question.correctIndex];
                const shortAnswer = correctAnswer && correctAnswer.length > 30
                    ? correctAnswer.substring(0, 30) + '...'
                    : correctAnswer || 'N/A';
                
                html += `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900 dark:text-white">
                                ${shortQuestion}
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                                <i class="fas fa-check-circle text-green-500 mr-1"></i>
                                Correct: ${shortAnswer}
                            </div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 dark:text-white">
                                ${question.courseTitle || 'Unknown Course'}
                            </div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                ${question.chapterTitle || 'Unknown Chapter'}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 rounded-full">
                                ${question.order || 1}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                            ${question.createdAt ? formatDate(question.createdAt) : 'N/A'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium ${question.isDraft ? 'bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200' : 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200'} rounded-full">
                                ${question.isDraft ? 'Draft' : 'Active'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="openEditModal('${question.id}', '${question.courseId}', '${question.subjectId}', '${question.chapterId}')" class="text-blue-600 dark:text-blue-400 hover:text-blue-900 dark:hover:text-blue-300 mr-3">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteQuestion('${question.id}', '${question.courseId}', '${question.subjectId}', '${question.chapterId}')" class="text-red-600 dark:text-red-400 hover:text-red-900 dark:hover:text-red-300">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // Load upload page
        async function loadUploadPage() {
            const html = `
                <div class="max-w-4xl mx-auto">
                    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-lg overflow-hidden">
                        <div class="p-8">
                            <div class="text-center mb-8">
                                <div class="w-20 h-20 mx-auto bg-gradient-to-br from-blue-100 to-indigo-100 dark:from-blue-900/30 dark:to-indigo-900/30 rounded-2xl flex items-center justify-center mb-4">
                                    <i class="fas fa-cloud-upload-alt text-3xl text-blue-600 dark:text-blue-400"></i>
                                </div>
                                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Upload Questions</h2>
                                <p class="text-gray-600 dark:text-gray-400 mt-2">Add new questions to the database</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div class="text-center p-6 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl hover:border-blue-500 dark:hover:border-blue-500 transition duration-200 cursor-pointer" onclick="showUploadModal()">
                                    <div class="w-12 h-12 mx-auto bg-blue-100 dark:bg-blue-900 rounded-xl flex items-center justify-center mb-4">
                                        <i class="fas fa-plus text-blue-600 dark:text-blue-400"></i>
                                    </div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Single Upload</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Upload one question at a time with full details</p>
                                </div>
                                
                                <div class="text-center p-6 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl hover:border-green-500 dark:hover:border-green-500 transition duration-200 cursor-pointer">
                                    <div class="w-12 h-12 mx-auto bg-green-100 dark:bg-green-900 rounded-xl flex items-center justify-center mb-4">
                                        <i class="fas fa-file-excel text-green-600 dark:text-green-400"></i>
                                    </div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Bulk Upload</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Upload multiple questions via Excel/CSV</p>
                                </div>
                                
                                <div class="text-center p-6 border-2 border-dashed border-gray-300 dark:border-gray-700 rounded-2xl hover:border-purple-500 dark:hover:border-purple-500 transition duration-200 cursor-pointer">
                                    <div class="w-12 h-12 mx-auto bg-purple-100 dark:bg-purple-900 rounded-xl flex items-center justify-center mb-4">
                                        <i class="fas fa-copy text-purple-600 dark:text-purple-400"></i>
                                    </div>
                                    <h3 class="font-semibold text-gray-900 dark:text-white mb-2">Duplicate</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Duplicate existing questions with modifications</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 dark:bg-gray-700/50 rounded-xl p-6">
                                <h3 class="font-semibold text-gray-900 dark:text-white mb-4">
                                    <i class="fas fa-lightbulb mr-2 text-yellow-500"></i>
                                    Quick Tips
                                </h3>
                                <ul class="space-y-3">
                                    <li class="flex items-start">
                                        <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                        <span class="text-gray-700 dark:text-gray-300">Use LaTeX syntax ($$...$$) for mathematical equations</span>
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                        <span class="text-gray-700 dark:text-gray-300">Always select the correct answer before uploading</span>
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                        <span class="text-gray-700 dark:text-gray-300">Provide detailed explanations for better learning</span>
                                    </li>
                                    <li class="flex items-start">
                                        <i class="fas fa-check text-green-500 mt-1 mr-3"></i>
                                        <span class="text-gray-700 dark:text-gray-300">Use image URLs for complex diagrams and charts</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 dark:bg-gray-700/50 px-8 py-6 border-t border-gray-200 dark:border-gray-700">
                            <button onclick="showUploadModal()" class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-xl font-semibold text-lg">
                                <i class="fas fa-cloud-upload-alt mr-3"></i>
                                Start Uploading Questions
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            pageContent.innerHTML = html;
        }

        // Load stats page
        async function loadStatsPage() {
            const html = `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Analytics Dashboard</h2>
                            <p class="text-gray-600 dark:text-gray-400">Track performance and usage statistics</p>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <select class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                <option>Last 7 days</option>
                                <option>Last 30 days</option>
                                <option>Last 90 days</option>
                                <option>This year</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Charts will go here -->
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
                        <div class="text-center py-12">
                            <div class="w-24 h-24 mx-auto bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-6">
                                <i class="fas fa-chart-bar text-3xl text-gray-400"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">Analytics Coming Soon</h3>
                            <p class="text-gray-600 dark:text-gray-400">Detailed analytics and charts will be available in the next update.</p>
                        </div>
                    </div>
                </div>
            `;
            
            pageContent.innerHTML = html;
        }

        // Load users page
        async function loadUsersPage() {
            const html = `
                <div class="space-y-6">
                    <div class="flex flex-col md:flex-row md:items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">User Management</h2>
                            <p class="text-gray-600 dark:text-gray-400">Manage user permissions and access</p>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <button class="px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg font-medium">
                                <i class="fas fa-user-plus mr-2"></i>Add User
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-lg">
                        <div class="text-center py-12">
                            <div class="w-24 h-24 mx-auto bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mb-6">
                                <i class="fas fa-users text-3xl text-gray-400"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 dark:text-white mb-2">User Management Coming Soon</h3>
                            <p class="text-gray-600 dark:text-gray-400">User management features will be available in the next update.</p>
                        </div>
                    </div>
                </div>
            `;
            
            pageContent.innerHTML = html;
        }

        // Show upload modal
        function showUploadModal() {
            uploadModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Set modal to upload mode
            document.getElementById('modal-title').textContent = 'Upload New Question';
            document.getElementById('modal-subtitle').textContent = 'Add a new question to the database';
            document.getElementById('submit-button-text').textContent = 'Upload Question';
            
            // Clear hidden fields
            document.getElementById('edit-question-id').value = '';
            document.getElementById('edit-course-id').value = '';
            document.getElementById('edit-subject-id').value = '';
            document.getElementById('edit-chapter-id').value = '';
            
            // Don't reset course/subject/chapter/order if they already have values
            // Only reset question content fields
            resetQuestionContentFields();
            
            // Focus on question text
            setTimeout(() => {
                document.getElementById('question-text').focus();
            }, 100);
        }

        // Open edit modal
        async function openEditModal(questionId, courseId, subjectId, chapterId) {
            try {
                // Fetch the question data
                const questionDoc = await db.collection('courses').doc(courseId)
                    .collection('subjects').doc(subjectId)
                    .collection('chapters').doc(chapterId)
                    .collection('questions').doc(questionId).get();
                
                if (!questionDoc.exists) {
                    showAlert('error', 'Question not found');
                    return;
                }
                
                const questionData = questionDoc.data();
                
                // Show modal
                uploadModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                
                // Set modal to edit mode
                document.getElementById('modal-title').textContent = 'Edit Question';
                document.getElementById('modal-subtitle').textContent = 'Edit existing question';
                document.getElementById('submit-button-text').textContent = 'Update Question';
                
                // Store edit IDs in hidden fields
                document.getElementById('edit-question-id').value = questionId;
                document.getElementById('edit-course-id').value = courseId;
                document.getElementById('edit-subject-id').value = subjectId;
                document.getElementById('edit-chapter-id').value = chapterId;
                
                // Load courses if not already loaded
                if (courses.length === 0) {
                    await loadCourses();
                }
                
                // Set course dropdown
                const courseSelect = document.getElementById('course-select');
                courseSelect.value = courseId;
                
                // Load subjects for this course
                await loadSubjectsForCourse(courseId);
                
                // Set subject dropdown
                const subjectSelect = document.getElementById('subject-select');
                // Wait a bit for subjects to load
                setTimeout(() => {
                    subjectSelect.value = subjectId;
                    
                    // Load chapters for this subject
                    loadChaptersForSubject(courseId, subjectId).then(() => {
                        // Set chapter dropdown
                        setTimeout(() => {
                            const chapterSelect = document.getElementById('chapter-select');
                            chapterSelect.value = chapterId;
                        }, 100);
                    });
                }, 100);
                
                // Set question data
                document.getElementById('question-order').value = questionData.order || 1;
                document.getElementById('question-text').value = questionData.question || '';
                document.getElementById('question-image-url').value = questionData.questionUrl || '';
                document.getElementById('explanation-text').value = questionData.explanation || '';
                document.getElementById('explanation-image-url').value = questionData.explanationUrl || '';
                document.getElementById('explanation-video-url').value = questionData.explanationVideoUrl || '';
                
                // Set options
                if (questionData.options && questionData.options.length >= 4) {
                    document.getElementById('option-text-a').value = questionData.options[0] || '';
                    document.getElementById('option-text-b').value = questionData.options[1] || '';
                    document.getElementById('option-text-c').value = questionData.options[2] || '';
                    document.getElementById('option-text-d').value = questionData.options[3] || '';
                }
                
                // Set correct answer
                const correctIndex = questionData.correctIndex || 0;
                document.querySelector(`input[name="correct-option"][value="${correctIndex}"]`).checked = true;
                
                // Update character counts
                document.getElementById('question-char-count').textContent = `${questionData.question ? questionData.question.length : 0} characters`;
                document.getElementById('explanation-char-count').textContent = `${questionData.explanation ? questionData.explanation.length : 0} characters`;
                
                // Focus on question text
                setTimeout(() => {
                    document.getElementById('question-text').focus();
                }, 100);
                
            } catch (error) {
                console.error("Error opening edit modal:", error);
                showAlert('error', 'Failed to load question for editing');
            }
        }

        // Hide upload modal
        function hideUploadModal() {
            uploadModal.classList.add('hidden');
            document.body.style.overflow = 'auto';
        }

        // Save question (handles both upload and update)
        async function saveQuestion(isDraft = false) {
            console.log('saveQuestion called with isDraft:', isDraft);
            
            if (!db || !currentUser) {
                showModalAlert('error', 'Database not initialized or user not logged in');
                return;
            }
            
            // Prevent multiple clicks
            const submitButton = document.getElementById('submit-question');
            if (submitButton && submitButton.disabled) {
                console.log('Save already in progress, ignoring click');
                return;
            }
            
            try {
                // Get form values
                const courseId = document.getElementById('course-select').value;
                const subjectId = document.getElementById('subject-select').value;
                const chapterId = document.getElementById('chapter-select').value;
                const order = parseInt(document.getElementById('question-order').value) || 1;
                const questionText = document.getElementById('question-text').value.trim();
                const questionUrl = document.getElementById('question-image-url').value.trim() || null;
                const explanation = document.getElementById('explanation-text').value.trim();
                const explanationUrl = document.getElementById('explanation-image-url').value.trim() || null;
                const explanationVideoUrl = document.getElementById('explanation-video-url').value.trim() || null;
                
                // Check if we're in edit mode
                const editQuestionId = document.getElementById('edit-question-id').value;
                const editCourseId = document.getElementById('edit-course-id').value;
                const editSubjectId = document.getElementById('edit-subject-id').value;
                const editChapterId = document.getElementById('edit-chapter-id').value;
                const isEditMode = !!editQuestionId;
                
                // Get options
                const options = [];
                let correctIndex = 0;
                
                // Get option values
                const optionElements = ['a', 'b', 'c', 'd'];
                for (let i = 0; i < optionElements.length; i++) {
                    const letter = optionElements[i];
                    const optionText = document.getElementById(`option-text-${letter}`).value.trim();
                    
                    if (!optionText) {
                        showModalAlert('error', `Option ${letter.toUpperCase()} cannot be empty`);
                        return;
                    }
                    
                    options.push(optionText);
                    
                    // Check if this is the correct answer
                    if (document.getElementById(`option-${letter}`).checked) {
                        correctIndex = i;
                    }
                }
                
                // Validation
                if (!courseId) {
                    showModalAlert('error', 'Please select a course');
                    return;
                }
                
                if (!subjectId) {
                    showModalAlert('error', 'Please select a subject');
                    return;
                }
                
                if (!chapterId) {
                    showModalAlert('error', 'Please select a chapter');
                    return;
                }
                
                if (!questionText) {
                    showModalAlert('error', 'Question text is required');
                    return;
                }
                
                if (options.length < 2) {
                    showModalAlert('error', 'At least 2 options are required');
                    return;
                }
                
                if (!explanation) {
                    showModalAlert('error', 'Explanation is required');
                    return;
                }
                
                // Show loading
                const submitText = document.getElementById('submit-button-text');
                const submitSpinner = document.getElementById('submit-button-spinner');
                
                if (submitText && submitSpinner && submitButton) {
                    submitText.classList.add('hidden');
                    submitSpinner.classList.remove('hidden');
                    submitButton.disabled = true;
                }
                
                // Prepare question data
                const questionData = {
                    order: order,
                    question: questionText,
                    options: options,
                    correctIndex: correctIndex,
                    explanation: explanation,
                    explanationUrl: explanationUrl,
                    explanationVideoUrl: explanationVideoUrl,
                    questionUrl: questionUrl,
                    isDraft: isDraft,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // Add created info if it's a new question
                if (!isEditMode) {
                    questionData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    questionData.createdBy = currentUser.uid;
                    questionData.createdByEmail = currentUser.email;
                } else {
                    // Keep the original created info for edits
                    questionData.updatedBy = currentUser.uid;
                    questionData.updatedByEmail = currentUser.email;
                }
                
                console.log(`${isEditMode ? 'Updating' : 'Saving'} question data:`, questionData);
                
                let docRef;
                
                if (isEditMode) {
                    // Update existing question
                    await db.collection('courses').doc(editCourseId)
                        .collection('subjects').doc(editSubjectId)
                        .collection('chapters').doc(editChapterId)
                        .collection('questions')
                        .doc(editQuestionId)
                        .update(questionData);
                    
                    console.log('Question updated with ID:', editQuestionId);
                } else {
                    // Add new question
                    docRef = await db.collection('courses').doc(courseId)
                        .collection('subjects').doc(subjectId)
                        .collection('chapters').doc(chapterId)
                        .collection('questions')
                        .add(questionData);
                    
                    console.log('Question saved with ID:', docRef.id);
                }
                
                // Success message
                showModalAlert('success', isEditMode 
                    ? (isDraft ? 'Question draft updated successfully!' : 'Question updated successfully!')
                    : (isDraft ? 'Question saved as draft successfully!' : 'Question uploaded successfully!'));
                
                // Make button green for 2 seconds
                submitButton.classList.add('btn-success');
                setTimeout(() => {
                    submitButton.classList.remove('btn-success');
                }, 2000);
                
                // Auto-increment order number
                document.getElementById('question-order').value = order + 1;
                
                // Clear only question content fields (keep course/subject/chapter selection)
                resetQuestionContentFields();
                
                // If in edit mode, close modal after success
                if (isEditMode) {
                    setTimeout(() => {
                        hideUploadModal();
                        showAlert('success', 'Question updated successfully!');
                    }, 1000);
                } else {
                    // Focus on question text for next entry
                    setTimeout(() => {
                        document.getElementById('question-text').focus();
                    }, 100);
                }
                
                // Update statistics
                if (!isEditMode) {
                    statistics.totalQuestions++;
                    if (!isDraft) {
                        statistics.todayUploads++;
                    }
                }
                
                // Reload questions if on questions page
                if (currentPage === 'questions') {
                    await loadQuestions();
                    renderQuestionsTable();
                }
                
                // Update dashboard if visible
                if (currentPage === 'dashboard') {
                    await loadDashboard();
                }
                
            } catch (error) {
                console.error("Error saving question:", error);
                showModalAlert('error', `Failed to ${document.getElementById('edit-question-id').value ? 'update' : 'save'} question: ${error.message}`);
            } finally {
                // Hide loading
                const submitButton = document.getElementById('submit-question');
                const submitText = document.getElementById('submit-button-text');
                const submitSpinner = document.getElementById('submit-button-spinner');
                
                if (submitText && submitSpinner && submitButton) {
                    submitText.classList.remove('hidden');
                    submitSpinner.classList.add('hidden');
                    submitButton.disabled = false;
                }
            }
        }

        // Reset only question content fields (keep course/subject/chapter/order)
        function resetQuestionContentFields() {
            // Reset question text
            const questionText = document.getElementById('question-text');
            if (questionText) questionText.value = '';
            
            // Reset question image URL
            const questionUrl = document.getElementById('question-image-url');
            if (questionUrl) questionUrl.value = '';
            
            // Reset explanation text
            const explanationText = document.getElementById('explanation-text');
            if (explanationText) explanationText.value = '';
            
            // Reset explanation image URL
            const explanationUrl = document.getElementById('explanation-image-url');
            if (explanationUrl) explanationUrl.value = '';
            
            // Reset explanation video URL
            const explanationVideo = document.getElementById('explanation-video-url');
            if (explanationVideo) explanationVideo.value = '';
            
            // Reset option textareas
            ['a', 'b', 'c', 'd'].forEach(letter => {
                const element = document.getElementById(`option-text-${letter}`);
                if (element) element.value = '';
            });
            
            // Reset radio buttons to option A
            const optionA = document.getElementById('option-a');
            if (optionA) optionA.checked = true;
            
            // Hide image previews
            const questionPreview = document.getElementById('question-image-preview');
            if (questionPreview) questionPreview.classList.add('hidden');
            
            const explanationPreview = document.getElementById('explanation-image-preview');
            if (explanationPreview) explanationPreview.classList.add('hidden');
            
            // Reset character counts
            const questionCharCount = document.getElementById('question-char-count');
            if (questionCharCount) questionCharCount.textContent = '0 characters';
            
            const explanationCharCount = document.getElementById('explanation-char-count');
            if (explanationCharCount) explanationCharCount.textContent = '0 characters';
            
            // Clear edit mode
            document.getElementById('edit-question-id').value = '';
            document.getElementById('edit-course-id').value = '';
            document.getElementById('edit-subject-id').value = '';
            document.getElementById('edit-chapter-id').value = '';
            
            // Reset modal to upload mode
            document.getElementById('modal-title').textContent = 'Upload New Question';
            document.getElementById('modal-subtitle').textContent = 'Add a new question to the database';
            document.getElementById('submit-button-text').textContent = 'Upload Question';
        }

        // Delete question
        async function deleteQuestion(questionId, courseId, subjectId, chapterId) {
            if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
                return;
            }
            
            try {
                await db.collection('courses').doc(courseId)
                    .collection('subjects').doc(subjectId)
                    .collection('chapters').doc(chapterId)
                    .collection('questions')
                    .doc(questionId)
                    .delete();
                
                showAlert('success', 'Question deleted successfully');
                
                // Reload questions
                await loadQuestions();
                renderQuestionsTable();
                
                // Update statistics
                statistics.totalQuestions = Math.max(0, statistics.totalQuestions - 1);
                
            } catch (error) {
                console.error("Error deleting question:", error);
                showAlert('error', 'Failed to delete question');
            }
        }

        // Update dark mode icon
        function updateDarkModeIcon() {
            const isDark = document.documentElement.classList.contains('dark');
            const icon = darkModeToggle.querySelector('i');
            
            if (icon) {
                if (isDark) {
                    icon.className = 'fas fa-sun';
                } else {
                    icon.className = 'fas fa-moon';
                }
            }
        }

        // Get auth error message
        function getAuthErrorMessage(error) {
            switch (error.code) {
                case 'auth/invalid-email':
                    return 'Invalid email address.';
                case 'auth/user-disabled':
                    return 'This account has been disabled.';
                case 'auth/user-not-found':
                    return 'No account found with this email.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                case 'auth/network-request-failed':
                    return 'Network error. Please check your connection.';
                default:
                    return error.message || 'Authentication failed. Please try again.';
            }
        }

        // Initialize dark mode from localStorage
        function initializeDarkMode() {
            const darkMode = localStorage.getItem('darkMode');
            if (darkMode === 'true') {
                document.documentElement.classList.add('dark');
            }
        }

        // Initialize the admin panel
        document.addEventListener('DOMContentLoaded', () => {
            initializeDarkMode();
            initializeAdminPanel();
        });
    </script>
</body>
</html>
