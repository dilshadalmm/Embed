<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimum-scale=1.0">
    <title>ConceptBlitz - Admin Panel</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background: #f3f4f6;
            color: #1f2937;
            overflow-x: hidden;
        }

        .admin-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Admin Header */
        .admin-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .admin-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }

        .admin-logo span {
            color: #3b82f6;
        }

        .admin-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-name {
            font-weight: 600;
        }

        .institute-name {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        /* Admin Sidebar */
        .admin-sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e5e7eb;
            padding: 1.5rem 0;
            position: fixed;
            top: 70px;
            bottom: 0;
            left: 0;
            overflow-y: auto;
        }

        .sidebar-item {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            color: #4b5563;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .sidebar-item:hover {
            background: #f9fafb;
            color: #1f2937;
        }

        .sidebar-item.active {
            background: #eff6ff;
            color: #1d4ed8;
            border-left-color: #3b82f6;
            font-weight: 500;
        }

        .sidebar-item i {
            width: 20px;
            text-align: center;
        }

        .sidebar-section {
            padding: 1rem 1.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1rem;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 250px;
            padding: 2rem;
            margin-top: 70px;
            min-height: calc(100vh - 70px);
        }

        .module-header {
            margin-bottom: 2rem;
        }

        .module-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .module-subtitle {
            color: #6b7280;
            font-size: 0.875rem;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.625rem 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        /* Buttons */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.375rem;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .btn-primary:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border-color: #6b7280;
        }

        .btn-secondary:hover {
            background: #4b5563;
            border-color: #4b5563;
        }

        .btn-success {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .btn-success:hover {
            background: #059669;
            border-color: #059669;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
            border-color: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
            border-color: #dc2626;
        }

        .btn-outline {
            background: transparent;
            border-color: #d1d5db;
            color: #374151;
        }

        .btn-outline:hover {
            background: #f9fafb;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
        }

        .admin-table th {
            background: #f9fafb;
            padding: 0.875rem 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid #e5e7eb;
        }

        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
            font-size: 0.875rem;
        }

        .admin-table tr:hover {
            background: #f9fafb;
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-expired {
            background: #e5e7eb;
            color: #374151;
        }

        /* Grid */
        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .grid-cols-3 {
            grid-template-columns: repeat(3, minmax(0, 1fr));
        }

        .grid-cols-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 0.375rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid transparent;
        }

        .alert-success {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .alert-warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-info {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal {
            background: white;
            border-radius: 0.5rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease-out;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .modal-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1.5rem;
        }

        .tab {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: #374151;
        }

        .tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }

        /* Readiness Question Editor */
        .question-editor {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .option-item {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .option-input {
            flex: 1;
        }

        .option-remove {
            color: #ef4444;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.375rem;
        }

        .correct-option {
            background: #d1fae5;
            border-color: #10b981;
        }

        /* Validation */
        .validation-error {
            color: #ef4444;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .validation-error.show {
            display: block;
        }

        .form-input.error {
            border-color: #ef4444;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }

        .empty-state h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 200px;
            }
            .admin-main {
                margin-left: 200px;
            }
        }

        @media (max-width: 768px) {
            .admin-sidebar {
                display: none;
            }
            .admin-main {
                margin-left: 0;
                padding: 1rem;
            }
            .mobile-menu-btn {
                display: block;
            }
            .grid-cols-2, .grid-cols-3, .grid-cols-4 {
                grid-template-columns: 1fr;
            }
        }

        /* Mobile Menu Button */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.25rem;
            color: #374151;
            cursor: pointer;
            padding: 0.5rem;
        }

        /* Mobile Sidebar */
        .mobile-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }

        .mobile-sidebar-overlay.show {
            display: block;
        }

        .mobile-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            width: 250px;
            background: white;
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s;
            overflow-y: auto;
        }

        .mobile-sidebar.show {
            transform: translateX(0);
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div>Loading Admin Panel...</div>
    </div>

    <!-- Admin Container -->
    <div id="adminContainer" class="admin-container" style="display: none;">
        <!-- Header -->
        <header class="admin-header">
            <button id="mobileMenuBtn" class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <div class="admin-logo">Concept<span>Blitz</span> Admin</div>
            
            <div class="admin-info">
                <div style="text-align: right;">
                    <div id="adminNameDisplay" class="admin-name">Loading...</div>
                    <div id="instituteNameDisplay" class="institute-name">Loading...</div>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Mobile Sidebar Overlay -->
        <div id="mobileSidebarOverlay" class="mobile-sidebar-overlay"></div>

        <!-- Mobile Sidebar -->
        <div id="mobileSidebar" class="mobile-sidebar">
            <div style="padding: 1.5rem;">
                <div class="admin-logo" style="margin-bottom: 2rem;">Concept<span>Blitz</span> Admin</div>
                
                <div class="sidebar-section">Main</div>
                <div class="sidebar-item active" data-module="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                
                <div class="sidebar-section">Content Management</div>
                <div class="sidebar-item" data-module="programs">
                    <i class="fas fa-layer-group"></i>
                    <span>Programs</span>
                </div>
                <div class="sidebar-item" data-module="subjects">
                    <i class="fas fa-book"></i>
                    <span>Subjects</span>
                </div>
                <div class="sidebar-item" data-module="chapters">
                    <i class="fas fa-folder"></i>
                    <span>Chapters</span>
                </div>
                <div class="sidebar-item" data-module="lectures">
                    <i class="fas fa-play-circle"></i>
                    <span>Lectures</span>
                </div>
                <div class="sidebar-item" data-module="freeLectures">
                    <i class="fas fa-video"></i>
                    <span>Free Lectures</span>
                </div>
                
                <div class="sidebar-section">User Management</div>
                <div class="sidebar-item" data-module="permissions">
                    <i class="fas fa-user-check"></i>
                    <span>Permissions</span>
                </div>
                
                <div class="sidebar-section">Admin</div>
                <div class="sidebar-item" data-module="profile">
                    <i class="fas fa-user-cog"></i>
                    <span>Profile</span>
                </div>
            </div>
        </div>

        <!-- Desktop Sidebar -->
        <nav class="admin-sidebar">
            <div class="sidebar-section">Main</div>
            <div class="sidebar-item active" data-module="dashboard">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            
            <div class="sidebar-section">Content Management</div>
            <div class="sidebar-item" data-module="programs">
                <i class="fas fa-layer-group"></i>
                <span>Programs</span>
            </div>
            <div class="sidebar-item" data-module="subjects">
                <i class="fas fa-book"></i>
                <span>Subjects</span>
            </div>
            <div class="sidebar-item" data-module="chapters">
                <i class="fas fa-folder"></i>
                    <span>Chapters</span>
                </div>
                <div class="sidebar-item" data-module="lectures">
                    <i class="fas fa-play-circle"></i>
                    <span>Lectures</span>
                </div>
                <div class="sidebar-item" data-module="freeLectures">
                    <i class="fas fa-video"></i>
                    <span>Free Lectures</span>
                </div>
                
                <div class="sidebar-section">User Management</div>
                <div class="sidebar-item" data-module="permissions">
                    <i class="fas fa-user-check"></i>
                    <span>Permissions</span>
                </div>
                
                <div class="sidebar-section">Admin</div>
                <div class="sidebar-item" data-module="profile">
                    <i class="fas fa-user-cog"></i>
                    <span>Profile</span>
                </div>
            </nav>

            <!-- Main Content -->
            <main id="adminMain" class="admin-main">
                <!-- Dashboard Module -->
                <div id="dashboardModule" class="module-content">
                    <div class="module-header">
                        <h1 class="module-title">Admin Dashboard</h1>
                        <p class="module-subtitle">Welcome to ConceptBlitz Admin Panel</p>
                    </div>
                    
                    <div class="grid grid-cols-4">
                        <div class="card">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Total Programs</div>
                                        <div id="totalPrograms" style="font-size: 2rem; font-weight: 700; color: #1f2937;">0</div>
                                    </div>
                                    <div style="width: 48px; height: 48px; background: #eff6ff; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-layer-group" style="color: #3b82f6; font-size: 1.25rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Active Subjects</div>
                                        <div id="totalSubjects" style="font-size: 2rem; font-weight: 700; color: #1f2937;">0</div>
                                    </div>
                                    <div style="width: 48px; height: 48px; background: #f0f9ff; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-book" style="color: #0ea5e9; font-size: 1.25rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Total Lectures</div>
                                        <div id="totalLectures" style="font-size: 2rem; font-weight: 700; color: #1f2937;">0</div>
                                    </div>
                                    <div style="width: 48px; height: 48px; background: #fef3c7; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-play-circle" style="color: #f59e0b; font-size: 1.25rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-body">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div>
                                        <div style="font-size: 0.875rem; color: #6b7280;">Active Users</div>
                                        <div id="totalUsers" style="font-size: 2rem; font-weight: 700; color: #1f2937;">0</div>
                                    </div>
                                    <div style="width: 48px; height: 48px; background: #f0fdf4; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-users" style="color: #10b981; font-size: 1.25rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2" style="margin-top: 1.5rem;">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Recent Programs</div>
                                <button id="refreshPrograms" class="btn btn-sm btn-outline">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table id="recentProgramsTable" class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>Program Name</th>
                                                <th>Created</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Will be populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Admin Status</div>
                            </div>
                            <div class="card-body">
                                <div id="adminStatusInfo">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Programs Module -->
                <div id="programsModule" class="module-content" style="display: none;">
                    <div class="module-header">
                        <h1 class="module-title">Program Management</h1>
                        <p class="module-subtitle">Create and manage your educational programs</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <div class="card-title">Create New Program</div>
                        </div>
                        <div class="card-body">
                            <form id="createProgramForm">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label class="form-label">Program Name *</label>
                                        <input type="text" id="programName" class="form-input" required>
                                        <div class="validation-error" id="programNameError"></div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Order *</label>
                                        <input type="number" id="programOrder" class="form-input" min="0" value="0" required>
                                        <div class="validation-error" id="programOrderError"></div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Profile Image URL</label>
                                    <input type="url" id="programProfileImage" class="form-input" placeholder="https://example.com/image.jpg">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Banner Images (One per line)</label>
                                    <textarea id="programBannerImages" class="form-input form-textarea" placeholder="https://example.com/banner1.jpg&#10;https://example.com/banner2.jpg"></textarea>
                                </div>
                                
                                <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                                    <button type="button" id="cancelProgram" class="btn btn-secondary">Cancel</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-plus"></i> Create Program
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <div class="card-title">Your Programs</div>
                            <button id="refreshProgramsList" class="btn btn-sm btn-outline">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="programsLoading" style="text-align: center; padding: 2rem;">
                                <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                <div>Loading programs...</div>
                            </div>
                            <div id="programsTableContainer" style="display: none;">
                                <div class="table-container">
                                    <table id="programsTable" class="admin-table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Order</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <!-- Will be populated by JS -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Subjects Module -->
                <div id="subjectsModule" class="module-content" style="display: none;">
                    <div class="module-header">
                        <h1 class="module-title">Subject Management</h1>
                        <p class="module-subtitle">Manage subjects within your programs</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <div class="card-title">Select Program</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Choose Program *</label>
                                <select id="programSelect" class="form-input form-select" required>
                                    <option value="">Loading programs...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="subjectManagementSection" style="display: none;">
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div class="card-title">Create New Subject</div>
                            </div>
                            <div class="card-body">
                                <form id="createSubjectForm">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">Subject Title *</label>
                                            <input type="text" id="subjectTitle" class="form-input" required>
                                            <div class="validation-error" id="subjectTitleError"></div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Order *</label>
                                            <input type="number" id="subjectOrder" class="form-input" min="0" value="0" required>
                                            <div class="validation-error" id="subjectOrderError"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Mentor Name *</label>
                                        <input type="text" id="subjectMentorName" class="form-input" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Thumbnail URL</label>
                                        <input type="url" id="subjectThumbnailUrl" class="form-input" placeholder="https://example.com/thumbnail.jpg">
                                    </div>
                                    
                                    <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                                        <button type="button" id="cancelSubject" class="btn btn-secondary">Cancel</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Create Subject
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Subjects in Program: <span id="selectedProgramName"></span></div>
                                <button id="refreshSubjectsList" class="btn btn-sm btn-outline">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="subjectsLoading" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                    <div>Loading subjects...</div>
                                </div>
                                <div id="subjectsTableContainer" style="display: none;">
                                    <div class="table-container">
                                        <table id="subjectsTable" class="admin-table">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Mentor</th>
                                                    <th>Order</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Will be populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chapters Module -->
                <div id="chaptersModule" class="module-content" style="display: none;">
                    <div class="module-header">
                        <h1 class="module-title">Chapter Management</h1>
                        <p class="module-subtitle">Manage chapters within subjects</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <div class="card-title">Select Program & Subject</div>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Choose Program *</label>
                                    <select id="chapterProgramSelect" class="form-input form-select" required>
                                        <option value="">Loading programs...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Choose Subject *</label>
                                    <select id="chapterSubjectSelect" class="form-input form-select" required disabled>
                                        <option value="">Select program first</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="chapterManagementSection" style="display: none;">
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div class="card-title">Create New Chapter</div>
                            </div>
                            <div class="card-body">
                                <form id="createChapterForm">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">Chapter Title *</label>
                                            <input type="text" id="chapterTitle" class="form-input" required>
                                            <div class="validation-error" id="chapterTitleError"></div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Order *</label>
                                            <input type="number" id="chapterOrder" class="form-input" min="0" value="0" required>
                                            <div class="validation-error" id="chapterOrderError"></div>
                                        </div>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                                        <button type="button" id="cancelChapter" class="btn btn-secondary">Cancel</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Create Chapter
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Chapters in Subject: <span id="selectedSubjectName"></span></div>
                                <button id="refreshChaptersList" class="btn btn-sm btn-outline">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="chaptersLoading" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                    <div>Loading chapters...</div>
                                </div>
                                <div id="chaptersTableContainer" style="display: none;">
                                    <div class="table-container">
                                        <table id="chaptersTable" class="admin-table">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Order</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Will be populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lectures Module -->
                <div id="lecturesModule" class="module-content" style="display: none;">
                    <div class="module-header">
                        <h1 class="module-title">Lecture Management</h1>
                        <p class="module-subtitle">Manage lectures and readiness questions</p>
                    </div>
                    
                    <div class="tabs" id="lectureTabs">
                        <div class="tab active" data-tab="lecture-list">Lectures</div>
                        <div class="tab" data-tab="readiness-questions">Readiness Questions</div>
                    </div>
                    
                    <!-- Lecture List Tab -->
                    <div id="lecture-list" class="tab-content">
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div class="card-title">Select Program, Subject & Chapter</div>
                            </div>
                            <div class="card-body">
                                <div class="grid grid-cols-3 gap-4">
                                    <div class="form-group">
                                        <label class="form-label">Choose Program *</label>
                                        <select id="lectureProgramSelect" class="form-input form-select" required>
                                            <option value="">Loading programs...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Choose Subject *</label>
                                        <select id="lectureSubjectSelect" class="form-input form-select" required disabled>
                                            <option value="">Select program first</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Choose Chapter *</label>
                                        <select id="lectureChapterSelect" class="form-input form-select" required disabled>
                                            <option value="">Select subject first</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="lectureManagementSection" style="display: none;">
                            <div class="card" style="margin-bottom: 1.5rem;">
                                <div class="card-header">
                                    <div class="card-title">Create New Lecture</div>
                                </div>
                                <div class="card-body">
                                    <form id="createLectureForm">
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="form-group">
                                                <label class="form-label">Lecture Title *</label>
                                                <input type="text" id="lectureTitle" class="form-input" required>
                                                <div class="validation-error" id="lectureTitleError"></div>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Order *</label>
                                                <input type="number" id="lectureOrder" class="form-input" min="0" value="0" required>
                                                <div class="validation-error" id="lectureOrderError"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label">Video URL *</label>
                                            <input type="url" id="lectureUrl" class="form-input" placeholder="https://www.youtube.com/watch?v=..." required>
                                            <div class="validation-error" id="lectureUrlError"></div>
                                        </div>
                                        
                                        <div class="grid grid-cols-2 gap-4">
                                            <div class="form-group">
                                                <label class="form-label">Mentor Name *</label>
                                                <input type="text" id="lectureMentorName" class="form-input" required>
                                            </div>
                                            <div class="form-group">
                                                <label class="form-label">Mentor Profile Image URL</label>
                                                <input type="url" id="lectureMentorProfile" class="form-input" placeholder="https://example.com/profile.jpg">
                                            </div>
                                        </div>
                                        
                                        <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                                            <button type="button" id="cancelLecture" class="btn btn-secondary">Cancel</button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-plus"></i> Create Lecture
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Lectures in Chapter: <span id="selectedChapterName"></span></div>
                                    <button id="refreshLecturesList" class="btn btn-sm btn-outline">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="lecturesLoading" style="text-align: center; padding: 2rem;">
                                        <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                        <div>Loading lectures...</div>
                                    </div>
                                    <div id="lecturesTableContainer" style="display: none;">
                                        <div class="table-container">
                                            <table id="lecturesTable" class="admin-table">
                                                <thead>
                                                    <tr>
                                                        <th>Title</th>
                                                        <th>Order</th>
                                                        <th>Mentor</th>
                                                        <th>Actions</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <!-- Will be populated by JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Readiness Questions Tab -->
                    <div id="readiness-questions" class="tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Select Lecture for Readiness Questions</div>
                            </div>
                            <div class="card-body">
                                <div class="grid grid-cols-4 gap-4">
                                    <div class="form-group">
                                        <label class="form-label">Program</label>
                                        <select id="questionProgramSelect" class="form-input form-select">
                                            <option value="">Loading programs...</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Subject</label>
                                        <select id="questionSubjectSelect" class="form-input form-select" disabled>
                                            <option value="">Select program first</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Chapter</label>
                                        <select id="questionChapterSelect" class="form-input form-select" disabled>
                                            <option value="">Select subject first</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Lecture</label>
                                        <select id="questionLectureSelect" class="form-input form-select" disabled>
                                            <option value="">Select chapter first</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="questionManagementSection" style="display: none;">
                            <div class="card" style="margin-top: 1.5rem;">
                                <div class="card-header">
                                    <div class="card-title">Readiness Questions for: <span id="selectedLectureName"></span></div>
                                    <button id="addQuestionBtn" class="btn btn-sm btn-primary">
                                        <i class="fas fa-plus"></i> Add Question
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="questionsLoading" style="text-align: center; padding: 2rem;">
                                        <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                        <div>Loading questions...</div>
                                    </div>
                                    <div id="questionsList" style="display: none;">
                                        <!-- Will be populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Free Lectures Module -->
                <div id="freeLecturesModule" class="module-content" style="display: none;">
                    <div class="module-header">
                        <h1 class="module-title">Free Lecture Management</h1>
                        <p class="module-subtitle">Manage free/public lectures</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <div class="card-title">Select Program</div>
                        </div>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label">Choose Program *</label>
                                <select id="freeLectureProgramSelect" class="form-input form-select" required>
                                    <option value="">Loading programs...</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div id="freeLectureManagementSection" style="display: none;">
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div class="card-title">Create New Free Lecture</div>
                            </div>
                            <div class="card-body">
                                <form id="createFreeLectureForm">
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">Lecture Title *</label>
                                            <input type="text" id="freeLectureTitle" class="form-input" required>
                                            <div class="validation-error" id="freeLectureTitleError"></div>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Order *</label>
                                            <input type="number" id="freeLectureOrder" class="form-input" min="0" value="0" required>
                                            <div class="validation-error" id="freeLectureOrderError"></div>
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Video URL *</label>
                                        <input type="url" id="freeLectureUrl" class="form-input" placeholder="https://www.youtube.com/watch?v=..." required>
                                        <div class="validation-error" id="freeLectureUrlError"></div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 gap-4">
                                        <div class="form-group">
                                            <label class="form-label">Mentor Name *</label>
                                            <input type="text" id="freeLectureMentorName" class="form-input" required>
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Mentor Profile Image URL</label>
                                            <input type="url" id="freeLectureMentorProfile" class="form-input" placeholder="https://example.com/profile.jpg">
                                        </div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Status</label>
                                        <select id="freeLectureStatus" class="form-input form-select">
                                            <option value="true">Active</option>
                                            <option value="false">Inactive</option>
                                        </select>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                                        <button type="button" id="cancelFreeLecture" class="btn btn-secondary">Cancel</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> Create Free Lecture
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Free Lectures in Program: <span id="selectedFreeLectureProgramName"></span></div>
                                <button id="refreshFreeLecturesList" class="btn btn-sm btn-outline">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="freeLecturesLoading" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                    <div>Loading free lectures...</div>
                                </div>
                                <div id="freeLecturesTableContainer" style="display: none;">
                                    <div class="table-container">
                                        <table id="freeLecturesTable" class="admin-table">
                                            <thead>
                                                <tr>
                                                    <th>Title</th>
                                                    <th>Order</th>
                                                    <th>Mentor</th>
                                                    <th>Status</th>
                                                    <th>Updated</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Will be populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Permissions Module -->
                <div id="permissionsModule" class="module-content" style="display: none;">
                    <div class="module-header">
                        <h1 class="module-title">Permission Management</h1>
                        <p class="module-subtitle">Manage user access to subjects</p>
                    </div>
                    
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <div class="card-header">
                            <div class="card-title">Select Program & Subject</div>
                        </div>
                        <div class="card-body">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="form-group">
                                    <label class="form-label">Choose Program *</label>
                                    <select id="permissionProgramSelect" class="form-input form-select" required>
                                        <option value="">Loading programs...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Choose Subject *</label>
                                    <select id="permissionSubjectSelect" class="form-input form-select" required disabled>
                                        <option value="">Select program first</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="permissionManagementSection" style="display: none;">
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <div class="card-header">
                                <div class="card-title">Grant New Permission</div>
                            </div>
                            <div class="card-body">
                                <form id="createPermissionForm">
                                    <div class="form-group">
                                        <label class="form-label">User UID *</label>
                                        <input type="text" id="permissionUserUid" class="form-input" required placeholder="Enter Firebase user UID">
                                        <div class="validation-error" id="permissionUserUidError"></div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Approval Status</label>
                                        <select id="permissionApproved" class="form-input form-select">
                                            <option value="true">Approved</option>
                                            <option value="false">Pending</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Expiry Date</label>
                                        <input type="date" id="permissionExpiryDate" class="form-input">
                                        <div class="validation-error" id="permissionExpiryDateError"></div>
                                    </div>
                                    
                                    <div style="display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem;">
                                        <button type="button" id="cancelPermission" class="btn btn-secondary">Cancel</button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-key"></i> Grant Permission
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">Permissions for Subject: <span id="selectedPermissionSubjectName"></span></div>
                                <button id="refreshPermissionsList" class="btn btn-sm btn-outline">
                                    <i class="fas fa-sync-alt"></i> Refresh
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="permissionsLoading" style="text-align: center; padding: 2rem;">
                                    <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                    <div>Loading permissions...</div>
                                </div>
                                <div id="permissionsTableContainer" style="display: none;">
                                    <div class="table-container">
                                        <table id="permissionsTable" class="admin-table">
                                            <thead>
                                                <tr>
                                                    <th>User UID</th>
                                                    <th>Approved</th>
                                                    <th>Subscribed</th>
                                                    <th>Expires</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <!-- Will be populated by JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Module -->
                <div id="profileModule" class="module-content" style="display: none;">
                    <div class="module-header">
                        <h1 class="module-title">Admin Profile</h1>
                        <p class="module-subtitle">Manage your admin account</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div id="profileLoading" style="text-align: center; padding: 2rem;">
                                <div class="loading-spinner" style="width: 30px; height: 30px; margin: 0 auto 1rem;"></div>
                                <div>Loading profile...</div>
                            </div>
                            
                            <div id="profileContent" style="display: none;">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="form-group">
                                        <label class="form-label">Admin Name</label>
                                        <input type="text" id="profileAdminName" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Institute Name</label>
                                        <input type="text" id="profileInstituteName" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Approval Status</label>
                                        <input type="text" id="profileApproved" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Joined Date</label>
                                        <input type="text" id="profileJoinedAt" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Expiry Date</label>
                                        <input type="text" id="profileExpiredAt" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Days Remaining</label>
                                        <input type="text" id="profileDaysRemaining" class="form-input" readonly>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 2rem; padding: 1.5rem; background: #f9fafb; border-radius: 0.375rem;">
                                    <h3 style="font-weight: 600; color: #1f2937; margin-bottom: 1rem;">Admin Status</h3>
                                    <div id="profileStatusMessage">
                                        <!-- Will be populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Question Editor Modal -->
        <div id="questionEditorModal" class="modal-overlay" style="display: none;">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title" id="questionModalTitle">Edit Question</div>
                    <button class="modal-close" id="closeQuestionModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="questionEditorForm">
                        <input type="hidden" id="editQuestionId">
                        <input type="hidden" id="editQuestionIndex">
                        
                        <div class="form-group">
                            <label class="form-label">Question *</label>
                            <textarea id="editQuestionText" class="form-input form-textarea" required></textarea>
                            <div class="validation-error" id="editQuestionTextError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Order *</label>
                            <input type="number" id="editQuestionOrder" class="form-input" min="0" required>
                            <div class="validation-error" id="editQuestionOrderError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Question Media URL (Optional)</label>
                            <input type="url" id="editQuestionUrl" class="form-input" placeholder="https://example.com/image.jpg">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Options * (At least 2 required)</label>
                            <div id="questionOptionsContainer">
                                <!-- Options will be added here -->
                            </div>
                            <button type="button" id="addOptionBtn" class="btn btn-sm btn-outline" style="margin-top: 0.5rem;">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                            <div class="validation-error" id="editQuestionOptionsError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Correct Option Index *</label>
                            <input type="number" id="editCorrectIndex" class="form-input" min="0" required>
                            <small style="color: #6b7280; display: block; margin-top: 0.25rem;">0-based index (e.g., 0 for first option, 1 for second)</small>
                            <div class="validation-error" id="editCorrectIndexError"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Explanation</label>
                            <textarea id="editExplanation" class="form-input form-textarea"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Explanation Media URL (Optional)</label>
                            <input type="url" id="editExplanationUrl" class="form-input" placeholder="https://example.com/image.jpg">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Explanation Video URLs (One per line)</label>
                            <textarea id="editExplanationVideoUrls" class="form-input form-textarea" placeholder="https://youtube.com/watch?v=...&#10;https://vimeo.com/..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" id="cancelQuestionEdit">Cancel</button>
                    <button type="button" class="btn btn-danger" id="deleteQuestionBtn">Delete</button>
                    <button type="button" class="btn btn-primary" id="saveQuestionBtn">Save Question</button>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1000; max-width: 400px;"></div>

        <script>
            // ===== FIREBASE CONFIGURATION =====
            const firebaseConfig = {
                apiKey: "AIzaSyBJ_G5o4otg7riemfJDMOcPoHoIVH7emsc",
                authDomain: "geobazarr.firebaseapp.com",
                databaseURL: "https://geobazarr-default-rtdb.firebaseio.com",
                projectId: "geobazarr",
                storageBucket: "geobazarr.firebasestorage.app",
                messagingSenderId: "679949247383",
                appId: "1:679949247383:web:036d4f32038422ebb89ad2"
            };

            // ===== ADMIN PANEL APPLICATION =====
            class AdminPanelApp {
                constructor() {
                    this.auth = null;
                    this.db = null;
                    this.currentUser = null;
                    this.adminData = null;
                    this.isValidAdmin = false;
                    this.currentProgramId = null;
                    this.currentSubjectId = null;
                    this.currentChapterId = null;
                    this.currentLectureId = null;
                    
                    this.init();
                }

                init() {
                    try {
                        // Initialize Firebase
                        firebase.initializeApp(firebaseConfig);
                        this.auth = firebase.auth();
                        this.db = firebase.firestore();
                        
                        // Setup event listeners
                        this.setupEventListeners();
                        
                        // Start authentication check
                        this.checkAuthState();
                        
                    } catch (error) {
                        console.error("Firebase initialization error:", error);
                        this.showError("Failed to initialize Firebase. Please refresh the page.");
                    }
                }

                setupEventListeners() {
                    // Logout button
                    document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                    
                    // Mobile menu
                    document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                        document.getElementById('mobileSidebar').classList.add('show');
                        document.getElementById('mobileSidebarOverlay').classList.add('show');
                    });
                    
                    document.getElementById('mobileSidebarOverlay').addEventListener('click', () => {
                        document.getElementById('mobileSidebar').classList.remove('show');
                        document.getElementById('mobileSidebarOverlay').classList.remove('show');
                    });
                    
                    // Sidebar navigation
                    document.querySelectorAll('.sidebar-item').forEach(item => {
                        item.addEventListener('click', (e) => {
                            const module = e.currentTarget.dataset.module;
                            this.switchModule(module);
                            
                            // Close mobile sidebar if open
                            document.getElementById('mobileSidebar').classList.remove('show');
                            document.getElementById('mobileSidebarOverlay').classList.remove('show');
                        });
                    });
                    
                    // Module-specific event listeners will be set up when modules are loaded
                }

                async checkAuthState() {
                    this.auth.onAuthStateChanged(async (user) => {
                        if (user) {
                            this.currentUser = user;
                            await this.validateAdmin(user.uid);
                        } else {
                            // No user logged in, redirect to login
                            window.location.href = 'index10 (1).html';
                        }
                    });
                }

                async validateAdmin(uid) {
                    try {
                        // Fetch admin document
                        const adminDoc = await this.db.collection('admins').doc(uid).get();
                        
                        if (!adminDoc.exists) {
                            this.showError("You are not registered as an admin.");
                            setTimeout(() => this.logout(), 3000);
                            return;
                        }
                        
                        this.adminData = adminDoc.data();
                        
                        // Check if admin is approved
                        if (!this.adminData.approved) {
                            this.showError("Your admin account is not approved yet.");
                            setTimeout(() => this.logout(), 3000);
                            return;
                        }
                        
                        // Check if admin account is expired
                        const now = new Date();
                        const expiredAt = this.adminData.expiredAt?.toDate();
                        
                        if (expiredAt && now > expiredAt) {
                            this.showError("Your admin account has expired.");
                            setTimeout(() => this.logout(), 3000);
                            return;
                        }
                        
                        // Admin is valid
                        this.isValidAdmin = true;
                        
                        // Show admin panel
                        this.showAdminPanel();
                        
                        // Load initial data
                        this.loadDashboard();
                        
                    } catch (error) {
                        console.error("Error validating admin:", error);
                        this.showError("Failed to validate admin credentials.");
                    }
                }

                showAdminPanel() {
                    // Hide loading overlay
                    document.getElementById('loadingOverlay').style.display = 'none';
                    
                    // Show admin container
                    document.getElementById('adminContainer').style.display = 'flex';
                    
                    // Update admin info in header
                    document.getElementById('adminNameDisplay').textContent = this.adminData.adminName || 'Admin';
                    document.getElementById('instituteNameDisplay').textContent = this.adminData.instituteName || 'No Institute';
                }

                async logout() {
                    try {
                        await this.auth.signOut();
                        window.location.href = 'index10 (1).html';
                    } catch (error) {
                        console.error("Logout error:", error);
                    }
                }

                switchModule(moduleName) {
                    // Hide all modules
                    document.querySelectorAll('.module-content').forEach(module => {
                        module.style.display = 'none';
                    });
                    
                    // Remove active class from all sidebar items
                    document.querySelectorAll('.sidebar-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    document.querySelectorAll(`[data-module="${moduleName}"]`).forEach(item => {
                        item.classList.add('active');
                    });
                    
                    // Show selected module
                    document.getElementById(`${moduleName}Module`).style.display = 'block';
                    
                    // Load module data
                    this.loadModuleData(moduleName);
                }

                async loadModuleData(moduleName) {
                    switch (moduleName) {
                        case 'dashboard':
                            this.loadDashboard();
                            break;
                        case 'programs':
                            this.loadProgramsModule();
                            break;
                        case 'subjects':
                            this.loadSubjectsModule();
                            break;
                        case 'chapters':
                            this.loadChaptersModule();
                            break;
                        case 'lectures':
                            this.loadLecturesModule();
                            break;
                        case 'freeLectures':
                            this.loadFreeLecturesModule();
                            break;
                        case 'permissions':
                            this.loadPermissionsModule();
                            break;
                        case 'profile':
                            this.loadProfileModule();
                            break;
                    }
                }

                async loadDashboard() {
                    try {
                        // Load programs count
                        const programsSnapshot = await this.db.collection('programs')
                            .where('ownerAdminUid', '==', this.currentUser.uid)
                            .get();
                        
                        document.getElementById('totalPrograms').textContent = programsSnapshot.size;
                        
                        // Load subjects count
                        let totalSubjects = 0;
                        for (const programDoc of programsSnapshot.docs) {
                            const subjectsSnapshot = await this.db.collection('programs')
                                .doc(programDoc.id)
                                .collection('subjects')
                                .get();
                            totalSubjects += subjectsSnapshot.size;
                        }
                        document.getElementById('totalSubjects').textContent = totalSubjects;
                        
                        // Load lectures count
                        let totalLectures = 0;
                        for (const programDoc of programsSnapshot.docs) {
                            const subjectsSnapshot = await this.db.collection('programs')
                                .doc(programDoc.id)
                                .collection('subjects')
                                .get();
                            
                            for (const subjectDoc of subjectsSnapshot.docs) {
                                const chaptersSnapshot = await this.db.collection('programs')
                                    .doc(programDoc.id)
                                    .collection('subjects')
                                    .doc(subjectDoc.id)
                                    .collection('chapters')
                                    .get();
                                
                                for (const chapterDoc of chaptersSnapshot.docs) {
                                    const lecturesSnapshot = await this.db.collection('programs')
                                        .doc(programDoc.id)
                                        .collection('subjects')
                                        .doc(subjectDoc.id)
                                        .collection('chapters')
                                        .doc(chapterDoc.id)
                                        .collection('lectures')
                                        .get();
                                    
                                    totalLectures += lecturesSnapshot.size;
                                }
                            }
                        }
                        document.getElementById('totalLectures').textContent = totalLectures;
                        
                        // Load recent programs
                        const recentPrograms = [];
                        programsSnapshot.forEach(doc => {
                            const data = doc.data();
                            recentPrograms.push({
                                id: doc.id,
                                ...data,
                                createdAt: data.createdAt?.toDate() || new Date()
                            });
                        });
                        
                        // Sort by creation date
                        recentPrograms.sort((a, b) => b.createdAt - a.createdAt);
                        
                        // Update table
                        const tableBody = document.querySelector('#recentProgramsTable tbody');
                        tableBody.innerHTML = '';
                        
                        recentPrograms.slice(0, 5).forEach(program => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${program.programName || 'Unnamed Program'}</td>
                                <td>${program.createdAt.toLocaleDateString()}</td>
                                <td><span class="status-badge status-active">Active</span></td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Update admin status
                        const statusContainer = document.getElementById('adminStatusInfo');
                        const expiredAt = this.adminData.expiredAt?.toDate();
                        const now = new Date();
                        
                        if (expiredAt) {
                            const daysRemaining = Math.ceil((expiredAt - now) / (1000 * 60 * 60 * 24));
                            
                            statusContainer.innerHTML = `
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">Account Status</div>
                                    <div style="font-weight: 600; color: #1f2937;">${this.adminData.approved ? 'Approved' : 'Pending'}</div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">Expiry Date</div>
                                    <div style="font-weight: 600; color: #1f2937;">${expiredAt.toLocaleDateString()}</div>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <div style="font-size: 0.875rem; color: #6b7280;">Days Remaining</div>
                                    <div style="font-weight: 600; color: ${daysRemaining > 30 ? '#10b981' : daysRemaining > 7 ? '#f59e0b' : '#ef4444'}">
                                        ${daysRemaining} days
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Refresh button
                        document.getElementById('refreshPrograms').addEventListener('click', () => {
                            this.loadDashboard();
                        });
                        
                    } catch (error) {
                        console.error("Error loading dashboard:", error);
                        this.showError("Failed to load dashboard data.");
                    }
                }

                async loadProgramsModule() {
                    try {
                        // Load programs
                        const programsSnapshot = await this.db.collection('programs')
                            .where('ownerAdminUid', '==', this.currentUser.uid)
                            .get();
                        
                        const programs = [];
                        programsSnapshot.forEach(doc => {
                            programs.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // Sort by order
                        programs.sort((a, b) => (a.order || 0) - (b.order || 0));
                        
                        // Update table
                        const tableBody = document.querySelector('#programsTable tbody');
                        tableBody.innerHTML = '';
                        
                        programs.forEach(program => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${program.programName || 'Unnamed Program'}</td>
                                <td>${program.order || 0}</td>
                                <td>${program.createdAt?.toDate?.().toLocaleDateString() || 'N/A'}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline edit-program" data-id="${program.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline delete-program" data-id="${program.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Show table
                        document.getElementById('programsLoading').style.display = 'none';
                        document.getElementById('programsTableContainer').style.display = 'block';
                        
                        // Setup event listeners
                        this.setupProgramsEventListeners(programs);
                        
                    } catch (error) {
                        console.error("Error loading programs:", error);
                        this.showError("Failed to load programs.");
                    }
                }

                setupProgramsEventListeners(programs) {
                    // Create program form
                    document.getElementById('createProgramForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.createProgram();
                    });
                    
                    // Cancel button
                    document.getElementById('cancelProgram').addEventListener('click', () => {
                        document.getElementById('createProgramForm').reset();
                    });
                    
                    // Refresh button
                    document.getElementById('refreshProgramsList').addEventListener('click', () => {
                        this.loadProgramsModule();
                    });
                    
                    // Edit and delete buttons
                    document.querySelectorAll('.edit-program').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const programId = e.currentTarget.dataset.id;
                            const program = programs.find(p => p.id === programId);
                            this.editProgram(program);
                        });
                    });
                    
                    document.querySelectorAll('.delete-program').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const programId = e.currentTarget.dataset.id;
                            if (confirm('Are you sure you want to delete this program? This will delete all subjects, chapters, lectures, and permissions associated with it.')) {
                                this.deleteProgram(programId);
                            }
                        });
                    });
                }

                async createProgram() {
                    try {
                        const programName = document.getElementById('programName').value.trim();
                        const programOrder = parseInt(document.getElementById('programOrder').value);
                        const profileImage = document.getElementById('programProfileImage').value.trim();
                        const bannerImages = document.getElementById('programBannerImages').value
                            .split('\n')
                            .map(url => url.trim())
                            .filter(url => url);
                        
                        // Validation
                        if (!programName) {
                            this.showValidationError('programNameError', 'Program name is required');
                            return;
                        }
                        
                        if (isNaN(programOrder)) {
                            this.showValidationError('programOrderError', 'Order must be a number');
                            return;
                        }
                        
                        // Create program
                        const programData = {
                            programName: programName,
                            ownerAdminUid: this.currentUser.uid,
                            order: programOrder,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            profileImage: profileImage || null
                        };
                        
                        // Add banner images if provided
                        if (bannerImages.length > 0) {
                            programData.imageUrl = bannerImages;
                        }
                        
                        await this.db.collection('programs').add(programData);
                        
                        // Show success message
                        this.showAlert('Program created successfully!', 'success');
                        
                        // Reset form
                        document.getElementById('createProgramForm').reset();
                        
                        // Refresh programs list
                        this.loadProgramsModule();
                        
                    } catch (error) {
                        console.error("Error creating program:", error);
                        this.showError("Failed to create program. Please check your permissions.");
                    }
                }

                editProgram(program) {
                    // For now, just show an alert
                    // In a full implementation, you would show a modal with the form pre-filled
                    this.showAlert(`Edit functionality for "${program.programName}" would be implemented here.`, 'info');
                }

                async deleteProgram(programId) {
                    try {
                        // First, delete all subcollections recursively
                        await this.deleteProgramRecursive(programId);
                        
                        // Then delete the program document
                        await this.db.collection('programs').doc(programId).delete();
                        
                        this.showAlert('Program deleted successfully!', 'success');
                        this.loadProgramsModule();
                        
                    } catch (error) {
                        console.error("Error deleting program:", error);
                        this.showError("Failed to delete program.");
                    }
                }

                async deleteProgramRecursive(programId) {
                    // Delete permissions
                    const subjectsSnapshot = await this.db.collection('programs')
                        .doc(programId)
                        .collection('subjects')
                        .get();
                    
                    for (const subjectDoc of subjectsSnapshot.docs) {
                        const permissionsSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectDoc.id)
                            .collection('permissions')
                            .get();
                        
                        for (const permissionDoc of permissionsSnapshot.docs) {
                            await permissionDoc.ref.delete();
                        }
                    }
                    
                    // Delete free lectures
                    const freeLecturesSnapshot = await this.db.collection('programs')
                        .doc(programId)
                        .collection('freeLectures')
                        .get();
                    
                    for (const lectureDoc of freeLecturesSnapshot.docs) {
                        await lectureDoc.ref.delete();
                    }
                    
                    // Delete subjects, chapters, and lectures recursively
                    for (const subjectDoc of subjectsSnapshot.docs) {
                        const chaptersSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectDoc.id)
                            .collection('chapters')
                            .get();
                        
                        for (const chapterDoc of chaptersSnapshot.docs) {
                            const lecturesSnapshot = await this.db.collection('programs')
                                .doc(programId)
                                .collection('subjects')
                                .doc(subjectDoc.id)
                                .collection('chapters')
                                .doc(chapterDoc.id)
                                .collection('lectures')
                                .get();
                            
                            for (const lectureDoc of lecturesSnapshot.docs) {
                                // Delete lecture subcollections if any
                                await lectureDoc.ref.delete();
                            }
                            
                            await chapterDoc.ref.delete();
                        }
                        
                        await subjectDoc.ref.delete();
                    }
                }

                async loadSubjectsModule() {
                    try {
                        // Load programs for dropdown
                        await this.loadProgramsDropdown('programSelect');
                        
                        // Event listener for program selection
                        document.getElementById('programSelect').addEventListener('change', async (e) => {
                            const programId = e.target.value;
                            if (programId) {
                                this.currentProgramId = programId;
                                await this.loadSubjectsForProgram(programId);
                            } else {
                                document.getElementById('subjectManagementSection').style.display = 'none';
                            }
                        });
                        
                    } catch (error) {
                        console.error("Error loading subjects module:", error);
                        this.showError("Failed to load subjects module.");
                    }
                }

                async loadProgramsDropdown(dropdownId) {
                    try {
                        const programsSnapshot = await this.db.collection('programs')
                            .where('ownerAdminUid', '==', this.currentUser.uid)
                            .get();
                        
                        const dropdown = document.getElementById(dropdownId);
                        dropdown.innerHTML = '<option value="">Select a program</option>';
                        
                        programsSnapshot.forEach(doc => {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = doc.data().programName || `Program ${doc.id}`;
                            dropdown.appendChild(option);
                        });
                        
                    } catch (error) {
                        console.error("Error loading programs dropdown:", error);
                    }
                }

                async loadSubjectsForProgram(programId) {
                    try {
                        document.getElementById('selectedProgramName').textContent = 'Loading...';
                        document.getElementById('subjectsLoading').style.display = 'block';
                        document.getElementById('subjectsTableContainer').style.display = 'none';
                        document.getElementById('subjectManagementSection').style.display = 'block';
                        
                        // Load program name
                        const programDoc = await this.db.collection('programs').doc(programId).get();
                        document.getElementById('selectedProgramName').textContent = programDoc.data().programName || `Program ${programId}`;
                        
                        // Load subjects
                        const subjectsSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .get();
                        
                        const subjects = [];
                        subjectsSnapshot.forEach(doc => {
                            subjects.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // Sort by order
                        subjects.sort((a, b) => (a.order || 0) - (b.order || 0));
                        
                        // Update table
                        const tableBody = document.querySelector('#subjectsTable tbody');
                        tableBody.innerHTML = '';
                        
                        subjects.forEach(subject => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${subject.title || 'Untitled Subject'}</td>
                                <td>${subject.mentorName || 'N/A'}</td>
                                <td>${subject.order || 0}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline edit-subject" data-id="${subject.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline delete-subject" data-id="${subject.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Show table
                        document.getElementById('subjectsLoading').style.display = 'none';
                        document.getElementById('subjectsTableContainer').style.display = 'block';
                        
                        // Setup event listeners
                        this.setupSubjectsEventListeners(programId, subjects);
                        
                    } catch (error) {
                        console.error("Error loading subjects:", error);
                        this.showError("Failed to load subjects.");
                    }
                }

                setupSubjectsEventListeners(programId, subjects) {
                    // Create subject form
                    document.getElementById('createSubjectForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.createSubject(programId);
                    });
                    
                    // Cancel button
                    document.getElementById('cancelSubject').addEventListener('click', () => {
                        document.getElementById('createSubjectForm').reset();
                    });
                    
                    // Refresh button
                    document.getElementById('refreshSubjectsList').addEventListener('click', () => {
                        this.loadSubjectsForProgram(programId);
                    });
                    
                    // Edit and delete buttons
                    document.querySelectorAll('.edit-subject').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const subjectId = e.currentTarget.dataset.id;
                            const subject = subjects.find(s => s.id === subjectId);
                            this.editSubject(programId, subject);
                        });
                    });
                    
                    document.querySelectorAll('.delete-subject').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const subjectId = e.currentTarget.dataset.id;
                            if (confirm('Are you sure you want to delete this subject? This will delete all chapters, lectures, and permissions associated with it.')) {
                                this.deleteSubject(programId, subjectId);
                            }
                        });
                    });
                }

                async createSubject(programId) {
                    try {
                        const title = document.getElementById('subjectTitle').value.trim();
                        const order = parseInt(document.getElementById('subjectOrder').value);
                        const mentorName = document.getElementById('subjectMentorName').value.trim();
                        const thumbnailUrl = document.getElementById('subjectThumbnailUrl').value.trim();
                        
                        // Validation
                        if (!title) {
                            this.showValidationError('subjectTitleError', 'Subject title is required');
                            return;
                        }
                        
                        if (isNaN(order)) {
                            this.showValidationError('subjectOrderError', 'Order must be a number');
                            return;
                        }
                        
                        if (!mentorName) {
                            this.showValidationError('subjectMentorNameError', 'Mentor name is required');
                            return;
                        }
                        
                        // Create subject
                        const subjectData = {
                            title: title,
                            order: order,
                            mentorName: mentorName,
                            thumbnailUrl: thumbnailUrl || null
                        };
                        
                        await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .add(subjectData);
                        
                        this.showAlert('Subject created successfully!', 'success');
                        document.getElementById('createSubjectForm').reset();
                        this.loadSubjectsForProgram(programId);
                        
                    } catch (error) {
                        console.error("Error creating subject:", error);
                        this.showError("Failed to create subject.");
                    }
                }

                editSubject(programId, subject) {
                    // Show edit modal or form
                    this.showAlert(`Edit functionality for "${subject.title}" would be implemented here.`, 'info');
                }

                async deleteSubject(programId, subjectId) {
                    try {
                        // Delete subject and all its subcollections
                        await this.deleteSubjectRecursive(programId, subjectId);
                        
                        this.showAlert('Subject deleted successfully!', 'success');
                        this.loadSubjectsForProgram(programId);
                        
                    } catch (error) {
                        console.error("Error deleting subject:", error);
                        this.showError("Failed to delete subject.");
                    }
                }

                async deleteSubjectRecursive(programId, subjectId) {
                    // Delete permissions
                    const permissionsSnapshot = await this.db.collection('programs')
                        .doc(programId)
                        .collection('subjects')
                        .doc(subjectId)
                        .collection('permissions')
                        .get();
                    
                    for (const permissionDoc of permissionsSnapshot.docs) {
                        await permissionDoc.ref.delete();
                    }
                    
                    // Delete chapters and lectures
                    const chaptersSnapshot = await this.db.collection('programs')
                        .doc(programId)
                        .collection('subjects')
                        .doc(subjectId)
                        .collection('chapters')
                        .get();
                    
                    for (const chapterDoc of chaptersSnapshot.docs) {
                        const lecturesSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .doc(chapterDoc.id)
                            .collection('lectures')
                            .get();
                        
                        for (const lectureDoc of lecturesSnapshot.docs) {
                            await lectureDoc.ref.delete();
                        }
                        
                        await chapterDoc.ref.delete();
                    }
                    
                    // Delete subject
                    await this.db.collection('programs')
                        .doc(programId)
                        .collection('subjects')
                        .doc(subjectId)
                        .delete();
                }

                async loadChaptersModule() {
                    try {
                        // Load programs for dropdown
                        await this.loadProgramsDropdown('chapterProgramSelect');
                        
                        // Event listener for program selection
                        document.getElementById('chapterProgramSelect').addEventListener('change', async (e) => {
                            const programId = e.target.value;
                            if (programId) {
                                this.currentProgramId = programId;
                                await this.loadSubjectsDropdown('chapterSubjectSelect', programId);
                                document.getElementById('chapterSubjectSelect').disabled = false;
                            } else {
                                document.getElementById('chapterSubjectSelect').disabled = true;
                                document.getElementById('chapterManagementSection').style.display = 'none';
                            }
                        });
                        
                        // Event listener for subject selection
                        document.getElementById('chapterSubjectSelect').addEventListener('change', async (e) => {
                            const subjectId = e.target.value;
                            if (subjectId) {
                                this.currentSubjectId = subjectId;
                                await this.loadChaptersForSubject(this.currentProgramId, subjectId);
                            } else {
                                document.getElementById('chapterManagementSection').style.display = 'none';
                            }
                        });
                        
                    } catch (error) {
                        console.error("Error loading chapters module:", error);
                        this.showError("Failed to load chapters module.");
                    }
                }

                async loadSubjectsDropdown(dropdownId, programId) {
                    try {
                        const subjectsSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .get();
                        
                        const dropdown = document.getElementById(dropdownId);
                        dropdown.innerHTML = '<option value="">Select a subject</option>';
                        
                        subjectsSnapshot.forEach(doc => {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = doc.data().title || `Subject ${doc.id}`;
                            dropdown.appendChild(option);
                        });
                        
                    } catch (error) {
                        console.error("Error loading subjects dropdown:", error);
                    }
                }

                async loadChaptersForSubject(programId, subjectId) {
                    try {
                        document.getElementById('selectedSubjectName').textContent = 'Loading...';
                        document.getElementById('chaptersLoading').style.display = 'block';
                        document.getElementById('chaptersTableContainer').style.display = 'none';
                        document.getElementById('chapterManagementSection').style.display = 'block';
                        
                        // Load subject name
                        const subjectDoc = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .get();
                        document.getElementById('selectedSubjectName').textContent = subjectDoc.data().title || `Subject ${subjectId}`;
                        
                        // Load chapters
                        const chaptersSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .get();
                        
                        const chapters = [];
                        chaptersSnapshot.forEach(doc => {
                            chapters.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // Sort by order
                        chapters.sort((a, b) => (a.order || 0) - (b.order || 0));
                        
                        // Update table
                        const tableBody = document.querySelector('#chaptersTable tbody');
                        tableBody.innerHTML = '';
                        
                        chapters.forEach(chapter => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${chapter.title || 'Untitled Chapter'}</td>
                                <td>${chapter.order || 0}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline edit-chapter" data-id="${chapter.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline delete-chapter" data-id="${chapter.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Show table
                        document.getElementById('chaptersLoading').style.display = 'none';
                        document.getElementById('chaptersTableContainer').style.display = 'block';
                        
                        // Setup event listeners
                        this.setupChaptersEventListeners(programId, subjectId, chapters);
                        
                    } catch (error) {
                        console.error("Error loading chapters:", error);
                        this.showError("Failed to load chapters.");
                    }
                }

                setupChaptersEventListeners(programId, subjectId, chapters) {
                    // Create chapter form
                    document.getElementById('createChapterForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.createChapter(programId, subjectId);
                    });
                    
                    // Cancel button
                    document.getElementById('cancelChapter').addEventListener('click', () => {
                        document.getElementById('createChapterForm').reset();
                    });
                    
                    // Refresh button
                    document.getElementById('refreshChaptersList').addEventListener('click', () => {
                        this.loadChaptersForSubject(programId, subjectId);
                    });
                    
                    // Edit and delete buttons
                    document.querySelectorAll('.edit-chapter').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const chapterId = e.currentTarget.dataset.id;
                            const chapter = chapters.find(c => c.id === chapterId);
                            this.editChapter(programId, subjectId, chapter);
                        });
                    });
                    
                    document.querySelectorAll('.delete-chapter').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const chapterId = e.currentTarget.dataset.id;
                            if (confirm('Are you sure you want to delete this chapter? This will delete all lectures associated with it.')) {
                                this.deleteChapter(programId, subjectId, chapterId);
                            }
                        });
                    });
                }

                async createChapter(programId, subjectId) {
                    try {
                        const title = document.getElementById('chapterTitle').value.trim();
                        const order = parseInt(document.getElementById('chapterOrder').value);
                        
                        // Validation
                        if (!title) {
                            this.showValidationError('chapterTitleError', 'Chapter title is required');
                            return;
                        }
                        
                        if (isNaN(order)) {
                            this.showValidationError('chapterOrderError', 'Order must be a number');
                            return;
                        }
                        
                        // Create chapter
                        const chapterData = {
                            title: title,
                            order: order
                        };
                        
                        await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .add(chapterData);
                        
                        this.showAlert('Chapter created successfully!', 'success');
                        document.getElementById('createChapterForm').reset();
                        this.loadChaptersForSubject(programId, subjectId);
                        
                    } catch (error) {
                        console.error("Error creating chapter:", error);
                        this.showError("Failed to create chapter.");
                    }
                }

                async deleteChapter(programId, subjectId, chapterId) {
                    try {
                        // Delete chapter and all lectures
                        await this.deleteChapterRecursive(programId, subjectId, chapterId);
                        
                        this.showAlert('Chapter deleted successfully!', 'success');
                        this.loadChaptersForSubject(programId, subjectId);
                        
                    } catch (error) {
                        console.error("Error deleting chapter:", error);
                        this.showError("Failed to delete chapter.");
                    }
                }

                async deleteChapterRecursive(programId, subjectId, chapterId) {
                    // Delete lectures
                    const lecturesSnapshot = await this.db.collection('programs')
                        .doc(programId)
                        .collection('subjects')
                        .doc(subjectId)
                        .collection('chapters')
                        .doc(chapterId)
                        .collection('lectures')
                        .get();
                    
                    for (const lectureDoc of lecturesSnapshot.docs) {
                        await lectureDoc.ref.delete();
                    }
                    
                    // Delete chapter
                    await this.db.collection('programs')
                        .doc(programId)
                        .collection('subjects')
                        .doc(subjectId)
                        .collection('chapters')
                        .doc(chapterId)
                        .delete();
                }

                async loadLecturesModule() {
                    try {
                        // Setup tab switching
                        document.querySelectorAll('#lectureTabs .tab').forEach(tab => {
                            tab.addEventListener('click', (e) => {
                                const tabName = e.currentTarget.dataset.tab;
                                
                                // Update active tab
                                document.querySelectorAll('#lectureTabs .tab').forEach(t => {
                                    t.classList.remove('active');
                                });
                                e.currentTarget.classList.add('active');
                                
                                // Show selected tab content
                                document.querySelectorAll('.tab-content').forEach(content => {
                                    content.style.display = 'none';
                                });
                                document.getElementById(tabName).style.display = 'block';
                                
                                // Load data for tab if needed
                                if (tabName === 'readiness-questions') {
                                    this.loadReadinessQuestionsTab();
                                }
                            });
                        });
                        
                        // Load programs for dropdown
                        await this.loadProgramsDropdown('lectureProgramSelect');
                        
                        // Event listeners for lecture management
                        this.setupLectureManagementEventListeners();
                        
                    } catch (error) {
                        console.error("Error loading lectures module:", error);
                        this.showError("Failed to load lectures module.");
                    }
                }

                setupLectureManagementEventListeners() {
                    // Program selection
                    document.getElementById('lectureProgramSelect').addEventListener('change', async (e) => {
                        const programId = e.target.value;
                        if (programId) {
                            this.currentProgramId = programId;
                            await this.loadSubjectsDropdown('lectureSubjectSelect', programId);
                            document.getElementById('lectureSubjectSelect').disabled = false;
                        } else {
                            document.getElementById('lectureSubjectSelect').disabled = true;
                            document.getElementById('lectureChapterSelect').disabled = true;
                            document.getElementById('lectureManagementSection').style.display = 'none';
                        }
                    });
                    
                    // Subject selection
                    document.getElementById('lectureSubjectSelect').addEventListener('change', async (e) => {
                        const subjectId = e.target.value;
                        if (subjectId) {
                            this.currentSubjectId = subjectId;
                            await this.loadChaptersDropdown('lectureChapterSelect', this.currentProgramId, subjectId);
                            document.getElementById('lectureChapterSelect').disabled = false;
                        } else {
                            document.getElementById('lectureChapterSelect').disabled = true;
                            document.getElementById('lectureManagementSection').style.display = 'none';
                        }
                    });
                    
                    // Chapter selection
                    document.getElementById('lectureChapterSelect').addEventListener('change', async (e) => {
                        const chapterId = e.target.value;
                        if (chapterId) {
                            this.currentChapterId = chapterId;
                            await this.loadLecturesForChapter(this.currentProgramId, this.currentSubjectId, chapterId);
                        } else {
                            document.getElementById('lectureManagementSection').style.display = 'none';
                        }
                    });
                }

                async loadChaptersDropdown(dropdownId, programId, subjectId) {
                    try {
                        const chaptersSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .get();
                        
                        const dropdown = document.getElementById(dropdownId);
                        dropdown.innerHTML = '<option value="">Select a chapter</option>';
                        
                        chaptersSnapshot.forEach(doc => {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = doc.data().title || `Chapter ${doc.id}`;
                            dropdown.appendChild(option);
                        });
                        
                    } catch (error) {
                        console.error("Error loading chapters dropdown:", error);
                    }
                }

                async loadLecturesForChapter(programId, subjectId, chapterId) {
                    try {
                        document.getElementById('selectedChapterName').textContent = 'Loading...';
                        document.getElementById('lecturesLoading').style.display = 'block';
                        document.getElementById('lecturesTableContainer').style.display = 'none';
                        document.getElementById('lectureManagementSection').style.display = 'block';
                        
                        // Load chapter name
                        const chapterDoc = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .doc(chapterId)
                            .get();
                        document.getElementById('selectedChapterName').textContent = chapterDoc.data().title || `Chapter ${chapterId}`;
                        
                        // Load lectures
                        const lecturesSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .doc(chapterId)
                            .collection('lectures')
                            .get();
                        
                        const lectures = [];
                        lecturesSnapshot.forEach(doc => {
                            lectures.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // Sort by order
                        lectures.sort((a, b) => (a.lectureOrder || 0) - (b.lectureOrder || 0));
                        
                        // Update table
                        const tableBody = document.querySelector('#lecturesTable tbody');
                        tableBody.innerHTML = '';
                        
                        lectures.forEach(lecture => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${lecture.lectureTitle || 'Untitled Lecture'}</td>
                                <td>${lecture.lectureOrder || 0}</td>
                                <td>${lecture.mentorName || 'N/A'}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline edit-lecture" data-id="${lecture.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline delete-lecture" data-id="${lecture.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline manage-questions" data-id="${lecture.id}">
                                        <i class="fas fa-question-circle"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Show table
                        document.getElementById('lecturesLoading').style.display = 'none';
                        document.getElementById('lecturesTableContainer').style.display = 'block';
                        
                        // Setup event listeners
                        this.setupLecturesEventListeners(programId, subjectId, chapterId, lectures);
                        
                    } catch (error) {
                        console.error("Error loading lectures:", error);
                        this.showError("Failed to load lectures.");
                    }
                }

                setupLecturesEventListeners(programId, subjectId, chapterId, lectures) {
                    // Create lecture form
                    document.getElementById('createLectureForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.createLecture(programId, subjectId, chapterId);
                    });
                    
                    // Cancel button
                    document.getElementById('cancelLecture').addEventListener('click', () => {
                        document.getElementById('createLectureForm').reset();
                    });
                    
                    // Refresh button
                    document.getElementById('refreshLecturesList').addEventListener('click', () => {
                        this.loadLecturesForChapter(programId, subjectId, chapterId);
                    });
                    
                    // Edit and delete buttons
                    document.querySelectorAll('.edit-lecture').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const lectureId = e.currentTarget.dataset.id;
                            const lecture = lectures.find(l => l.id === lectureId);
                            this.editLecture(programId, subjectId, chapterId, lecture);
                        });
                    });
                    
                    document.querySelectorAll('.delete-lecture').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const lectureId = e.currentTarget.dataset.id;
                            if (confirm('Are you sure you want to delete this lecture?')) {
                                this.deleteLecture(programId, subjectId, chapterId, lectureId);
                            }
                        });
                    });
                    
                    // Manage questions buttons
                    document.querySelectorAll('.manage-questions').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const lectureId = e.currentTarget.dataset.id;
                            const lecture = lectures.find(l => l.id === lectureId);
                            
                            // Switch to readiness questions tab
                            document.querySelector('[data-tab="readiness-questions"]').click();
                            
                            // Pre-select this lecture
                            this.currentLectureId = lectureId;
                            this.loadReadinessQuestionsForLecture(programId, subjectId, chapterId, lectureId);
                        });
                    });
                }

                async createLecture(programId, subjectId, chapterId) {
                    try {
                        const lectureTitle = document.getElementById('lectureTitle').value.trim();
                        const lectureOrder = parseInt(document.getElementById('lectureOrder').value);
                        const lectureUrl = document.getElementById('lectureUrl').value.trim();
                        const mentorName = document.getElementById('lectureMentorName').value.trim();
                        const mentorProfile = document.getElementById('lectureMentorProfile').value.trim();
                        
                        // Validation
                        if (!lectureTitle) {
                            this.showValidationError('lectureTitleError', 'Lecture title is required');
                            return;
                        }
                        
                        if (isNaN(lectureOrder)) {
                            this.showValidationError('lectureOrderError', 'Order must be a number');
                            return;
                        }
                        
                        if (!lectureUrl) {
                            this.showValidationError('lectureUrlError', 'Video URL is required');
                            return;
                        }
                        
                        if (!mentorName) {
                            this.showValidationError('lectureMentorNameError', 'Mentor name is required');
                            return;
                        }
                        
                        // Create lecture
                        const lectureData = {
                            lectureTitle: lectureTitle,
                            lectureOrder: lectureOrder,
                            lectureUrl: lectureUrl,
                            mentorName: mentorName,
                            mentorProfile: mentorProfile || null
                        };
                        
                        await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .doc(chapterId)
                            .collection('lectures')
                            .add(lectureData);
                        
                        this.showAlert('Lecture created successfully!', 'success');
                        document.getElementById('createLectureForm').reset();
                        this.loadLecturesForChapter(programId, subjectId, chapterId);
                        
                    } catch (error) {
                        console.error("Error creating lecture:", error);
                        this.showError("Failed to create lecture.");
                    }
                }

                loadReadinessQuestionsTab() {
                    // Load programs for dropdown
                    this.loadProgramsDropdown('questionProgramSelect');
                    
                    // Setup event listeners for question management
                    this.setupQuestionManagementEventListeners();
                }

                setupQuestionManagementEventListeners() {
                    // Program selection
                    document.getElementById('questionProgramSelect').addEventListener('change', async (e) => {
                        const programId = e.target.value;
                        if (programId) {
                            await this.loadSubjectsDropdown('questionSubjectSelect', programId);
                            document.getElementById('questionSubjectSelect').disabled = false;
                        } else {
                            document.getElementById('questionSubjectSelect').disabled = true;
                            document.getElementById('questionChapterSelect').disabled = true;
                            document.getElementById('questionLectureSelect').disabled = true;
                            document.getElementById('questionManagementSection').style.display = 'none';
                        }
                    });
                    
                    // Subject selection
                    document.getElementById('questionSubjectSelect').addEventListener('change', async (e) => {
                        const subjectId = e.target.value;
                        if (subjectId) {
                            await this.loadChaptersDropdown('questionChapterSelect', 
                                document.getElementById('questionProgramSelect').value, 
                                subjectId);
                            document.getElementById('questionChapterSelect').disabled = false;
                        } else {
                            document.getElementById('questionChapterSelect').disabled = true;
                            document.getElementById('questionLectureSelect').disabled = true;
                            document.getElementById('questionManagementSection').style.display = 'none';
                        }
                    });
                    
                    // Chapter selection
                    document.getElementById('questionChapterSelect').addEventListener('change', async (e) => {
                        const chapterId = e.target.value;
                        if (chapterId) {
                            await this.loadLecturesDropdown('questionLectureSelect',
                                document.getElementById('questionProgramSelect').value,
                                document.getElementById('questionSubjectSelect').value,
                                chapterId);
                            document.getElementById('questionLectureSelect').disabled = false;
                        } else {
                            document.getElementById('questionLectureSelect').disabled = true;
                            document.getElementById('questionManagementSection').style.display = 'none';
                        }
                    });
                    
                    // Lecture selection
                    document.getElementById('questionLectureSelect').addEventListener('change', async (e) => {
                        const lectureId = e.target.value;
                        if (lectureId) {
                            this.currentLectureId = lectureId;
                            await this.loadReadinessQuestionsForLecture(
                                document.getElementById('questionProgramSelect').value,
                                document.getElementById('questionSubjectSelect').value,
                                document.getElementById('questionChapterSelect').value,
                                lectureId
                            );
                        } else {
                            document.getElementById('questionManagementSection').style.display = 'none';
                        }
                    });
                    
                    // Add question button
                    document.getElementById('addQuestionBtn').addEventListener('click', () => {
                        if (this.currentLectureId) {
                            this.openQuestionEditor();
                        } else {
                            this.showError("Please select a lecture first.");
                        }
                    });
                }

                async loadLecturesDropdown(dropdownId, programId, subjectId, chapterId) {
                    try {
                        const lecturesSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .doc(chapterId)
                            .collection('lectures')
                            .get();
                        
                        const dropdown = document.getElementById(dropdownId);
                        dropdown.innerHTML = '<option value="">Select a lecture</option>';
                        
                        lecturesSnapshot.forEach(doc => {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = doc.data().lectureTitle || `Lecture ${doc.id}`;
                            dropdown.appendChild(option);
                        });
                        
                    } catch (error) {
                        console.error("Error loading lectures dropdown:", error);
                    }
                }

                async loadReadinessQuestionsForLecture(programId, subjectId, chapterId, lectureId) {
                    try {
                        document.getElementById('selectedLectureName').textContent = 'Loading...';
                        document.getElementById('questionsLoading').style.display = 'block';
                        document.getElementById('questionsList').style.display = 'none';
                        document.getElementById('questionManagementSection').style.display = 'block';
                        
                        // Load lecture name
                        const lectureDoc = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .doc(chapterId)
                            .collection('lectures')
                            .doc(lectureId)
                            .get();
                        document.getElementById('selectedLectureName').textContent = lectureDoc.data().lectureTitle || `Lecture ${lectureId}`;
                        
                        // Load readiness questions
                        const lectureData = lectureDoc.data();
                        const questions = lectureData.readinessQuestion || {};
                        
                        // Convert to array for easier display
                        const questionsArray = Object.entries(questions).map(([questionId, questionData]) => ({
                            questionId,
                            ...questionData
                        }));
                        
                        // Sort by order
                        questionsArray.sort((a, b) => (a.order || 0) - (b.order || 0));
                        
                        // Update questions list
                        const questionsList = document.getElementById('questionsList');
                        questionsList.innerHTML = '';
                        
                        if (questionsArray.length === 0) {
                            questionsList.innerHTML = `
                                <div class="empty-state">
                                    <i class="fas fa-question-circle"></i>
                                    <h3>No Readiness Questions</h3>
                                    <p>Click "Add Question" to create readiness questions for this lecture.</p>
                                </div>
                            `;
                        } else {
                            questionsArray.forEach((question, index) => {
                                const questionCard = document.createElement('div');
                                questionCard.className = 'card';
                                questionCard.style.marginBottom = '1rem';
                                questionCard.innerHTML = `
                                    <div class="card-body">
                                        <div style="display: flex; justify-content: space-between; align-items: start;">
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; color: #1f2937; margin-bottom: 0.5rem;">
                                                    Q${index + 1}: ${question.question || 'No question text'}
                                                </div>
                                                <div style="font-size: 0.875rem; color: #6b7280;">
                                                    Order: ${question.order || 0} | 
                                                    Options: ${question.options?.length || 0} | 
                                                    Correct: ${question.correctIndex || 0}
                                                </div>
                                            </div>
                                            <div>
                                                <button class="btn btn-sm btn-outline edit-question-btn" data-question-id="${question.questionId}" data-question-index="${index}">
                                                    <i class="fas fa-edit"></i> Edit
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                                questionsList.appendChild(questionCard);
                            });
                        }
                        
                        // Show questions list
                        document.getElementById('questionsLoading').style.display = 'none';
                        document.getElementById('questionsList').style.display = 'block';
                        
                        // Setup edit buttons
                        document.querySelectorAll('.edit-question-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const questionId = e.currentTarget.dataset.questionId;
                                const questionIndex = e.currentTarget.dataset.questionIndex;
                                this.openQuestionEditor(questionId, questionIndex);
                            });
                        });
                        
                    } catch (error) {
                        console.error("Error loading readiness questions:", error);
                        this.showError("Failed to load readiness questions.");
                    }
                }

                openQuestionEditor(questionId = null, questionIndex = null) {
                    const modal = document.getElementById('questionEditorModal');
                    const form = document.getElementById('questionEditorForm');
                    const optionsContainer = document.getElementById('questionOptionsContainer');
                    
                    // Reset form
                    form.reset();
                    optionsContainer.innerHTML = '';
                    
                    if (questionId) {
                        // Edit existing question
                        document.getElementById('questionModalTitle').textContent = 'Edit Question';
                        document.getElementById('editQuestionId').value = questionId;
                        document.getElementById('editQuestionIndex').value = questionIndex;
                        
                        // Load question data (would need to fetch from Firestore)
                        // For now, we'll just show the modal
                    } else {
                        // Create new question
                        document.getElementById('questionModalTitle').textContent = 'Add New Question';
                        document.getElementById('editQuestionId').value = '';
                        document.getElementById('editQuestionIndex').value = '';
                        
                        // Add two default options
                        this.addQuestionOption('', false);
                        this.addQuestionOption('', false);
                    }
                    
                    // Show modal
                    modal.style.display = 'flex';
                    
                    // Setup modal event listeners
                    this.setupQuestionEditorEventListeners();
                }

                setupQuestionEditorEventListeners() {
                    const modal = document.getElementById('questionEditorModal');
                    const form = document.getElementById('questionEditorForm');
                    
                    // Close modal buttons
                    document.getElementById('closeQuestionModal').addEventListener('click', () => {
                        modal.style.display = 'none';
                    });
                    
                    document.getElementById('cancelQuestionEdit').addEventListener('click', () => {
                        modal.style.display = 'none';
                    });
                    
                    // Add option button
                    document.getElementById('addOptionBtn').addEventListener('click', () => {
                        this.addQuestionOption('', false);
                    });
                    
                    // Save question button
                    document.getElementById('saveQuestionBtn').addEventListener('click', async () => {
                        await this.saveQuestion();
                    });
                    
                    // Delete question button
                    document.getElementById('deleteQuestionBtn').addEventListener('click', async () => {
                        if (confirm('Are you sure you want to delete this question?')) {
                            await this.deleteQuestion();
                        }
                    });
                }

                addQuestionOption(text = '', isCorrect = false) {
                    const optionsContainer = document.getElementById('questionOptionsContainer');
                    const optionIndex = optionsContainer.children.length;
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = `option-item ${isCorrect ? 'correct-option' : ''}`;
                    optionDiv.innerHTML = `
                        <input type="text" class="form-input option-input" placeholder="Option text" value="${text}">
                        <button type="button" class="option-remove" title="Remove option">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    
                    optionsContainer.appendChild(optionDiv);
                    
                    // Setup remove button
                    optionDiv.querySelector('.option-remove').addEventListener('click', () => {
                        optionDiv.remove();
                    });
                    
                    // Setup option selection (mark as correct)
                    const optionInput = optionDiv.querySelector('.option-input');
                    optionInput.addEventListener('click', () => {
                        // For simplicity, we'll use a double-click to mark as correct
                        // In a full implementation, you might want a radio button or checkbox
                    });
                }

                async saveQuestion() {
                    try {
                        const questionId = document.getElementById('editQuestionId').value;
                        const questionText = document.getElementById('editQuestionText').value.trim();
                        const questionOrder = parseInt(document.getElementById('editQuestionOrder').value);
                        const questionUrl = document.getElementById('editQuestionUrl').value.trim();
                        const correctIndex = parseInt(document.getElementById('editCorrectIndex').value);
                        const explanation = document.getElementById('editExplanation').value.trim();
                        const explanationUrl = document.getElementById('editExplanationUrl').value.trim();
                        const explanationVideoUrls = document.getElementById('editExplanationVideoUrls').value
                            .split('\n')
                            .map(url => url.trim())
                            .filter(url => url);
                        
                        // Get options
                        const options = [];
                        document.querySelectorAll('.option-input').forEach(input => {
                            const text = input.value.trim();
                            if (text) {
                                options.push(text);
                            }
                        });
                        
                        // Validation
                        if (!questionText) {
                            this.showValidationError('editQuestionTextError', 'Question text is required');
                            return;
                        }
                        
                        if (isNaN(questionOrder)) {
                            this.showValidationError('editQuestionOrderError', 'Order must be a number');
                            return;
                        }
                        
                        if (options.length < 2) {
                            this.showValidationError('editQuestionOptionsError', 'At least 2 options are required');
                            return;
                        }
                        
                        if (isNaN(correctIndex) || correctIndex < 0 || correctIndex >= options.length) {
                            this.showValidationError('editCorrectIndexError', `Correct index must be between 0 and ${options.length - 1}`);
                            return;
                        }
                        
                        // Prepare question data
                        const questionData = {
                            question: questionText,
                            order: questionOrder,
                            correctIndex: correctIndex,
                            options: options
                        };
                        
                        // Add optional fields if provided
                        if (questionUrl) questionData.questionUrl = questionUrl;
                        if (explanation) questionData.explanation = explanation;
                        if (explanationUrl) questionData.explanationUrl = explanationUrl;
                        if (explanationVideoUrls.length > 0) {
                            questionData.explanationVideoUrl = explanationVideoUrls;
                        }
                        
                        // Get current lecture data
                        const programId = document.getElementById('questionProgramSelect').value;
                        const subjectId = document.getElementById('questionSubjectSelect').value;
                        const chapterId = document.getElementById('questionChapterSelect').value;
                        const lectureId = document.getElementById('questionLectureSelect').value;
                        
                        const lectureRef = this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .doc(chapterId)
                            .collection('lectures')
                            .doc(lectureId);
                        
                        const lectureDoc = await lectureRef.get();
                        const lectureData = lectureDoc.data() || {};
                        
                        // Update readiness questions
                        const questions = lectureData.readinessQuestion || {};
                        
                        if (questionId) {
                            // Update existing question
                            questions[questionId] = questionData;
                        } else {
                            // Add new question with generated ID
                            const newQuestionId = `question_${Date.now()}`;
                            questions[newQuestionId] = questionData;
                        }
                        
                        // Update lecture document
                        await lectureRef.update({
                            readinessQuestion: questions
                        });
                        
                        this.showAlert('Question saved successfully!', 'success');
                        document.getElementById('questionEditorModal').style.display = 'none';
                        
                        // Refresh questions list
                        await this.loadReadinessQuestionsForLecture(programId, subjectId, chapterId, lectureId);
                        
                    } catch (error) {
                        console.error("Error saving question:", error);
                        this.showError("Failed to save question. Please check your permissions.");
                    }
                }

                async deleteQuestion() {
                    try {
                        const questionId = document.getElementById('editQuestionId').value;
                        
                        if (!questionId) {
                            this.showError("No question selected for deletion.");
                            return;
                        }
                        
                        // Get current lecture data
                        const programId = document.getElementById('questionProgramSelect').value;
                        const subjectId = document.getElementById('questionSubjectSelect').value;
                        const chapterId = document.getElementById('questionChapterSelect').value;
                        const lectureId = document.getElementById('questionLectureSelect').value;
                        
                        const lectureRef = this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('chapters')
                            .doc(chapterId)
                            .collection('lectures')
                            .doc(lectureId);
                        
                        const lectureDoc = await lectureRef.get();
                        const lectureData = lectureDoc.data() || {};
                        
                        // Remove question from readiness questions
                        const questions = lectureData.readinessQuestion || {};
                        delete questions[questionId];
                        
                        // Update lecture document
                        await lectureRef.update({
                            readinessQuestion: questions
                        });
                        
                        this.showAlert('Question deleted successfully!', 'success');
                        document.getElementById('questionEditorModal').style.display = 'none';
                        
                        // Refresh questions list
                        await this.loadReadinessQuestionsForLecture(programId, subjectId, chapterId, lectureId);
                        
                    } catch (error) {
                        console.error("Error deleting question:", error);
                        this.showError("Failed to delete question.");
                    }
                }

                async loadFreeLecturesModule() {
                    try {
                        // Load programs for dropdown
                        await this.loadProgramsDropdown('freeLectureProgramSelect');
                        
                        // Event listener for program selection
                        document.getElementById('freeLectureProgramSelect').addEventListener('change', async (e) => {
                            const programId = e.target.value;
                            if (programId) {
                                this.currentProgramId = programId;
                                await this.loadFreeLecturesForProgram(programId);
                            } else {
                                document.getElementById('freeLectureManagementSection').style.display = 'none';
                            }
                        });
                        
                    } catch (error) {
                        console.error("Error loading free lectures module:", error);
                        this.showError("Failed to load free lectures module.");
                    }
                }

                async loadFreeLecturesForProgram(programId) {
                    try {
                        document.getElementById('selectedFreeLectureProgramName').textContent = 'Loading...';
                        document.getElementById('freeLecturesLoading').style.display = 'block';
                        document.getElementById('freeLecturesTableContainer').style.display = 'none';
                        document.getElementById('freeLectureManagementSection').style.display = 'block';
                        
                        // Load program name
                        const programDoc = await this.db.collection('programs').doc(programId).get();
                        document.getElementById('selectedFreeLectureProgramName').textContent = programDoc.data().programName || `Program ${programId}`;
                        
                        // Load free lectures
                        const freeLecturesSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('freeLectures')
                            .get();
                        
                        const freeLectures = [];
                        freeLecturesSnapshot.forEach(doc => {
                            freeLectures.push({
                                id: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // Sort by order
                        freeLectures.sort((a, b) => (a.lectureOrder || 0) - (b.lectureOrder || 0));
                        
                        // Update table
                        const tableBody = document.querySelector('#freeLecturesTable tbody');
                        tableBody.innerHTML = '';
                        
                        freeLectures.forEach(lecture => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${lecture.lectureTitle || 'Untitled Lecture'}</td>
                                <td>${lecture.lectureOrder || 0}</td>
                                <td>${lecture.mentorName || 'N/A'}</td>
                                <td>
                                    <span class="status-badge ${lecture.status ? 'status-active' : 'status-inactive'}">
                                        ${lecture.status ? 'Active' : 'Inactive'}
                                    </span>
                                </td>
                                <td>${lecture.updatedAt?.toDate?.().toLocaleDateString() || 'N/A'}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline edit-free-lecture" data-id="${lecture.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline toggle-free-lecture" data-id="${lecture.id}" data-status="${lecture.status}">
                                        <i class="fas ${lecture.status ? 'fa-eye-slash' : 'fa-eye'}"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline delete-free-lecture" data-id="${lecture.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Show table
                        document.getElementById('freeLecturesLoading').style.display = 'none';
                        document.getElementById('freeLecturesTableContainer').style.display = 'block';
                        
                        // Setup event listeners
                        this.setupFreeLecturesEventListeners(programId, freeLectures);
                        
                    } catch (error) {
                        console.error("Error loading free lectures:", error);
                        this.showError("Failed to load free lectures.");
                    }
                }

                setupFreeLecturesEventListeners(programId, freeLectures) {
                    // Create free lecture form
                    document.getElementById('createFreeLectureForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.createFreeLecture(programId);
                    });
                    
                    // Cancel button
                    document.getElementById('cancelFreeLecture').addEventListener('click', () => {
                        document.getElementById('createFreeLectureForm').reset();
                    });
                    
                    // Refresh button
                    document.getElementById('refreshFreeLecturesList').addEventListener('click', () => {
                        this.loadFreeLecturesForProgram(programId);
                    });
                    
                    // Edit, toggle, and delete buttons
                    document.querySelectorAll('.edit-free-lecture').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const lectureId = e.currentTarget.dataset.id;
                            const lecture = freeLectures.find(l => l.id === lectureId);
                            this.editFreeLecture(programId, lecture);
                        });
                    });
                    
                    document.querySelectorAll('.toggle-free-lecture').forEach(btn => {
                        btn.addEventListener('click', async (e) => {
                            const lectureId = e.currentTarget.dataset.id;
                            const currentStatus = e.currentTarget.dataset.status === 'true';
                            await this.toggleFreeLectureStatus(programId, lectureId, !currentStatus);
                        });
                    });
                    
                    document.querySelectorAll('.delete-free-lecture').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const lectureId = e.currentTarget.dataset.id;
                            if (confirm('Are you sure you want to delete this free lecture?')) {
                                this.deleteFreeLecture(programId, lectureId);
                            }
                        });
                    });
                }

                async createFreeLecture(programId) {
                    try {
                        const lectureTitle = document.getElementById('freeLectureTitle').value.trim();
                        const lectureOrder = parseInt(document.getElementById('freeLectureOrder').value);
                        const lectureUrl = document.getElementById('freeLectureUrl').value.trim();
                        const mentorName = document.getElementById('freeLectureMentorName').value.trim();
                        const mentorProfile = document.getElementById('freeLectureMentorProfile').value.trim();
                        const status = document.getElementById('freeLectureStatus').value === 'true';
                        
                        // Validation
                        if (!lectureTitle) {
                            this.showValidationError('freeLectureTitleError', 'Lecture title is required');
                            return;
                        }
                        
                        if (isNaN(lectureOrder)) {
                            this.showValidationError('freeLectureOrderError', 'Order must be a number');
                            return;
                        }
                        
                        if (!lectureUrl) {
                            this.showValidationError('freeLectureUrlError', 'Video URL is required');
                            return;
                        }
                        
                        if (!mentorName) {
                            this.showValidationError('freeLectureMentorNameError', 'Mentor name is required');
                            return;
                        }
                        
                        // Create free lecture
                        const lectureData = {
                            lectureTitle: lectureTitle,
                            lectureOrder: lectureOrder,
                            lectureUrl: lectureUrl,
                            mentorName: mentorName,
                            mentorProfile: mentorProfile || null,
                            status: status,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        await this.db.collection('programs')
                            .doc(programId)
                            .collection('freeLectures')
                            .add(lectureData);
                        
                        this.showAlert('Free lecture created successfully!', 'success');
                        document.getElementById('createFreeLectureForm').reset();
                        this.loadFreeLecturesForProgram(programId);
                        
                    } catch (error) {
                        console.error("Error creating free lecture:", error);
                        this.showError("Failed to create free lecture.");
                    }
                }

                async toggleFreeLectureStatus(programId, lectureId, newStatus) {
                    try {
                        await this.db.collection('programs')
                            .doc(programId)
                            .collection('freeLectures')
                            .doc(lectureId)
                            .update({
                                status: newStatus,
                                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        
                        this.showAlert(`Free lecture ${newStatus ? 'activated' : 'deactivated'}!`, 'success');
                        this.loadFreeLecturesForProgram(programId);
                        
                    } catch (error) {
                        console.error("Error toggling free lecture status:", error);
                        this.showError("Failed to update free lecture status.");
                    }
                }

                async loadPermissionsModule() {
                    try {
                        // Load programs for dropdown
                        await this.loadProgramsDropdown('permissionProgramSelect');
                        
                        // Event listener for program selection
                        document.getElementById('permissionProgramSelect').addEventListener('change', async (e) => {
                            const programId = e.target.value;
                            if (programId) {
                                this.currentProgramId = programId;
                                await this.loadSubjectsDropdown('permissionSubjectSelect', programId);
                                document.getElementById('permissionSubjectSelect').disabled = false;
                            } else {
                                document.getElementById('permissionSubjectSelect').disabled = true;
                                document.getElementById('permissionManagementSection').style.display = 'none';
                            }
                        });
                        
                        // Event listener for subject selection
                        document.getElementById('permissionSubjectSelect').addEventListener('change', async (e) => {
                            const subjectId = e.target.value;
                            if (subjectId) {
                                this.currentSubjectId = subjectId;
                                await this.loadPermissionsForSubject(this.currentProgramId, subjectId);
                            } else {
                                document.getElementById('permissionManagementSection').style.display = 'none';
                            }
                        });
                        
                    } catch (error) {
                        console.error("Error loading permissions module:", error);
                        this.showError("Failed to load permissions module.");
                    }
                }

                async loadPermissionsForSubject(programId, subjectId) {
                    try {
                        document.getElementById('selectedPermissionSubjectName').textContent = 'Loading...';
                        document.getElementById('permissionsLoading').style.display = 'block';
                        document.getElementById('permissionsTableContainer').style.display = 'none';
                        document.getElementById('permissionManagementSection').style.display = 'block';
                        
                        // Load subject name
                        const subjectDoc = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .get();
                        document.getElementById('selectedPermissionSubjectName').textContent = subjectDoc.data().title || `Subject ${subjectId}`;
                        
                        // Load permissions
                        const permissionsSnapshot = await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('permissions')
                            .get();
                        
                        const permissions = [];
                        permissionsSnapshot.forEach(doc => {
                            permissions.push({
                                userId: doc.id,
                                ...doc.data()
                            });
                        });
                        
                        // Update table
                        const tableBody = document.querySelector('#permissionsTable tbody');
                        tableBody.innerHTML = '';
                        
                        permissions.forEach(permission => {
                            const subscribedAt = permission.subscribedAt?.toDate?.();
                            const expiredAt = permission.expiredAt?.toDate?.();
                            const now = new Date();
                            
                            let statusClass = 'status-pending';
                            let statusText = 'Pending';
                            
                            if (permission.approved === true) {
                                if (expiredAt && now > expiredAt) {
                                    statusClass = 'status-expired';
                                    statusText = 'Expired';
                                } else {
                                    statusClass = 'status-active';
                                    statusText = 'Active';
                                }
                            } else if (permission.approved === false) {
                                statusClass = 'status-inactive';
                                statusText = 'Rejected';
                            }
                            
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${permission.userId}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>${subscribedAt ? subscribedAt.toLocaleDateString() : 'N/A'}</td>
                                <td>${expiredAt ? expiredAt.toLocaleDateString() : 'Never'}</td>
                                <td class="table-actions">
                                    <button class="btn btn-sm btn-outline edit-permission" data-user-id="${permission.userId}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline delete-permission" data-user-id="${permission.userId}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        
                        // Show table
                        document.getElementById('permissionsLoading').style.display = 'none';
                        document.getElementById('permissionsTableContainer').style.display = 'block';
                        
                        // Setup event listeners
                        this.setupPermissionsEventListeners(programId, subjectId, permissions);
                        
                    } catch (error) {
                        console.error("Error loading permissions:", error);
                        this.showError("Failed to load permissions.");
                    }
                }

                setupPermissionsEventListeners(programId, subjectId, permissions) {
                    // Create permission form
                    document.getElementById('createPermissionForm').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        await this.createPermission(programId, subjectId);
                    });
                    
                    // Cancel button
                    document.getElementById('cancelPermission').addEventListener('click', () => {
                        document.getElementById('createPermissionForm').reset();
                    });
                    
                    // Refresh button
                    document.getElementById('refreshPermissionsList').addEventListener('click', () => {
                        this.loadPermissionsForSubject(programId, subjectId);
                    });
                    
                    // Edit and delete buttons
                    document.querySelectorAll('.edit-permission').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            const permission = permissions.find(p => p.userId === userId);
                            this.editPermission(programId, subjectId, permission);
                        });
                    });
                    
                    document.querySelectorAll('.delete-permission').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const userId = e.currentTarget.dataset.userId;
                            if (confirm('Are you sure you want to delete this permission?')) {
                                this.deletePermission(programId, subjectId, userId);
                            }
                        });
                    });
                }

                async createPermission(programId, subjectId) {
                    try {
                        const userId = document.getElementById('permissionUserUid').value.trim();
                        const approved = document.getElementById('permissionApproved').value === 'true';
                        const expiryDate = document.getElementById('permissionExpiryDate').value;
                        
                        // Validation
                        if (!userId) {
                            this.showValidationError('permissionUserUidError', 'User UID is required');
                            return;
                        }
                        
                        // Check if user is not the current admin (self-approval prevention)
                        if (userId === this.currentUser.uid) {
                            this.showError("You cannot grant permissions to yourself.");
                            return;
                        }
                        
                        // Prepare permission data
                        const permissionData = {
                            approved: approved,
                            subscribedAt: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        // Add expiry date if provided
                        if (expiryDate) {
                            const expiry = new Date(expiryDate);
                            if (expiry < new Date()) {
                                this.showValidationError('permissionExpiryDateError', 'Expiry date must be in the future');
                                return;
                            }
                            permissionData.expiredAt = firebase.firestore.Timestamp.fromDate(expiry);
                        }
                        
                        // Create permission
                        await this.db.collection('programs')
                            .doc(programId)
                            .collection('subjects')
                            .doc(subjectId)
                            .collection('permissions')
                            .doc(userId)
                            .set(permissionData);
                        
                        this.showAlert('Permission granted successfully!', 'success');
                        document.getElementById('createPermissionForm').reset();
                        this.loadPermissionsForSubject(programId, subjectId);
                        
                    } catch (error) {
                        console.error("Error creating permission:", error);
                        this.showError("Failed to grant permission.");
                    }
                }

                async loadProfileModule() {
                    try {
                        document.getElementById('profileLoading').style.display = 'none';
                        document.getElementById('profileContent').style.display = 'block';
                        
                        // Update profile fields
                        document.getElementById('profileAdminName').value = this.adminData.adminName || 'N/A';
                        document.getElementById('profileInstituteName').value = this.adminData.instituteName || 'N/A';
                        document.getElementById('profileApproved').value = this.adminData.approved ? 'Approved' : 'Pending';
                        document.getElementById('profileJoinedAt').value = this.adminData.joinedAt?.toDate?.().toLocaleDateString() || 'N/A';
                        
                        const expiredAt = this.adminData.expiredAt?.toDate?.();
                        document.getElementById('profileExpiredAt').value = expiredAt ? expiredAt.toLocaleDateString() : 'Never';
                        
                        // Calculate days remaining
                        if (expiredAt) {
                            const now = new Date();
                            const daysRemaining = Math.ceil((expiredAt - now) / (1000 * 60 * 60 * 24));
                            document.getElementById('profileDaysRemaining').value = `${daysRemaining} days`;
                            
                            // Update status message
                            const statusMessage = document.getElementById('profileStatusMessage');
                            if (daysRemaining > 30) {
                                statusMessage.innerHTML = `
                                    <div class="alert alert-success">
                                        <strong>Account Status:</strong> Active
                                        <br>
                                        <small>Your account is active and will expire in ${daysRemaining} days.</small>
                                    </div>
                                `;
                            } else if (daysRemaining > 7) {
                                statusMessage.innerHTML = `
                                    <div class="alert alert-warning">
                                        <strong>Account Status:</strong> Expiring Soon
                                        <br>
                                        <small>Your account will expire in ${daysRemaining} days. Please renew your subscription.</small>
                                    </div>
                                `;
                            } else if (daysRemaining > 0) {
                                statusMessage.innerHTML = `
                                    <div class="alert alert-error">
                                        <strong>Account Status:</strong> Critical
                                        <br>
                                        <small>Your account will expire in ${daysRemaining} days. Renew immediately to avoid service interruption.</small>
                                    </div>
                                `;
                            } else {
                                statusMessage.innerHTML = `
                                    <div class="alert alert-error">
                                        <strong>Account Status:</strong> Expired
                                        <br>
                                        <small>Your account has expired. Please contact support to renew your subscription.</small>
                                    </div>
                                `;
                            }
                        } else {
                            document.getElementById('profileDaysRemaining').value = 'Never';
                            document.getElementById('profileStatusMessage').innerHTML = `
                                <div class="alert alert-info">
                                    <strong>Account Status:</strong> Active
                                    <br>
                                    <small>Your account has no expiry date.</small>
                                </div>
                            `;
                        }
                        
                    } catch (error) {
                        console.error("Error loading profile:", error);
                        this.showError("Failed to load profile.");
                    }
                }

                // ===== UTILITY FUNCTIONS =====

                showAlert(message, type = 'info') {
                    const alertContainer = document.getElementById('alertContainer');
                    
                    const alert = document.createElement('div');
                    alert.className = `alert alert-${type}`;
                    alert.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>${message}</div>
                            <button class="alert-close" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: 1rem;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    alertContainer.appendChild(alert);
                    
                    // Auto-remove after 5 seconds
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 5000);
                    
                    // Close button
                    alert.querySelector('.alert-close').addEventListener('click', () => {
                        alert.remove();
                    });
                }

                showError(message) {
                    this.showAlert(message, 'error');
                }

                showValidationError(elementId, message) {
                    const errorElement = document.getElementById(elementId);
                    errorElement.textContent = message;
                    errorElement.classList.add('show');
                    
                    // Also mark the input as error
                    const inputElement = errorElement.previousElementSibling;
                    if (inputElement && inputElement.classList.contains('form-input')) {
                        inputElement.classList.add('error');
                    }
                }

                clearValidationErrors() {
                    document.querySelectorAll('.validation-error').forEach(el => {
                        el.classList.remove('show');
                        el.textContent = '';
                    });
                    
                    document.querySelectorAll('.form-input.error').forEach(el => {
                        el.classList.remove('error');
                    });
                }
            }

            // Initialize the admin panel when the page loads
            window.addEventListener('load', () => {
                new AdminPanelApp();
            });
        </script>
    </body>
</html>
