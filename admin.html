<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimum-scale=1.0">
    <title>ConceptBlitz - Admin Panel</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts (Anton for brand and Inter for admin UI) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Anton&family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

    <style>
        /* CRITICAL: Ensure HTML and BODY are full height */
        html {
            height: 100%;
        }

        /* Use Inter font family for admin panel */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            
            /* White background */
            background-color: #ffffff;
            color: #000000;
            
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        /* App wrapper */
        #app-wrapper {
            height: 100vh;
            width: 100%;
            overflow: hidden;
            background: #f8fafc;
        }
        
        /* Style for the ConceptBlitz logo font */
        .conceptblitz-logo {
            font-family: 'Anton', sans-serif;
            font-weight: 400;
            font-style: normal;
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }
        
        /* Brand font colors - White and Orange */
        .concept-text {
            color: #000000;
        }
        
        .blitz-text {
            color: #F97316; /* Orange */
        }
        
        /* Loading Spinner */
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(59, 130, 246, 0.2);
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        /* ===== ADMIN LAYOUT ===== */
        .admin-layout {
            display: flex;
            height: 100vh;
            width: 100%;
        }
        
        /* Sidebar */
        .admin-sidebar {
            width: 280px;
            background: #1e293b;
            color: white;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            border-right: 1px solid #334155;
        }
        
        .admin-sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid #334155;
        }
        
        .admin-sidebar-nav {
            padding: 20px 0;
            flex: 1;
            overflow-y: auto;
        }
        
        .admin-sidebar-footer {
            padding: 20px;
            border-top: 1px solid #334155;
            background: rgba(0, 0, 0, 0.1);
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
        }
        
        .nav-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: white;
            border-left-color: #3b82f6;
        }
        
        .nav-item i {
            width: 20px;
            text-align: center;
        }
        
        /* Main Content */
        .admin-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .admin-header {
            height: 70px;
            background: white;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            flex-shrink: 0;
        }
        
        .admin-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }
        
        /* ===== DASHBOARD ===== */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* ===== MODULES ===== */
        .module-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 24px;
            overflow: hidden;
        }
        
        .module-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
        }
        
        .module-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .module-content {
            padding: 24px;
        }
        
        /* ===== DATA TABLES ===== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .data-table th {
            background: #f9fafb;
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 1px solid #e5e7eb;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 16px;
            border-bottom: 1px solid #e5e7eb;
            color: #4b5563;
        }
        
        .data-table tr:hover {
            background: #f9fafb;
        }
        
        /* ===== FORMS ===== */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }
        
        .form-error.show {
            display: block;
        }
        
        /* ===== BUTTONS ===== */
        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-icon {
            padding: 8px;
            width: 36px;
            height: 36px;
            justify-content: center;
        }
        
        /* ===== BADGES ===== */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }
        
        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            font-size: 20px;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }
        
        .modal-close:hover {
            background: #f3f4f6;
        }
        
        .modal-body {
            padding: 24px;
        }
        
        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }
        
        /* ===== READINESS QUESTION EDITOR ===== */
        .question-item {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
        }
        
        .option-item.correct {
            border-color: #10b981;
            background: #f0fdf4;
        }
        
        /* ===== RESPONSIVE ===== */
        @media (max-width: 1024px) {
            .admin-sidebar {
                width: 240px;
            }
        }
        
        @media (max-width: 768px) {
            .admin-sidebar {
                display: none;
            }
            
            .dashboard-stats {
                grid-template-columns: 1fr;
            }
            
            .admin-content {
                padding: 16px;
            }
            
            .data-table {
                display: block;
                overflow-x: auto;
            }
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none;
        }
        
        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .gap-4 {
            gap: 16px;
        }
        
        .mb-4 {
            margin-bottom: 16px;
        }
        
        .mb-6 {
            margin-bottom: 24px;
        }
        
        .mt-4 {
            margin-top: 16px;
        }
        
        .mt-6 {
            margin-top: 24px;
        }
        
        .text-sm {
            font-size: 14px;
        }
        
        .text-lg {
            font-size: 18px;
        }
        
        .text-xl {
            font-size: 24px;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .text-gray-600 {
            color: #4b5563;
        }
        
        .text-gray-700 {
            color: #374151;
        }
        
        .text-red-600 {
            color: #dc2626;
        }
        
        .text-green-600 {
            color: #059669;
        }
        
        .bg-red-50 {
            background: #fef2f2;
        }
        
        .bg-green-50 {
            background: #f0fdf4;
        }
        
        .border-red-200 {
            border-color: #fecaca;
        }
        
        .border-green-200 {
            border-color: #bbf7d0;
        }
    </style>
</head>

<body class="h-full">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="mt-4 text-gray-600">Loading Admin Panel...</div>
    </div>

    <!-- Admin Layout (hidden until auth validated) -->
    <div id="admin-layout" class="admin-layout hidden">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="admin-sidebar-header">
                <div class="conceptblitz-logo text-2xl">
                    <span class="concept-text">CONCEPT</span><span class="blitz-text">BLITZ</span>
                </div>
                <div class="text-sm text-gray-300 mt-2">Admin Panel</div>
            </div>
            
            <div class="admin-sidebar-nav">
                <div class="nav-item active" data-module="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                
                <div class="nav-item" data-module="programs">
                    <i class="fas fa-layer-group"></i>
                    <span>Programs</span>
                </div>
                
                <div class="nav-item" data-module="subjects">
                    <i class="fas fa-book"></i>
                    <span>Subjects</span>
                </div>
                
                <div class="nav-item" data-module="chapters">
                    <i class="fas fa-folder"></i>
                    <span>Chapters</span>
                </div>
                
                <div class="nav-item" data-module="lectures">
                    <i class="fas fa-video"></i>
                    <span>Lectures</span>
                </div>
                
                <div class="nav-item" data-module="questions">
                    <i class="fas fa-question-circle"></i>
                    <span>Readiness Questions</span>
                </div>
                
                <div class="nav-item" data-module="free-lectures">
                    <i class="fas fa-play-circle"></i>
                    <span>Free Lectures</span>
                </div>
                
                <div class="nav-item" data-module="permissions">
                    <i class="fas fa-user-check"></i>
                    <span>Permissions</span>
                </div>
            </div>
            
            <div class="admin-sidebar-footer">
                <div id="admin-info" class="text-sm">
                    <div class="font-semibold text-white" id="admin-name">Loading...</div>
                    <div class="text-gray-300 mt-1" id="institute-name"></div>
                    <div class="text-xs text-gray-400 mt-2" id="subscription-status"></div>
                </div>
                <button id="logout-btn" class="btn btn-danger btn-sm w-full mt-4">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="admin-main">
            <!-- Header -->
            <div class="admin-header">
                <div id="breadcrumb" class="text-gray-700">
                    <span class="font-semibold">Dashboard</span>
                </div>
                
                <div class="flex items-center gap-4">
                    <div class="text-sm text-gray-600">
                        <span id="current-admin">Loading...</span>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex-center text-blue-600 font-semibold">
                        A
                    </div>
                </div>
            </div>
            
            <!-- Content Area -->
            <div class="admin-content">
                <div id="module-content">
                    <!-- Modules will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Admin Login</div>
                <button id="auth-close" class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="auth-email" class="form-input" placeholder="admin@institute.com">
                    <div id="email-error" class="form-error"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="auth-password" class="form-input" placeholder="••••••••">
                    <div id="password-error" class="form-error"></div>
                </div>
                
                <div class="form-group mb-6">
                    <label class="form-label">Institute ID (Optional)</label>
                    <input type="text" id="auth-institute" class="form-input" placeholder="Your institute identifier">
                    <div id="institute-error" class="form-error"></div>
                </div>
                
                <button id="auth-submit" class="btn btn-primary w-full">
                    <i class="fas fa-sign-in-alt"></i>
                    Sign In
                </button>
            </div>
        </div>
    </div>

    <!-- Unauthorized Message -->
    <div id="unauthorized-message" class="hidden flex-center h-screen">
        <div class="text-center">
            <div class="text-red-600 text-6xl mb-4">
                <i class="fas fa-ban"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-800 mb-2">Access Denied</h1>
            <p class="text-gray-600 mb-6">You are not authorized to access the admin panel.</p>
            <button id="back-to-home" class="btn btn-primary">
                <i class="fas fa-home"></i>
                Return to Home
            </button>
        </div>
    </div>

    <script>
        // ====================================================
        // FIREBASE CONFIGURATION
        // ====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBJ_G5o4otg7riemfJDMOcPoHoIVH7emsc",
            authDomain: "geobazarr.firebaseapp.com",
            databaseURL: "https://geobazarr-default-rtdb.firebaseio.com",
            projectId: "geobazarr",
            storageBucket: "geobazarr.firebasestorage.app",
            messagingSenderId: "679949247383",
            appId: "1:679949247383:web:036d4f32038422ebb89ad2"
        };

        // ====================================================
        // ADMIN PANEL APPLICATION
        // ====================================================
        class AdminPanel {
            constructor() {
                this.app = null;
                this.db = null;
                this.auth = null;
                this.currentAdmin = null;
                this.adminData = null;
                this.currentModule = 'dashboard';
                this.selectedProgram = null;
                this.selectedSubject = null;
                this.selectedChapter = null;
                
                this.initializeFirebase();
                this.bindEvents();
                this.checkAuth();
            }
            
            initializeFirebase() {
                try {
                    this.app = firebase.initializeApp(firebaseConfig);
                    this.db = firebase.firestore();
                    this.auth = firebase.auth();
                    console.log("Firebase initialized");
                } catch (error) {
                    console.error("Firebase initialization error:", error);
                    this.showError("Failed to initialize Firebase");
                }
            }
            
            bindEvents() {
                // Navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const module = item.dataset.module;
                        this.switchModule(module);
                    });
                });
                
                // Auth modal
                document.getElementById('auth-close').addEventListener('click', () => {
                    this.hideAuthModal();
                });
                
                document.getElementById('auth-submit').addEventListener('click', () => {
                    this.signIn();
                });
                
                // Enter key in auth form
                document.getElementById('auth-password').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.signIn();
                    }
                });
                
                // Logout
                document.getElementById('logout-btn').addEventListener('click', () => {
                    this.signOut();
                });
                
                // Back to home
                document.getElementById('back-to-home').addEventListener('click', () => {
                    window.location.href = '/';
                });
                
                // Module-specific events will be bound dynamically
            }
            
            async checkAuth() {
                try {
                    await this.waitForAuth();
                    
                    const user = this.auth.currentUser;
                    if (user) {
                        await this.validateAdmin(user.uid);
                    } else {
                        this.showAuthModal();
                    }
                } catch (error) {
                    console.error("Auth check error:", error);
                    this.showAuthModal();
                }
            }
            
            waitForAuth() {
                return new Promise((resolve) => {
                    const unsubscribe = this.auth.onAuthStateChanged((user) => {
                        unsubscribe();
                        resolve(user);
                    });
                });
            }
            
            async validateAdmin(uid) {
                try {
                    console.log("Validating admin:", uid);
                    
                    // Step 1: Check if admin document exists
                    const adminDoc = await this.db.collection('admins').doc(uid).get();
                    
                    if (!adminDoc.exists) {
                        console.log("Admin document does not exist");
                        this.showUnauthorized();
                        return;
                    }
                    
                    const adminData = adminDoc.data();
                    console.log("Admin data:", adminData);
                    
                    // Step 2: Validate approval and expiry
                    const now = new Date();
                    const expiredAt = adminData.expiredAt?.toDate();
                    
                    if (!adminData.approved || !expiredAt || expiredAt <= now) {
                        console.log("Admin not approved or expired");
                        this.showUnauthorized();
                        return;
                    }
                    
                    // Step 3: Admin is valid - proceed
                    this.currentAdmin = uid;
                    this.adminData = adminData;
                    
                    this.hideLoading();
                    this.showAdminPanel();
                    this.loadDashboard();
                    
                    console.log("Admin validation successful");
                    
                } catch (error) {
                    console.error("Admin validation error:", error);
                    this.showUnauthorized();
                }
            }
            
            async signIn() {
                const email = document.getElementById('auth-email').value.trim();
                const password = document.getElementById('auth-password').value.trim();
                
                // Clear errors
                this.clearErrors();
                
                // Validate
                if (!email) {
                    this.showError('email-error', 'Email is required');
                    return;
                }
                
                if (!password) {
                    this.showError('password-error', 'Password is required');
                    return;
                }
                
                const submitBtn = document.getElementById('auth-submit');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing In...';
                
                try {
                    await this.auth.signInWithEmailAndPassword(email, password);
                    this.hideAuthModal();
                    this.showLoading();
                    await this.validateAdmin(this.auth.currentUser.uid);
                } catch (error) {
                    console.error("Sign in error:", error);
                    
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In';
                    
                    switch (error.code) {
                        case 'auth/invalid-email':
                            this.showError('email-error', 'Invalid email address');
                            break;
                        case 'auth/user-disabled':
                            this.showError('email-error', 'Account disabled');
                            break;
                        case 'auth/user-not-found':
                            this.showError('email-error', 'Account not found');
                            break;
                        case 'auth/wrong-password':
                            this.showError('password-error', 'Incorrect password');
                            break;
                        default:
                            this.showError('password-error', 'Failed to sign in');
                    }
                }
            }
            
            async signOut() {
                try {
                    await this.auth.signOut();
                    this.currentAdmin = null;
                    this.adminData = null;
                    this.hideAdminPanel();
                    this.showAuthModal();
                } catch (error) {
                    console.error("Sign out error:", error);
                }
            }
            
            showError(elementId, message) {
                const element = document.getElementById(elementId);
                element.textContent = message;
                element.classList.add('show');
            }
            
            clearErrors() {
                document.querySelectorAll('.form-error').forEach(el => {
                    el.textContent = '';
                    el.classList.remove('show');
                });
            }
            
            showLoading() {
                document.getElementById('loading-overlay').classList.remove('hidden');
            }
            
            hideLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
            
            showAuthModal() {
                this.hideLoading();
                document.getElementById('auth-modal').classList.remove('hidden');
            }
            
            hideAuthModal() {
                document.getElementById('auth-modal').classList.add('hidden');
            }
            
            showAdminPanel() {
                // Update admin info
                document.getElementById('admin-name').textContent = this.adminData.adminName || 'Admin';
                document.getElementById('institute-name').textContent = this.adminData.instituteName || 'Institute';
                document.getElementById('current-admin').textContent = this.adminData.adminName || 'Admin';
                
                // Update subscription status
                const expiredAt = this.adminData.expiredAt?.toDate();
                const now = new Date();
                const daysLeft = Math.ceil((expiredAt - now) / (1000 * 60 * 60 * 24));
                
                let statusText = '';
                let statusClass = '';
                
                if (daysLeft > 30) {
                    statusText = `Active (${daysLeft} days remaining)`;
                    statusClass = 'text-green-600';
                } else if (daysLeft > 0) {
                    statusText = `Expiring soon (${daysLeft} days remaining)`;
                    statusClass = 'text-red-600';
                } else {
                    statusText = 'Expired';
                    statusClass = 'text-red-600';
                }
                
                document.getElementById('subscription-status').textContent = statusText;
                document.getElementById('subscription-status').className = `text-xs ${statusClass}`;
                
                // Show panel
                document.getElementById('admin-layout').classList.remove('hidden');
            }
            
            hideAdminPanel() {
                document.getElementById('admin-layout').classList.add('hidden');
            }
            
            showUnauthorized() {
                this.hideLoading();
                document.getElementById('unauthorized-message').classList.remove('hidden');
            }
            
            // ====================================================
            // MODULE MANAGEMENT
            // ====================================================
            switchModule(module) {
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.module === module) {
                        item.classList.add('active');
                    }
                });
                
                // Update breadcrumb
                const breadcrumb = document.getElementById('breadcrumb');
                const moduleNames = {
                    'dashboard': 'Dashboard',
                    'programs': 'Programs',
                    'subjects': 'Subjects',
                    'chapters': 'Chapters',
                    'lectures': 'Lectures',
                    'questions': 'Readiness Questions',
                    'free-lectures': 'Free Lectures',
                    'permissions': 'Permissions'
                };
                
                breadcrumb.innerHTML = `<span class="font-semibold">${moduleNames[module]}</span>`;
                
                // Load module
                this.currentModule = module;
                this.loadModule(module);
            }
            
            async loadModule(module) {
                const content = document.getElementById('module-content');
                
                switch (module) {
                    case 'dashboard':
                        await this.loadDashboard();
                        break;
                    case 'programs':
                        await this.loadPrograms();
                        break;
                    case 'subjects':
                        await this.loadSubjects();
                        break;
                    case 'chapters':
                        await this.loadChapters();
                        break;
                    case 'lectures':
                        await this.loadLectures();
                        break;
                    case 'questions':
                        await this.loadQuestions();
                        break;
                    case 'free-lectures':
                        await this.loadFreeLectures();
                        break;
                    case 'permissions':
                        await this.loadPermissions();
                        break;
                }
            }
            
            // ====================================================
            // DASHBOARD MODULE
            // ====================================================
            async loadDashboard() {
                const content = `
                    <div class="mb-6">
                        <h1 class="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
                        <p class="text-gray-600">Welcome back, ${this.adminData.adminName}</p>
                    </div>
                    
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="programs-count">0</div>
                            <div class="stat-label">Programs</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-value" id="subjects-count">0</div>
                            <div class="stat-label">Subjects</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-value" id="lectures-count">0</div>
                            <div class="stat-label">Lectures</div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-value" id="users-count">0</div>
                            <div class="stat-label">Active Users</div>
                        </div>
                    </div>
                    
                    <div class="module-section">
                        <div class="module-header">
                            <div class="module-title">
                                <i class="fas fa-info-circle"></i>
                                Admin Information
                            </div>
                        </div>
                        <div class="module-content">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="font-semibold text-gray-700 mb-2">Account Details</h3>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Admin Name:</span>
                                            <span class="font-medium">${this.adminData.adminName || 'Not set'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Institute:</span>
                                            <span class="font-medium">${this.adminData.instituteName || 'Not set'}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Email:</span>
                                            <span class="font-medium">${this.auth.currentUser?.email || 'Not set'}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div>
                                    <h3 class="font-semibold text-gray-700 mb-2">Subscription Status</h3>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Status:</span>
                                            <span class="font-medium ${this.adminData.approved ? 'text-green-600' : 'text-red-600'}">
                                                ${this.adminData.approved ? 'Active' : 'Inactive'}
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Joined:</span>
                                            <span class="font-medium">
                                                ${this.adminData.joinedAt?.toDate().toLocaleDateString() || 'Not set'}
                                            </span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Expires:</span>
                                            <span class="font-medium">
                                                ${this.adminData.expiredAt?.toDate().toLocaleDateString() || 'Not set'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="module-section">
                        <div class="module-header">
                            <div class="module-title">
                                <i class="fas fa-bolt"></i>
                                Quick Actions
                            </div>
                        </div>
                        <div class="module-content">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button class="btn btn-primary" onclick="adminPanel.switchModule('programs')">
                                    <i class="fas fa-plus"></i>
                                    Create New Program
                                </button>
                                
                                <button class="btn btn-secondary" onclick="adminPanel.switchModule('free-lectures')">
                                    <i class="fas fa-play-circle"></i>
                                    Manage Free Lectures
                                </button>
                                
                                <button class="btn btn-success" onclick="adminPanel.switchModule('permissions')">
                                    <i class="fas fa-user-check"></i>
                                    Manage User Permissions
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('module-content').innerHTML = content;
                
                // Load stats
                await this.loadDashboardStats();
            }
            
            async loadDashboardStats() {
                try {
                    // Count programs owned by this admin
                    const programsSnapshot = await this.db.collection('programs')
                        .where('ownerAdminUid', '==', this.currentAdmin)
                        .get();
                    
                    document.getElementById('programs-count').textContent = programsSnapshot.size;
                    
                    // Count subjects
                    let totalSubjects = 0;
                    for (const program of programsSnapshot.docs) {
                        const subjectsSnapshot = await this.db.collection('programs')
                            .doc(program.id)
                            .collection('subjects')
                            .get();
                        totalSubjects += subjectsSnapshot.size;
                    }
                    
                    document.getElementById('subjects-count').textContent = totalSubjects;
                    
                    // Count lectures (simplified - you might want to count across all programs)
                    document.getElementById('lectures-count').textContent = 'N/A';
                    
                    // Count users with permissions (simplified)
                    document.getElementById('users-count').textContent = 'N/A';
                    
                } catch (error) {
                    console.error("Error loading dashboard stats:", error);
                }
            }
            
            // ====================================================
            // PROGRAM MANAGER MODULE
            // ====================================================
            async loadPrograms() {
                try {
                    const programsSnapshot = await this.db.collection('programs')
                        .where('ownerAdminUid', '==', this.currentAdmin)
                        .orderBy('order')
                        .get();
                    
                    let programsHtml = '';
                    
                    if (programsSnapshot.empty) {
                        programsHtml = `
                            <div class="module-section">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-layer-group"></i>
                                        Programs
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateProgramModal()">
                                        <i class="fas fa-plus"></i>
                                        New Program
                                    </button>
                                </div>
                                <div class="module-content">
                                    <div class="text-center py-12">
                                        <i class="fas fa-layer-group text-4xl text-gray-300 mb-4"></i>
                                        <h3 class="text-lg font-semibold text-gray-600 mb-2">No Programs Yet</h3>
                                        <p class="text-gray-500 mb-4">Create your first program to get started</p>
                                        <button class="btn btn-primary" onclick="adminPanel.showCreateProgramModal()">
                                            <i class="fas fa-plus"></i>
                                            Create First Program
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const programsList = programsSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        programsHtml = `
                            <div class="module-section">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-layer-group"></i>
                                        Programs (${programsSnapshot.size})
                                    </div>
                                    <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateProgramModal()">
                                        <i class="fas fa-plus"></i>
                                        New Program
                                    </button>
                                </div>
                                <div class="module-content">
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Order</th>
                                                    <th>Program ID</th>
                                                    <th>Created</th>
                                                    <th>Image Count</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${programsList.map(program => `
                                                    <tr>
                                                        <td class="font-mono">${program.order || 0}</td>
                                                        <td class="font-mono">${program.id}</td>
                                                        <td>${program.createdAt?.toDate().toLocaleDateString() || 'N/A'}</td>
                                                        <td>${Array.isArray(program.imageUrl) ? program.imageUrl.length : 0}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-secondary" onclick="adminPanel.selectProgram('${program.id}')">
                                                                <i class="fas fa-edit"></i>
                                                                Manage
                                                            </button>
                                                            <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteProgram('${program.id}')">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('module-content').innerHTML = programsHtml;
                    
                } catch (error) {
                    console.error("Error loading programs:", error);
                    this.showModuleError("Failed to load programs");
                }
            }
            
            showCreateProgramModal() {
                const modalHtml = `
                    <div class="modal-overlay" id="create-program-modal">
                        <div class="modal">
                            <div class="modal-header">
                                <div class="modal-title">Create New Program</div>
                                <button class="modal-close" onclick="adminPanel.closeModal('create-program-modal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Program ID</label>
                                    <input type="text" id="program-id" class="form-input" placeholder="e.g., math-101">
                                    <div id="program-id-error" class="form-error"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Display Order</label>
                                    <input type="number" id="program-order" class="form-input" value="0" min="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Banner Images (URLs, one per line)</label>
                                    <textarea id="program-images" class="form-input form-textarea" placeholder="https://example.com/image1.jpg"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Profile Image URL</label>
                                    <input type="text" id="program-profile" class="form-input" placeholder="https://example.com/profile.jpg">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="adminPanel.closeModal('create-program-modal')">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" onclick="adminPanel.createProgram()">
                                    <i class="fas fa-plus"></i>
                                    Create Program
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            async createProgram() {
                const programId = document.getElementById('program-id').value.trim();
                const order = parseInt(document.getElementById('program-order').value) || 0;
                const imagesText = document.getElementById('program-images').value.trim();
                const profileImage = document.getElementById('program-profile').value.trim();
                
                // Clear errors
                document.getElementById('program-id-error').classList.remove('show');
                
                // Validate
                if (!programId) {
                    this.showModalError('program-id-error', 'Program ID is required');
                    return;
                }
                
                if (!/^[a-zA-Z0-9-_]+$/.test(programId)) {
                    this.showModalError('program-id-error', 'Program ID can only contain letters, numbers, hyphens, and underscores');
                    return;
                }
                
                // Process images
                const imageUrls = imagesText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                try {
                    await this.db.collection('programs').doc(programId).set({
                        ownerAdminUid: this.currentAdmin,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        imageUrl: imageUrls,
                        profileImage: profileImage || '',
                        order: order
                    });
                    
                    this.closeModal('create-program-modal');
                    this.loadPrograms();
                    
                    this.showToast('Program created successfully', 'success');
                    
                } catch (error) {
                    console.error("Error creating program:", error);
                    
                    if (error.code === 'permission-denied') {
                        this.showModalError('program-id-error', 'Permission denied. You cannot create programs.');
                    } else {
                        this.showModalError('program-id-error', 'Failed to create program');
                    }
                }
            }
            
            async deleteProgram(programId) {
                if (!confirm(`Are you sure you want to delete program "${programId}"? This will delete all subjects, chapters, lectures, and permissions under this program.`)) {
                    return;
                }
                
                try {
                    // Note: In production, you should use a Cloud Function to recursively delete
                    // For now, we'll delete the program document (cascading deletes should be handled by security rules)
                    await this.db.collection('programs').doc(programId).delete();
                    
                    this.loadPrograms();
                    this.showToast('Program deleted successfully', 'success');
                    
                } catch (error) {
                    console.error("Error deleting program:", error);
                    this.showToast('Failed to delete program', 'error');
                }
            }
            
            selectProgram(programId) {
                this.selectedProgram = programId;
                this.switchModule('subjects');
            }
            
            // ====================================================
            // SUBJECT MANAGER MODULE
            // ====================================================
            async loadSubjects() {
                if (!this.selectedProgram) {
                    document.getElementById('module-content').innerHTML = `
                        <div class="module-section">
                            <div class="module-content">
                                <div class="text-center py-12">
                                    <i class="fas fa-book text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Select a Program</h3>
                                    <p class="text-gray-500 mb-4">Please select a program to manage its subjects</p>
                                    <button class="btn btn-primary" onclick="adminPanel.switchModule('programs')">
                                        <i class="fas fa-arrow-left"></i>
                                        Back to Programs
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                try {
                    const subjectsSnapshot = await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .orderBy('order')
                        .get();
                    
                    let subjectsHtml = '';
                    
                    if (subjectsSnapshot.empty) {
                        subjectsHtml = `
                            <div class="module-section">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-book"></i>
                                        Subjects for Program: ${this.selectedProgram}
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary btn-sm" onclick="adminPanel.switchModule('programs')">
                                            <i class="fas fa-arrow-left"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateSubjectModal()">
                                            <i class="fas fa-plus"></i>
                                            New Subject
                                        </button>
                                    </div>
                                </div>
                                <div class="module-content">
                                    <div class="text-center py-12">
                                        <i class="fas fa-book text-4xl text-gray-300 mb-4"></i>
                                        <h3 class="text-lg font-semibold text-gray-600 mb-2">No Subjects Yet</h3>
                                        <p class="text-gray-500 mb-4">Create your first subject for this program</p>
                                        <button class="btn btn-primary" onclick="adminPanel.showCreateSubjectModal()">
                                            <i class="fas fa-plus"></i>
                                            Create First Subject
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const subjectsList = subjectsSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        subjectsHtml = `
                            <div class="module-section">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-book"></i>
                                        Subjects for Program: ${this.selectedProgram}
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary btn-sm" onclick="adminPanel.switchModule('programs')">
                                            <i class="fas fa-arrow-left"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateSubjectModal()">
                                            <i class="fas fa-plus"></i>
                                            New Subject
                                        </button>
                                    </div>
                                </div>
                                <div class="module-content">
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Order</th>
                                                    <th>Subject ID</th>
                                                    <th>Title</th>
                                                    <th>Mentor</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${subjectsList.map(subject => `
                                                    <tr>
                                                        <td class="font-mono">${subject.order || 0}</td>
                                                        <td class="font-mono">${subject.id}</td>
                                                        <td>${subject.title || 'Untitled'}</td>
                                                        <td>${subject.mentorName || 'Unknown'}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-secondary" onclick="adminPanel.selectSubject('${subject.id}')">
                                                                <i class="fas fa-edit"></i>
                                                                Manage
                                                            </button>
                                                            <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteSubject('${subject.id}')">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('module-content').innerHTML = subjectsHtml;
                    
                } catch (error) {
                    console.error("Error loading subjects:", error);
                    this.showModuleError("Failed to load subjects");
                }
            }
            
            showCreateSubjectModal() {
                const modalHtml = `
                    <div class="modal-overlay" id="create-subject-modal">
                        <div class="modal">
                            <div class="modal-header">
                                <div class="modal-title">Create New Subject</div>
                                <button class="modal-close" onclick="adminPanel.closeModal('create-subject-modal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Subject ID</label>
                                    <input type="text" id="subject-id" class="form-input" placeholder="e.g., algebra">
                                    <div id="subject-id-error" class="form-error"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Subject Title</label>
                                    <input type="text" id="subject-title" class="form-input" placeholder="e.g., Introduction to Algebra">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Display Order</label>
                                    <input type="number" id="subject-order" class="form-input" value="0" min="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Mentor Name</label>
                                    <input type="text" id="subject-mentor" class="form-input" placeholder="e.g., Prof. John Smith">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Thumbnail URL</label>
                                    <input type="text" id="subject-thumbnail" class="form-input" placeholder="https://example.com/thumbnail.jpg">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="adminPanel.closeModal('create-subject-modal')">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" onclick="adminPanel.createSubject()">
                                    <i class="fas fa-plus"></i>
                                    Create Subject
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            async createSubject() {
                const subjectId = document.getElementById('subject-id').value.trim();
                const title = document.getElementById('subject-title').value.trim();
                const order = parseInt(document.getElementById('subject-order').value) || 0;
                const mentorName = document.getElementById('subject-mentor').value.trim();
                const thumbnailUrl = document.getElementById('subject-thumbnail').value.trim();
                
                // Clear errors
                document.getElementById('subject-id-error').classList.remove('show');
                
                // Validate
                if (!subjectId) {
                    this.showModalError('subject-id-error', 'Subject ID is required');
                    return;
                }
                
                if (!/^[a-zA-Z0-9-_]+$/.test(subjectId)) {
                    this.showModalError('subject-id-error', 'Subject ID can only contain letters, numbers, hyphens, and underscores');
                    return;
                }
                
                try {
                    await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(subjectId)
                        .set({
                            title: title || 'Untitled Subject',
                            order: order,
                            thumbnailUrl: thumbnailUrl || '',
                            mentorName: mentorName || 'Unknown Mentor'
                        });
                    
                    this.closeModal('create-subject-modal');
                    this.loadSubjects();
                    
                    this.showToast('Subject created successfully', 'success');
                    
                } catch (error) {
                    console.error("Error creating subject:", error);
                    
                    if (error.code === 'permission-denied') {
                        this.showModalError('subject-id-error', 'Permission denied. You cannot create subjects in this program.');
                    } else {
                        this.showModalError('subject-id-error', 'Failed to create subject');
                    }
                }
            }
            
            async deleteSubject(subjectId) {
                if (!confirm(`Are you sure you want to delete subject "${subjectId}"? This will delete all chapters, lectures, and permissions under this subject.`)) {
                    return;
                }
                
                try {
                    await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(subjectId)
                        .delete();
                    
                    this.loadSubjects();
                    this.showToast('Subject deleted successfully', 'success');
                    
                } catch (error) {
                    console.error("Error deleting subject:", error);
                    this.showToast('Failed to delete subject', 'error');
                }
            }
            
            selectSubject(subjectId) {
                this.selectedSubject = subjectId;
                this.switchModule('chapters');
            }
            
            // ====================================================
            // CHAPTER MANAGER MODULE
            // ====================================================
            async loadChapters() {
                if (!this.selectedProgram || !this.selectedSubject) {
                    document.getElementById('module-content').innerHTML = `
                        <div class="module-section">
                            <div class="module-content">
                                <div class="text-center py-12">
                                    <i class="fas fa-folder text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Select a Subject</h3>
                                    <p class="text-gray-500 mb-4">Please select a subject to manage its chapters</p>
                                    <button class="btn btn-primary" onclick="adminPanel.switchModule('subjects')">
                                        <i class="fas fa-arrow-left"></i>
                                        Back to Subjects
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                try {
                    const chaptersSnapshot = await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .orderBy('order')
                        .get();
                    
                    let chaptersHtml = '';
                    
                    if (chaptersSnapshot.empty) {
                        chaptersHtml = `
                            <div class="module-section">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-folder"></i>
                                        Chapters for Subject: ${this.selectedSubject}
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary btn-sm" onclick="adminPanel.switchModule('subjects')">
                                            <i class="fas fa-arrow-left"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateChapterModal()">
                                            <i class="fas fa-plus"></i>
                                            New Chapter
                                        </button>
                                    </div>
                                </div>
                                <div class="module-content">
                                    <div class="text-center py-12">
                                        <i class="fas fa-folder text-4xl text-gray-300 mb-4"></i>
                                        <h3 class="text-lg font-semibold text-gray-600 mb-2">No Chapters Yet</h3>
                                        <p class="text-gray-500 mb-4">Create your first chapter for this subject</p>
                                        <button class="btn btn-primary" onclick="adminPanel.showCreateChapterModal()">
                                            <i class="fas fa-plus"></i>
                                            Create First Chapter
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const chaptersList = chaptersSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        chaptersHtml = `
                            <div class="module-section">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-folder"></i>
                                        Chapters for Subject: ${this.selectedSubject}
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary btn-sm" onclick="adminPanel.switchModule('subjects')">
                                            <i class="fas fa-arrow-left"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateChapterModal()">
                                            <i class="fas fa-plus"></i>
                                            New Chapter
                                        </button>
                                    </div>
                                </div>
                                <div class="module-content">
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Order</th>
                                                    <th>Chapter ID</th>
                                                    <th>Title</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${chaptersList.map(chapter => `
                                                    <tr>
                                                        <td class="font-mono">${chapter.order || 0}</td>
                                                        <td class="font-mono">${chapter.id}</td>
                                                        <td>${chapter.title || 'Untitled'}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-secondary" onclick="adminPanel.selectChapter('${chapter.id}')">
                                                                <i class="fas fa-edit"></i>
                                                                Manage
                                                            </button>
                                                            <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteChapter('${chapter.id}')">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('module-content').innerHTML = chaptersHtml;
                    
                } catch (error) {
                    console.error("Error loading chapters:", error);
                    this.showModuleError("Failed to load chapters");
                }
            }
            
            showCreateChapterModal() {
                const modalHtml = `
                    <div class="modal-overlay" id="create-chapter-modal">
                        <div class="modal">
                            <div class="modal-header">
                                <div class="modal-title">Create New Chapter</div>
                                <button class="modal-close" onclick="adminPanel.closeModal('create-chapter-modal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Chapter ID</label>
                                    <input type="text" id="chapter-id" class="form-input" placeholder="e.g., chapter-1">
                                    <div id="chapter-id-error" class="form-error"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Chapter Title</label>
                                    <input type="text" id="chapter-title" class="form-input" placeholder="e.g., Introduction to Concepts">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Display Order</label>
                                    <input type="number" id="chapter-order" class="form-input" value="0" min="0">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="adminPanel.closeModal('create-chapter-modal')">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" onclick="adminPanel.createChapter()">
                                    <i class="fas fa-plus"></i>
                                    Create Chapter
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            async createChapter() {
                const chapterId = document.getElementById('chapter-id').value.trim();
                const title = document.getElementById('chapter-title').value.trim();
                const order = parseInt(document.getElementById('chapter-order').value) || 0;
                
                // Clear errors
                document.getElementById('chapter-id-error').classList.remove('show');
                
                // Validate
                if (!chapterId) {
                    this.showModalError('chapter-id-error', 'Chapter ID is required');
                    return;
                }
                
                if (!/^[a-zA-Z0-9-_]+$/.test(chapterId)) {
                    this.showModalError('chapter-id-error', 'Chapter ID can only contain letters, numbers, hyphens, and underscores');
                    return;
                }
                
                try {
                    await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .doc(chapterId)
                        .set({
                            title: title || 'Untitled Chapter',
                            order: order
                        });
                    
                    this.closeModal('create-chapter-modal');
                    this.loadChapters();
                    
                    this.showToast('Chapter created successfully', 'success');
                    
                } catch (error) {
                    console.error("Error creating chapter:", error);
                    
                    if (error.code === 'permission-denied') {
                        this.showModalError('chapter-id-error', 'Permission denied. You cannot create chapters in this subject.');
                    } else {
                        this.showModalError('chapter-id-error', 'Failed to create chapter');
                    }
                }
            }
            
            async deleteChapter(chapterId) {
                if (!confirm(`Are you sure you want to delete chapter "${chapterId}"? This will delete all lectures under this chapter.`)) {
                    return;
                }
                
                try {
                    await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .doc(chapterId)
                        .delete();
                    
                    this.loadChapters();
                    this.showToast('Chapter deleted successfully', 'success');
                    
                } catch (error) {
                    console.error("Error deleting chapter:", error);
                    this.showToast('Failed to delete chapter', 'error');
                }
            }
            
            selectChapter(chapterId) {
                this.selectedChapter = chapterId;
                this.switchModule('lectures');
            }
            
            // ====================================================
            // LECTURE MANAGER MODULE
            // ====================================================
            async loadLectures() {
                if (!this.selectedProgram || !this.selectedSubject || !this.selectedChapter) {
                    document.getElementById('module-content').innerHTML = `
                        <div class="module-section">
                            <div class="module-content">
                                <div class="text-center py-12">
                                    <i class="fas fa-video text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Select a Chapter</h3>
                                    <p class="text-gray-500 mb-4">Please select a chapter to manage its lectures</p>
                                    <button class="btn btn-primary" onclick="adminPanel.switchModule('chapters')">
                                        <i class="fas fa-arrow-left"></i>
                                        Back to Chapters
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                try {
                    const lecturesSnapshot = await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .doc(this.selectedChapter)
                        .collection('lectures')
                        .orderBy('lectureOrder')
                        .get();
                    
                    let lecturesHtml = '';
                    
                    if (lecturesSnapshot.empty) {
                        lecturesHtml = `
                            <div class="module-section">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-video"></i>
                                        Lectures for Chapter: ${this.selectedChapter}
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary btn-sm" onclick="adminPanel.switchModule('chapters')">
                                            <i class="fas fa-arrow-left"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateLectureModal()">
                                            <i class="fas fa-plus"></i>
                                            New Lecture
                                        </button>
                                    </div>
                                </div>
                                <div class="module-content">
                                    <div class="text-center py-12">
                                        <i class="fas fa-video text-4xl text-gray-300 mb-4"></i>
                                        <h3 class="text-lg font-semibold text-gray-600 mb-2">No Lectures Yet</h3>
                                        <p class="text-gray-500 mb-4">Create your first lecture for this chapter</p>
                                        <button class="btn btn-primary" onclick="adminPanel.showCreateLectureModal()">
                                            <i class="fas fa-plus"></i>
                                            Create First Lecture
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        const lecturesList = lecturesSnapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data()
                        }));
                        
                        lecturesHtml = `
                            <div class="module-section">
                                <div class="module-header">
                                    <div class="module-title">
                                        <i class="fas fa-video"></i>
                                        Lectures for Chapter: ${this.selectedChapter}
                                    </div>
                                    <div class="flex gap-2">
                                        <button class="btn btn-secondary btn-sm" onclick="adminPanel.switchModule('chapters')">
                                            <i class="fas fa-arrow-left"></i>
                                            Back
                                        </button>
                                        <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateLectureModal()">
                                            <i class="fas fa-plus"></i>
                                            New Lecture
                                        </button>
                                    </div>
                                </div>
                                <div class="module-content">
                                    <div class="overflow-x-auto">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Order</th>
                                                    <th>Lecture ID</th>
                                                    <th>Title</th>
                                                    <th>Mentor</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${lecturesList.map(lecture => `
                                                    <tr>
                                                        <td class="font-mono">${lecture.lectureOrder || 0}</td>
                                                        <td class="font-mono">${lecture.id}</td>
                                                        <td>${lecture.lectureTitle || 'Untitled'}</td>
                                                        <td>${lecture.mentorName || 'Unknown'}</td>
                                                        <td>
                                                            <button class="btn btn-sm btn-secondary" onclick="adminPanel.editLecture('${lecture.id}')">
                                                                <i class="fas fa-edit"></i>
                                                                Edit
                                                            </button>
                                                            <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteLecture('${lecture.id}')">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-success" onclick="adminPanel.manageQuestions('${lecture.id}')">
                                                                <i class="fas fa-question-circle"></i>
                                                                Questions
                                                            </button>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    document.getElementById('module-content').innerHTML = lecturesHtml;
                    
                } catch (error) {
                    console.error("Error loading lectures:", error);
                    this.showModuleError("Failed to load lectures");
                }
            }
            
            showCreateLectureModal() {
                const modalHtml = `
                    <div class="modal-overlay" id="create-lecture-modal">
                        <div class="modal">
                            <div class="modal-header">
                                <div class="modal-title">Create New Lecture</div>
                                <button class="modal-close" onclick="adminPanel.closeModal('create-lecture-modal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="form-group">
                                    <label class="form-label">Lecture ID</label>
                                    <input type="text" id="lecture-id" class="form-input" placeholder="e.g., lecture-1">
                                    <div id="lecture-id-error" class="form-error"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Lecture Title</label>
                                    <input type="text" id="lecture-title" class="form-input" placeholder="e.g., Introduction to Topic">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Display Order</label>
                                    <input type="number" id="lecture-order" class="form-input" value="0" min="0">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Video/Content URL</label>
                                    <input type="text" id="lecture-url" class="form-input" placeholder="https://youtube.com/watch?v=... or image URL">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Mentor Name</label>
                                    <input type="text" id="lecture-mentor" class="form-input" placeholder="e.g., Prof. John Smith">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Mentor Profile Image URL</label>
                                    <input type="text" id="lecture-profile" class="form-input" placeholder="https://example.com/profile.jpg">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="adminPanel.closeModal('create-lecture-modal')">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" onclick="adminPanel.createLecture()">
                                    <i class="fas fa-plus"></i>
                                    Create Lecture
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            async createLecture() {
                const lectureId = document.getElementById('lecture-id').value.trim();
                const title = document.getElementById('lecture-title').value.trim();
                const order = parseInt(document.getElementById('lecture-order').value) || 0;
                const url = document.getElementById('lecture-url').value.trim();
                const mentorName = document.getElementById('lecture-mentor').value.trim();
                const mentorProfile = document.getElementById('lecture-profile').value.trim();
                
                // Clear errors
                document.getElementById('lecture-id-error').classList.remove('show');
                
                // Validate
                if (!lectureId) {
                    this.showModalError('lecture-id-error', 'Lecture ID is required');
                    return;
                }
                
                if (!/^[a-zA-Z0-9-_]+$/.test(lectureId)) {
                    this.showModalError('lecture-id-error', 'Lecture ID can only contain letters, numbers, hyphens, and underscores');
                    return;
                }
                
                try {
                    await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .doc(this.selectedChapter)
                        .collection('lectures')
                        .doc(lectureId)
                        .set({
                            lectureOrder: order,
                            lectureTitle: title || 'Untitled Lecture',
                            lectureUrl: url || '',
                            mentorName: mentorName || 'Unknown Mentor',
                            mentorProfile: mentorProfile || '',
                            readinessQuestion: {} // Initialize empty questions map
                        });
                    
                    this.closeModal('create-lecture-modal');
                    this.loadLectures();
                    
                    this.showToast('Lecture created successfully', 'success');
                    
                } catch (error) {
                    console.error("Error creating lecture:", error);
                    
                    if (error.code === 'permission-denied') {
                        this.showModalError('lecture-id-error', 'Permission denied. You cannot create lectures in this chapter.');
                    } else {
                        this.showModalError('lecture-id-error', 'Failed to create lecture');
                    }
                }
            }
            
            async editLecture(lectureId) {
                // Load lecture data and show edit modal
                // Similar to create but with existing data
                // Implementation omitted for brevity
                this.showToast('Edit feature coming soon', 'info');
            }
            
            async deleteLecture(lectureId) {
                if (!confirm(`Are you sure you want to delete lecture "${lectureId}"?`)) {
                    return;
                }
                
                try {
                    await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .doc(this.selectedChapter)
                        .collection('lectures')
                        .doc(lectureId)
                        .delete();
                    
                    this.loadLectures();
                    this.showToast('Lecture deleted successfully', 'success');
                    
                } catch (error) {
                    console.error("Error deleting lecture:", error);
                    this.showToast('Failed to delete lecture', 'error');
                }
            }
            
            manageQuestions(lectureId) {
                // Store selected lecture and switch to questions module
                this.selectedLecture = lectureId;
                this.switchModule('questions');
            }
            
            // ====================================================
            // READINESS QUESTIONS MODULE
            // ====================================================
            async loadQuestions() {
                if (!this.selectedProgram || !this.selectedSubject || !this.selectedChapter || !this.selectedLecture) {
                    document.getElementById('module-content').innerHTML = `
                        <div class="module-section">
                            <div class="module-content">
                                <div class="text-center py-12">
                                    <i class="fas fa-question-circle text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Select a Lecture</h3>
                                    <p class="text-gray-500 mb-4">Please select a lecture to manage its readiness questions</p>
                                    <button class="btn btn-primary" onclick="adminPanel.switchModule('lectures')">
                                        <i class="fas fa-arrow-left"></i>
                                        Back to Lectures
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                try {
                    const lectureDoc = await this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .doc(this.selectedChapter)
                        .collection('lectures')
                        .doc(this.selectedLecture)
                        .get();
                    
                    const lectureData = lectureDoc.data();
                    const questions = lectureData?.readinessQuestion || {};
                    
                    let questionsHtml = `
                        <div class="module-section">
                            <div class="module-header">
                                <div class="module-title">
                                    <i class="fas fa-question-circle"></i>
                                    Readiness Questions for Lecture: ${this.selectedLecture}
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-secondary btn-sm" onclick="adminPanel.switchModule('lectures')">
                                        <i class="fas fa-arrow-left"></i>
                                        Back
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateQuestionModal()">
                                        <i class="fas fa-plus"></i>
                                        New Question
                                    </button>
                                </div>
                            </div>
                            <div class="module-content">
                    `;
                    
                    if (Object.keys(questions).length === 0) {
                        questionsHtml += `
                            <div class="text-center py-12">
                                <i class="fas fa-question-circle text-4xl text-gray-300 mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-600 mb-2">No Questions Yet</h3>
                                <p class="text-gray-500 mb-4">Add readiness questions to test student understanding</p>
                                <button class="btn btn-primary" onclick="adminPanel.showCreateQuestionModal()">
                                    <i class="fas fa-plus"></i>
                                    Add First Question
                                </button>
                            </div>
                        `;
                    } else {
                        // Convert questions object to array for display
                        const questionsArray = Object.entries(questions).map(([id, data]) => ({
                            id,
                            ...data
                        }));
                        
                        // Sort by order
                        questionsArray.sort((a, b) => (a.order || 0) - (b.order || 0));
                        
                        questionsHtml += `
                            <div class="space-y-4">
                                ${questionsArray.map((q, index) => `
                                    <div class="question-item">
                                        <div class="question-header">
                                            <div>
                                                <h4 class="font-semibold text-gray-800">Question #${index + 1} (Order: ${q.order || 0})</h4>
                                                <p class="text-sm text-gray-600 mt-1">${q.question}</p>
                                            </div>
                                            <div class="flex gap-2">
                                                <button class="btn btn-sm btn-secondary" onclick="adminPanel.editQuestion('${q.id}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="adminPanel.deleteQuestion('${q.id}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <strong>Options:</strong>
                                            <div class="mt-2 space-y-2">
                                                ${(q.options || []).map((option, optIndex) => `
                                                    <div class="option-item ${optIndex === q.correctIndex ? 'correct' : ''}">
                                                        <span class="font-medium">${String.fromCharCode(65 + optIndex)}.</span>
                                                        <span>${option}</span>
                                                        ${optIndex === q.correctIndex ? 
                                                            '<span class="badge badge-success ml-auto">Correct</span>' : ''}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                        
                                        ${q.explanation ? `
                                            <div class="mb-3">
                                                <strong>Explanation:</strong>
                                                <p class="text-sm text-gray-700 mt-1">${q.explanation}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${q.questionUrl ? `
                                            <div class="mb-3">
                                                <strong>Question URL:</strong>
                                                <p class="text-sm text-blue-600 mt-1 break-all">${q.questionUrl}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${q.explanationUrl ? `
                                            <div class="mb-3">
                                                <strong>Explanation URL:</strong>
                                                <p class="text-sm text-blue-600 mt-1 break-all">${q.explanationUrl}</p>
                                            </div>
                                        ` : ''}
                                        
                                        ${q.explanationVideoUrl && q.explanationVideoUrl.length > 0 ? `
                                            <div class="mb-3">
                                                <strong>Explanation Videos (${q.explanationVideoUrl.length}):</strong>
                                                <p class="text-sm text-gray-700 mt-1">Available</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    questionsHtml += `
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('module-content').innerHTML = questionsHtml;
                    
                } catch (error) {
                    console.error("Error loading questions:", error);
                    this.showModuleError("Failed to load questions");
                }
            }
            
            showCreateQuestionModal() {
                const modalHtml = `
                    <div class="modal-overlay" id="create-question-modal">
                        <div class="modal" style="max-width: 800px;">
                            <div class="modal-header">
                                <div class="modal-title">Create Readiness Question</div>
                                <button class="modal-close" onclick="adminPanel.closeModal('create-question-modal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="modal-body">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="form-group">
                                        <label class="form-label">Question ID</label>
                                        <input type="text" id="question-id" class="form-input" placeholder="e.g., q1">
                                        <div id="question-id-error" class="form-error"></div>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label class="form-label">Display Order</label>
                                        <input type="number" id="question-order" class="form-input" value="0" min="0">
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Question Text</label>
                                    <textarea id="question-text" class="form-input form-textarea" placeholder="Enter the question..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Question URL (Optional)</label>
                                    <input type="text" id="question-url" class="form-input" placeholder="https://example.com/question-image.jpg">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Options (One per line, mark correct with *)</label>
                                    <textarea id="question-options" class="form-input form-textarea" placeholder="Option 1\n*Option 2 (correct)\nOption 3" rows="4"></textarea>
                                    <div id="options-error" class="form-error"></div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Explanation (Optional)</label>
                                    <textarea id="question-explanation" class="form-input form-textarea" placeholder="Explanation for the correct answer..."></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Explanation URL (Optional)</label>
                                    <input type="text" id="explanation-url" class="form-input" placeholder="https://example.com/explanation.pdf">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Explanation Video URLs (Optional, one per line)</label>
                                    <textarea id="explanation-videos" class="form-input form-textarea" placeholder="https://youtube.com/watch?v=..."></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" onclick="adminPanel.closeModal('create-question-modal')">
                                    Cancel
                                </button>
                                <button class="btn btn-primary" onclick="adminPanel.createQuestion()">
                                    <i class="fas fa-plus"></i>
                                    Create Question
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
            }
            
            async createQuestion() {
                const questionId = document.getElementById('question-id').value.trim();
                const order = parseInt(document.getElementById('question-order').value) || 0;
                const questionText = document.getElementById('question-text').value.trim();
                const questionUrl = document.getElementById('question-url').value.trim();
                const optionsText = document.getElementById('question-options').value.trim();
                const explanation = document.getElementById('question-explanation').value.trim();
                const explanationUrl = document.getElementById('explanation-url').value.trim();
                const videosText = document.getElementById('explanation-videos').value.trim();
                
                // Clear errors
                document.getElementById('question-id-error').classList.remove('show');
                document.getElementById('options-error').classList.remove('show');
                
                // Validate
                if (!questionId) {
                    this.showModalError('question-id-error', 'Question ID is required');
                    return;
                }
                
                if (!questionText) {
                    this.showModalError('question-id-error', 'Question text is required');
                    return;
                }
                
                if (!optionsText) {
                    this.showModalError('options-error', 'Options are required');
                    return;
                }
                
                // Parse options
                const options = optionsText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                // Find correct option (marked with *)
                let correctIndex = -1;
                const cleanedOptions = options.map((option, index) => {
                    if (option.startsWith('*')) {
                        if (correctIndex === -1) {
                            correctIndex = index;
                        }
                        return option.substring(1).trim();
                    }
                    return option;
                });
                
                if (correctIndex === -1) {
                    this.showModalError('options-error', 'Please mark the correct option with *');
                    return;
                }
                
                if (cleanedOptions.length < 2) {
                    this.showModalError('options-error', 'At least 2 options are required');
                    return;
                }
                
                // Parse video URLs
                const explanationVideoUrl = videosText.split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0);
                
                try {
                    // Get current lecture document
                    const lectureRef = this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .doc(this.selectedChapter)
                        .collection('lectures')
                        .doc(this.selectedLecture);
                    
                    const lectureDoc = await lectureRef.get();
                    const currentQuestions = lectureDoc.data()?.readinessQuestion || {};
                    
                    // Add new question
                    currentQuestions[questionId] = {
                        question: questionText,
                        order: order,
                        correctIndex: correctIndex,
                        options: cleanedOptions,
                        questionUrl: questionUrl || '',
                        explanation: explanation || '',
                        explanationVideoUrl: explanationVideoUrl,
                        explanationUrl: explanationUrl || ''
                    };
                    
                    // Update lecture document
                    await lectureRef.update({
                        readinessQuestion: currentQuestions
                    });
                    
                    this.closeModal('create-question-modal');
                    this.loadQuestions();
                    
                    this.showToast('Question created successfully', 'success');
                    
                } catch (error) {
                    console.error("Error creating question:", error);
                    
                    if (error.code === 'permission-denied') {
                        this.showModalError('question-id-error', 'Permission denied. You cannot add questions to this lecture.');
                    } else {
                        this.showModalError('question-id-error', 'Failed to create question');
                    }
                }
            }
            
            async editQuestion(questionId) {
                // Load question data and show edit modal
                // Similar to create but with existing data
                // Implementation omitted for brevity
                this.showToast('Edit question feature coming soon', 'info');
            }
            
            async deleteQuestion(questionId) {
                if (!confirm(`Are you sure you want to delete question "${questionId}"?`)) {
                    return;
                }
                
                try {
                    const lectureRef = this.db.collection('programs')
                        .doc(this.selectedProgram)
                        .collection('subjects')
                        .doc(this.selectedSubject)
                        .collection('chapters')
                        .doc(this.selectedChapter)
                        .collection('lectures')
                        .doc(this.selectedLecture);
                    
                    const lectureDoc = await lectureRef.get();
                    const currentQuestions = lectureDoc.data()?.readinessQuestion || {};
                    
                    // Remove the question
                    delete currentQuestions[questionId];
                    
                    // Update lecture document
                    await lectureRef.update({
                        readinessQuestion: currentQuestions
                    });
                    
                    this.loadQuestions();
                    this.showToast('Question deleted successfully', 'success');
                    
                } catch (error) {
                    console.error("Error deleting question:", error);
                    this.showToast('Failed to delete question', 'error');
                }
            }
            
            // ====================================================
            // FREE LECTURES MODULE
            // ====================================================
            async loadFreeLectures() {
                try {
                    const freeLecturesSnapshot = await this.db.collection('programs')
                        .doc(this.selectedProgram || 'placeholder') // We need a program context
                        .collection('freeLectures')
                        .orderBy('lectureOrder')
                        .get();
                    
                    // Implementation similar to other modules
                    // Omitted for brevity
                    
                    document.getElementById('module-content').innerHTML = `
                        <div class="module-section">
                            <div class="module-header">
                                <div class="module-title">
                                    <i class="fas fa-play-circle"></i>
                                    Free Lectures
                                </div>
                                <button class="btn btn-primary btn-sm" onclick="adminPanel.showCreateFreeLectureModal()">
                                    <i class="fas fa-plus"></i>
                                    New Free Lecture
                                </button>
                            </div>
                            <div class="module-content">
                                <div class="text-center py-12">
                                    <i class="fas fa-play-circle text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Select a Program</h3>
                                    <p class="text-gray-500 mb-4">Please select a program from the Programs module to manage free lectures</p>
                                    <button class="btn btn-primary" onclick="adminPanel.switchModule('programs')">
                                        <i class="fas fa-arrow-left"></i>
                                        Go to Programs
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error("Error loading free lectures:", error);
                    this.showModuleError("Failed to load free lectures");
                }
            }
            
            // ====================================================
            // PERMISSIONS MODULE
            // ====================================================
            async loadPermissions() {
                if (!this.selectedProgram) {
                    document.getElementById('module-content').innerHTML = `
                        <div class="module-section">
                            <div class="module-content">
                                <div class="text-center py-12">
                                    <i class="fas fa-user-check text-4xl text-gray-300 mb-4"></i>
                                    <h3 class="text-lg font-semibold text-gray-600 mb-2">Select a Program</h3>
                                    <p class="text-gray-500 mb-4">Please select a program to manage user permissions</p>
                                    <button class="btn btn-primary" onclick="adminPanel.switchModule('programs')">
                                        <i class="fas fa-arrow-left"></i>
                                        Go to Programs
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Implementation for permissions management
                // Omitted for brevity
                
                document.getElementById('module-content').innerHTML = `
                    <div class="module-section">
                        <div class="module-header">
                            <div class="module-title">
                                <i class="fas fa-user-check"></i>
                                User Permissions for Program: ${this.selectedProgram}
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-secondary btn-sm" onclick="adminPanel.switchModule('programs')">
                                    <i class="fas fa-arrow-left"></i>
                                    Back
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="adminPanel.showGrantPermissionModal()">
                                    <i class="fas fa-user-plus"></i>
                                    Grant Access
                                </button>
                            </div>
                        </div>
                        <div class="module-content">
                            <div class="text-center py-12">
                                <p class="text-gray-500">Permissions management will be available soon</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // ====================================================
            // UTILITY METHODS
            // ====================================================
            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.remove();
                }
            }
            
            showModalError(elementId, message) {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = message;
                    element.classList.add('show');
                }
            }
            
            showModuleError(message) {
                document.getElementById('module-content').innerHTML = `
                    <div class="module-section">
                        <div class="module-content">
                            <div class="text-center py-12">
                                <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                                <h3 class="text-lg font-semibold text-gray-600 mb-2">Error</h3>
                                <p class="text-gray-500 mb-4">${message}</p>
                                <button class="btn btn-primary" onclick="adminPanel.loadModule('${this.currentModule}')">
                                    <i class="fas fa-redo"></i>
                                    Try Again
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            showToast(message, type = 'info') {
                // Create toast element
                const toast = document.createElement('div');
                toast.className = `fixed top-4 right-4 z-50 px-6 py-3 rounded-lg shadow-lg text-white ${
                    type === 'success' ? 'bg-green-500' :
                    type === 'error' ? 'bg-red-500' :
                    'bg-blue-500'
                }`;
                toast.textContent = message;
                
                document.body.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }
        }
        
        // Initialize Admin Panel
        let adminPanel;
        
        window.addEventListener('load', () => {
            adminPanel = new AdminPanel();
            window.adminPanel = adminPanel; // Make it globally accessible for onclick handlers
        });
    </script>
</body>
</html>
